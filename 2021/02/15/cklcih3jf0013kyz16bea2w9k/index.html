<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Admob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯ | Dylan Tseng çš„åšå®¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="ANR,Resources,WebView">
    <meta name="description" content="èƒŒæ™¯Zapee åŸºäº Admob åœ¨å†·å¯åŠ¨æ¥å…¥æ’å±å¹¿å‘Šåå‘ç°ï¼Œåœ¨é™å®š 7s å†…ï¼Œå¹¿å‘Šå±•ç¤ºç‡ä»…æœ‰ 20+%ã€‚ä¸ºäº†è¿›ä¸€æ­¥æå‡å¼€å±å¹¿å‘Šçš„å±•ç¤ºç‡ï¼Œå°† Admob åˆå§‹åŒ–å’ŒåŠ è½½å¼€å±å¹¿å‘Šä»ä¸²è¡Œæ”¹æˆå¹¶è¡Œï¼Œå¹¿å‘Šå±•ç¤ºç‡æå‡åˆ°äº† 30+%ã€‚åœ¨éšåçš„ç‰ˆæœ¬ï¼Œåœ¨éƒ¨åˆ†å°ç±³æ‰‹æœºä¸Šï¼Œå¼€å§‹å‡ºç°æ‰“å¼€ app å¡åœ¨æ¬¢è¿ç•Œé¢çš„æƒ…å†µã€‚ å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼ˆé”™è¯¯ä¿¡æ¯åˆ†æï¼‰é€šè¿‡ adb bugreport {output} å‘½ä»¤å¯¼å‡ºé”™è¯¯è®°å½•ï¼Œæå–">
<meta property="og:type" content="article">
<meta property="og:title" content="Admob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯">
<meta property="og:url" content="https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/index.html">
<meta property="og:site_name" content="Dylan Tseng çš„åšå®¢">
<meta property="og:description" content="èƒŒæ™¯Zapee åŸºäº Admob åœ¨å†·å¯åŠ¨æ¥å…¥æ’å±å¹¿å‘Šåå‘ç°ï¼Œåœ¨é™å®š 7s å†…ï¼Œå¹¿å‘Šå±•ç¤ºç‡ä»…æœ‰ 20+%ã€‚ä¸ºäº†è¿›ä¸€æ­¥æå‡å¼€å±å¹¿å‘Šçš„å±•ç¤ºç‡ï¼Œå°† Admob åˆå§‹åŒ–å’ŒåŠ è½½å¼€å±å¹¿å‘Šä»ä¸²è¡Œæ”¹æˆå¹¶è¡Œï¼Œå¹¿å‘Šå±•ç¤ºç‡æå‡åˆ°äº† 30+%ã€‚åœ¨éšåçš„ç‰ˆæœ¬ï¼Œåœ¨éƒ¨åˆ†å°ç±³æ‰‹æœºä¸Šï¼Œå¼€å§‹å‡ºç°æ‰“å¼€ app å¡åœ¨æ¬¢è¿ç•Œé¢çš„æƒ…å†µã€‚ å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼ˆé”™è¯¯ä¿¡æ¯åˆ†æï¼‰é€šè¿‡ adb bugreport {output} å‘½ä»¤å¯¼å‡ºé”™è¯¯è®°å½•ï¼Œæå–">
<meta property="article:published_time" content="2021-02-15T14:47:27.000Z">
<meta property="article:modified_time" content="2021-02-15T14:47:27.000Z">
<meta property="article:author" content="Dylan Tseng">
<meta property="article:tag" content="ANR">
<meta property="article:tag" content="Resources">
<meta property="article:tag" content="WebView">
<meta name="twitter:card" content="summary">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Dylan Tseng</h5>
          <a href="mailto:dylantseng1915@gmail.com" title="dylantseng1915@gmail.com" class="mail">dylantseng1915@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/DylanTseng1915" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Admob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Admob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-02-15T14:47:27.000Z" itemprop="datePublished" class="page-time">
  2021-02-15
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#èƒŒæ™¯"><span class="post-toc-number">1.</span> <span class="post-toc-text">èƒŒæ™¯</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼ˆé”™è¯¯ä¿¡æ¯åˆ†æï¼‰"><span class="post-toc-number">2.</span> <span class="post-toc-text">å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼ˆé”™è¯¯ä¿¡æ¯åˆ†æï¼‰</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#æ€ä¹ˆå‘ç”Ÿçš„ï¼ˆæºç åˆ†æï¼‰"><span class="post-toc-number">3.</span> <span class="post-toc-text">æ€ä¹ˆå‘ç”Ÿçš„ï¼ˆæºç åˆ†æï¼‰</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#åŠ è½½-WebView-å†…æ ¸"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">åŠ è½½ WebView å†…æ ¸</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#åˆå§‹åŒ–-WebView-å†…æ ¸"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">åˆå§‹åŒ– WebView å†…æ ¸</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#è§£å†³åŠæ³•"><span class="post-toc-number">4.</span> <span class="post-toc-text">è§£å†³åŠæ³•</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#æ–°çš„é—®é¢˜ä»¥åŠåˆ†æ"><span class="post-toc-number">5.</span> <span class="post-toc-text">æ–°çš„é—®é¢˜ä»¥åŠåˆ†æ</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Resource-æ„å»ºä»¥åŠåŠ è½½èµ„æºæºç è§£æ"><span class="post-toc-number">6.</span> <span class="post-toc-text">Resource æ„å»ºä»¥åŠåŠ è½½èµ„æºæºç è§£æ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#åŠ è½½èµ„æºè¿‡ç¨‹"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">åŠ è½½èµ„æºè¿‡ç¨‹</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#èµ„æºæ„å»ºè¿‡ç¨‹"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">èµ„æºæ„å»ºè¿‡ç¨‹</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬ä¸€ç§æ–¹å¼"><span class="post-toc-number">7.</span> <span class="post-toc-text">å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬ä¸€ç§æ–¹å¼</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬äºŒç§æ–¹å¼"><span class="post-toc-number">8.</span> <span class="post-toc-text">å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬äºŒç§æ–¹å¼</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#æœ€ç»ˆè§£å†³æ–¹æ¡ˆ"><span class="post-toc-number">9.</span> <span class="post-toc-text">æœ€ç»ˆè§£å†³æ–¹æ¡ˆ</span></a></li></ol>
        </nav>
    </aside>


<article id="post-Admob-å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„-ANR-çš„è§£å†³æ€è·¯"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Admob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-02-15 22:47:27" datetime="2021-02-15T14:47:27.000Z"  itemprop="datePublished">2021-02-15</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="æ–‡ç« æ€»é˜…è¯»é‡" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>Zapee åŸºäº Admob åœ¨å†·å¯åŠ¨æ¥å…¥æ’å±å¹¿å‘Šåå‘ç°ï¼Œåœ¨é™å®š 7s å†…ï¼Œå¹¿å‘Šå±•ç¤ºç‡ä»…æœ‰ 20+%ã€‚ä¸ºäº†è¿›ä¸€æ­¥æå‡å¼€å±å¹¿å‘Šçš„å±•ç¤ºç‡ï¼Œå°† Admob åˆå§‹åŒ–å’ŒåŠ è½½å¼€å±å¹¿å‘Šä»ä¸²è¡Œæ”¹æˆå¹¶è¡Œï¼Œå¹¿å‘Šå±•ç¤ºç‡æå‡åˆ°äº† 30+%ã€‚åœ¨éšåçš„ç‰ˆæœ¬ï¼Œåœ¨éƒ¨åˆ†å°ç±³æ‰‹æœºä¸Šï¼Œå¼€å§‹å‡ºç°æ‰“å¼€ app å¡åœ¨æ¬¢è¿ç•Œé¢çš„æƒ…å†µã€‚</p>
<h1 id="å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼ˆé”™è¯¯ä¿¡æ¯åˆ†æï¼‰"><a href="#å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼ˆé”™è¯¯ä¿¡æ¯åˆ†æï¼‰" class="headerlink" title="å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼ˆé”™è¯¯ä¿¡æ¯åˆ†æï¼‰"></a>å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼ˆé”™è¯¯ä¿¡æ¯åˆ†æï¼‰</h1><p>é€šè¿‡ <code>adb bugreport {output}</code> å‘½ä»¤å¯¼å‡ºé”™è¯¯è®°å½•ï¼Œæå–å‡º ANR æ—¥å¿—ä¸­å…³é”®çš„éƒ¨åˆ†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">&quot;main&quot; prio&#x3D;5 tid&#x3D;1 Blocked</span><br><span class="line">  | group&#x3D;&quot;main&quot; sCount&#x3D;1 dsCount&#x3D;0 flags&#x3D;1 obj&#x3D;0x7a02c410 self&#x3D;0x7398414c00</span><br><span class="line">  | sysTid&#x3D;18522 nice&#x3D;-10 cgrp&#x3D;default sched&#x3D;0&#x2F;0 handle&#x3D;0x741deb8548</span><br><span class="line">  | state&#x3D;S schedstat&#x3D;( 208328084 23627658 543 ) utm&#x3D;16 stm&#x3D;4 core&#x3D;7 HZ&#x3D;100</span><br><span class="line">  | stack&#x3D;0x7fd9c57000-0x7fd9c59000 stackSize&#x3D;8MB</span><br><span class="line">  | held mutexes&#x3D;</span><br><span class="line">  at com.google.android.gms.internal.ads.zzbgm.zza(:2)</span><br><span class="line">  - waiting to lock &lt;0x0901fb7f&gt; (a java.lang.Class&lt;com.google.android.gms.internal.ads.zzbgm&gt;) held by thread 35</span><br><span class="line">  at com.google.android.gms.ads.internal.ClientApi.zzb(:8)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwh.zza(:12)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwn.zzpy(:25)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwn.zzd(:66)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzze.zza(:39)</span><br><span class="line">  at com.google.android.gms.ads.InterstitialAd.loadAd(:9)</span><br><span class="line">  at o.ckh$a.run(:53)</span><br><span class="line">  at o.ckm$a.run(:13)</span><br><span class="line">  at android.os.Handler.handleCallback(Handler.java:873)</span><br><span class="line">  at android.os.Handler.dispatchMessage(Handler.java:99)</span><br><span class="line">  at android.os.Looper.loop(Looper.java:201)</span><br><span class="line">  at android.app.ActivityThread.main(ActivityThread.java:6806)</span><br><span class="line">  at java.lang.reflect.Method.invoke(Native method)</span><br><span class="line">  at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:547)</span><br><span class="line">  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:873)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">&quot;RxIoScheduler-3&quot; daemon prio&#x3D;5 tid&#x3D;35 Waiting</span><br><span class="line">  | group&#x3D;&quot;main&quot; sCount&#x3D;1 dsCount&#x3D;0 flags&#x3D;1 obj&#x3D;0x13d040a8 self&#x3D;0x737bccc800</span><br><span class="line">  | sysTid&#x3D;18593 nice&#x3D;0 cgrp&#x3D;default sched&#x3D;0&#x2F;0 handle&#x3D;0x737a3224f0</span><br><span class="line">  | state&#x3D;S schedstat&#x3D;( 62125674 47960004 273 ) utm&#x3D;4 stm&#x3D;2 core&#x3D;7 HZ&#x3D;100</span><br><span class="line">  | stack&#x3D;0x737a21f000-0x737a221000 stackSize&#x3D;1041KB</span><br><span class="line">  | held mutexes&#x3D;</span><br><span class="line">  at java.lang.Object.wait(Native method)</span><br><span class="line">  - waiting on &lt;0x0979f381&gt; (a java.lang.Object)</span><br><span class="line">  at el.b(chromium-SystemWebViewGoogle.aab-stable-428014103:19)</span><br><span class="line">  at el.g(chromium-SystemWebViewGoogle.aab-stable-428014103:3)</span><br><span class="line">  - locked &lt;0x0979f381&gt; (a java.lang.Object)</span><br><span class="line">  at com.android.webview.chromium.WebViewChromiumFactoryProvider.getStatics(chromium-SystemWebViewGoogle.aab-stable-428014103:4)</span><br><span class="line">  - locked &lt;0x0979f381&gt; (a java.lang.Object)</span><br><span class="line">  at android.webkit.WebSettings.getDefaultUserAgent(WebSettings.java:1266)</span><br><span class="line">  at com.google.android.gms.ads.internal.util.zzbv.call(:15)</span><br><span class="line">  at com.google.android.gms.ads.internal.util.zzbu.zza(:24)</span><br><span class="line">  at com.google.android.gms.ads.internal.util.zzbu.zza(:1)</span><br><span class="line">  at com.google.android.gms.ads.internal.util.zzv.getDefaultUserAgent(:13)</span><br><span class="line">  at com.google.android.gms.ads.internal.util.zzm.zzq(:90)</span><br><span class="line">  - locked &lt;0x07e42c26&gt; (a java.lang.Object)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzayg.zzd(:37)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzbgm.zza(:21)</span><br><span class="line">  - locked &lt;0x0901fb7f&gt; (a java.lang.Class&lt;com.google.android.gms.internal.ads.zzbgm&gt;)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzbgm.zzf(:10)</span><br><span class="line">  at com.google.android.gms.ads.internal.ClientApi.zza(:44)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwj.zza(:12)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwn.zzpy(:25)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwn.zzd(:66)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzzd.zzg(:168)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzzd.zza(:29)</span><br><span class="line">  - locked &lt;0x0cfe9067&gt; (a java.lang.Object)</span><br><span class="line">  at com.google.android.gms.ads.MobileAds.initialize(:10)</span><br><span class="line">  at com.pugc.ads.Ads$a.ËŠ(:202)</span><br><span class="line">  at com.pugc.ads.Ads$a.ËŠ(:123)</span><br><span class="line">  at com.pugc.ads.Ads$a$a.ËŠ(:154)</span><br><span class="line">  at com.pugc.ads.Ads$a$a.call(:151)</span><br><span class="line">  at rx.Observable.unsafeSubscribe(:10256)</span><br><span class="line">  at rx.internal.operators.OperatorSubscribeOn$SubscribeOnSubscriber.call(:100)</span><br><span class="line">  at rx.internal.schedulers.CachedThreadScheduler$EventLoopWorker$1.call(:230)</span><br><span class="line">  at rx.internal.schedulers.ScheduledAction.run(:55)</span><br><span class="line">  at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:458)</span><br><span class="line">  at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">  at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:301)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)</span><br><span class="line">  at java.lang.Thread.run(Thread.java:764)</span><br></pre></td></tr></table></figure>
<p>ä»æ—¥å¿—ä¸­å‘ç°ä¸»çº¿ç¨‹æ­£åœ¨ç­‰å¾… <strong>é”&lt;0x0901fb7f&gt;</strong> ï¼Œè€Œè¿™ä¸ªé”è¢« <strong>tid=35</strong> çš„çº¿ç¨‹æ‰€æŒæœ‰ï¼Œä¸»çº¿ç¨‹æ­£åœ¨åŠ è½½æ’å±å¹¿å‘Šï¼Œè€Œçº¿ç¨‹æ­£åœ¨åˆå§‹åŒ– Admobï¼Œä¹Ÿå°±æ˜¯è¯´åŠ è½½å¹¿å‘Šå’Œå¹¿å‘Šåˆå§‹åŒ–å¹¶è¡Œå¤„ç†ä¼šè§¦å‘æ­»é”ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ­»é”æ˜¯ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æŒæœ‰å¯¹æ–¹éœ€è¦çš„é”é€ æˆçš„ï¼Œä½†æ˜¯ä¸»çº¿ç¨‹é™¤äº†ç­‰å¾… <strong>é”&lt;0x0901fb7f&gt;</strong> ä¹‹å¤–å¹¶ä¸æŒæœ‰å…¶å®ƒé”ï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯å¸¸è§çš„æ­»é”è¡Œä¸ºã€‚</p>
<h1 id="æ€ä¹ˆå‘ç”Ÿçš„ï¼ˆæºç åˆ†æï¼‰"><a href="#æ€ä¹ˆå‘ç”Ÿçš„ï¼ˆæºç åˆ†æï¼‰" class="headerlink" title="æ€ä¹ˆå‘ç”Ÿçš„ï¼ˆæºç åˆ†æï¼‰"></a>æ€ä¹ˆå‘ç”Ÿçš„ï¼ˆæºç åˆ†æï¼‰</h1><p>ä¸ºä»€ä¹ˆ <code>WebSettings.getDefaultUserAgent()</code> ä¼šå¯¼è‡´çº¿ç¨‹å¤„äºæ— æ³•è¢«å”¤é†’çš„çŠ¶æ€ï¼Ÿè¿™ä¸ªç­”æ¡ˆï¼Œè¦ä»æºç é‡Œå¯»æ‰¾ã€‚è°ƒç”¨è¿‡ç¨‹æ¶‰åŠåˆ° WebView å†…æ ¸çš„åŠ è½½ä»¥åŠåˆå§‹åŒ–ï¼Œä» Android 7 å¼€å§‹ï¼ŒWebView ä¸å†æ˜¯å†…ç½®çš„ç¨‹åºï¼Œå˜æˆäº†å•ç‹¬çš„ appï¼ˆä½ ä¼šå¼€å‘è€…é€‰é¡¹å†…çœ‹åˆ°æœ‰ä¸ª WebView é€‰é¡¹ï¼‰ï¼ŒåŠ è½½è¿‡ç¨‹ä¹Ÿå˜å¾—å¤æ‚ï¼Œæˆ‘ä»¬åˆ†ä¸¤éƒ¨åˆ†åˆ†æï¼š1. WebViewFactory.getProvider()ï¼ˆåŠ è½½ WebView å†…æ ¸ï¼‰ï¼›2. WebViewFactoryProvider.getStatics()ï¼ˆåˆå§‹åŒ– WebView å†…æ ¸ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDefaultUserAgent</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> WebViewFactory.getProvider().getStatics().getDefaultUserAgent(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewSettings.getDefaultUserAgent()ğŸ‘†</center>
</p>

<p>ä¸»è¦ç±»è¯´æ˜ï¼š</p>
<blockquote>
<p><strong>WebViewFactory</strong>ï¼šä¸»è¦ç”¨äºåˆ›å»º WebViewFactoryProvider<br><strong>WebViewFactoryProvider</strong>ï¼šWebView æ‰€ç”¨åˆ°çš„ä¸»è¦å¯¹è±¡çš„å®ç°ç±»éƒ½æ˜¯ç”±å®ƒåˆ›å»ºï¼ŒåŒ…æ‹¬ WebView çš„å®ç°<br><strong>WebViewFactoryProvider.Statics</strong>ï¼šå› ä¸º WebView ä»¥åŠå®ç°ç±»éƒ½æ˜¯å®ç°äº† WebViewProvider æ¥å£ï¼ŒWebView ä½¿ç”¨çš„ä¸€äº›é™æ€æ–¹æ³•æ— æ³•æ”¾å…¥æ¥å£ï¼Œæ‰€ä»¥éƒ½æ”¶å½’åˆ°è¿™ä¸ªç±»æ¥å®ç°</p>
</blockquote>
<h2 id="åŠ è½½-WebView-å†…æ ¸"><a href="#åŠ è½½-WebView-å†…æ ¸" class="headerlink" title="åŠ è½½ WebView å†…æ ¸"></a>åŠ è½½ WebView å†…æ ¸</h2><p>ä»¥ä¸‹æ˜¯åŠ è½½å†…æ ¸çš„æ—¶åºå›¾ï¼š</p>
<pre style="background-color: #00000000">
+---------------------+             +-------------+                        +-------------------+ +---------------------------------+
| getUserDefaultAgent |             | getProvider |                        | getProviderClass  | | getWebViewContextAndSetProvider |
+---------------------+             +-------------+                        +-------------------+ +---------------------------------+
           |                               |                                         |                            |
           |                               |                                         |                            |
           |------------------------------>|                                         |                            |
           |                               |                                         |                            |
           |                               |                                         |                            |
           |                               |---------------------------------------->|                            |
           |                               |                                         |                            |
           |                               |                                         |                            |
           |                               |                                         |--------------------------->|
           |                               |                                         |                            |
           |                               |                                         |                    Context |
           |                               |                                         |<---------------------------|
           |                               |                                         |                            |
           |                               |          Class&lt;WebViewFactoryProvider&gt;  |                            |
           |                               |<----------------------------------------|                            |
           |                               |                                         |                            |
           |        WebViewFactoryProvider |                                         |                            |
           |<------------------------------|                                         |                            |
           |                               |                                         |                            |
</pre>

<p>ä¸»è¦æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> WebViewFactoryProvider <span class="title">getProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (sProviderLock) &#123;</span><br><span class="line">        <span class="comment">// For now the main purpose of this function (and the factory abstraction) is to keep</span></span><br><span class="line">        <span class="comment">// us honest and minimize usage of WebView internals when binding the proxy.</span></span><br><span class="line">        <span class="keyword">if</span> (sProviderInstance != <span class="keyword">null</span>) <span class="keyword">return</span> sProviderInstance;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ é™¤äº†ä¸€äº›ä¸å½±å“ç†è§£çš„ä»£ç </span></span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewFactory.getProvider()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;WebViewFactoryProvider&gt; providerClass = getProviderClass();</span><br><span class="line">            Method staticFactory = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åå°„ WebViewChromiumFactoryProvider#create(WebViewDelegate) æ–¹æ³•</span></span><br><span class="line">                staticFactory = providerClass.getMethod(CHROMIUM_WEBVIEW_FACTORY_METHOD, WebViewDelegate<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewFactoryProvider invocation"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ›å»º WebViewFactoryProvider å®ç°ç±»çš„å®ä¾‹</span></span><br><span class="line">                sProviderInstance = (WebViewFactoryProvider) staticFactory.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> WebViewDelegate());</span><br><span class="line">                <span class="keyword">return</span> sProviderInstance;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewFactoryProvider.getProvider()ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Class&lt;WebViewFactoryProvider&gt; <span class="title">getProviderClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Context webViewContext = <span class="keyword">null</span>;</span><br><span class="line">    Application initialApplication = AppGlobals.getInitialApplication();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewFactory.getWebViewContextAndSetProvider()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æˆ–è€… WebView çš„ Context</span></span><br><span class="line">            webViewContext = getWebViewContextAndSetProvider();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewFactory.getChromiumProviderClass()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å°† WebView çš„èµ„æºåŠ å…¥ AssetManagerï¼Œè¿™æ­¥å¾ˆé‡è¦ï¼Œåé¢ä¼šè®²</span></span><br><span class="line">            initialApplication.getAssets().addAssetPathAsSharedLibrary(webViewContext.getApplicationInfo().sourceDir);</span><br><span class="line">            ClassLoader clazzLoader = webViewContext.getClassLoader();</span><br><span class="line"></span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewFactory.loadNativeLibrary()"</span>);</span><br><span class="line">            WebViewLibraryLoader.loadNativeLibrary(clazzLoader, getWebViewLibrary(sPackageInfo.applicationInfo));</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line"></span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"Class.forName()"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è·å¾— WebViewFactoryProvider å®ç°ç±»çš„ Class</span></span><br><span class="line">                <span class="keyword">return</span> getWebViewProviderClass(clazzLoader);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MissingWebViewPackageException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewFacotry.getProviderClass()ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Context <span class="title">getWebViewContextAndSetProvider</span><span class="params">()</span> <span class="keyword">throws</span> MissingWebViewPackageException </span>&#123;</span><br><span class="line">    <span class="comment">// initialApplication æ˜¯ app çš„ application å¯¹è±¡</span></span><br><span class="line">    Application initialApplication = AppGlobals.getInitialApplication();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        WebViewProviderResponse response = <span class="keyword">null</span>;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewUpdateService.waitForAndGetProvider()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ä» IWebViewUpdateService è·å– WebView app çš„ä¸»è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬ packageInfo</span></span><br><span class="line">            response = getUpdateService().waitForAndGetProvider();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (response.status != LIBLOAD_SUCCESS &amp;&amp; response.status != LIBLOAD_FAILED_WAITING_FOR_RELRO) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MissingWebViewPackageException(<span class="string">"Failed to load WebView provider: "</span></span><br><span class="line">                    + getWebViewPreparationErrorReason(response.status));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Register to be killed before fetching package info - so that we will be</span></span><br><span class="line">        <span class="comment">// killed if the package info goes out-of-date.</span></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"ActivityManager.addPackageDependency()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ActivityManager.getService().addPackageDependency(response.packageInfo.packageName);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Fetch package info and verify it against the chosen package</span></span><br><span class="line">        PackageInfo newPackageInfo = <span class="keyword">null</span>;</span><br><span class="line">        PackageManager pm = initialApplication.getPackageManager();</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"PackageManager.getPackageInfo()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            newPackageInfo = pm.getPackageInfo(</span><br><span class="line">                response.packageInfo.packageName,</span><br><span class="line">                PackageManager.GET_SHARED_LIBRARY_FILES</span><br><span class="line">                | PackageManager.MATCH_DEBUG_TRIAGED_MISSING</span><br><span class="line">                <span class="comment">// Make sure that we fetch the current provider even if its not</span></span><br><span class="line">                <span class="comment">// installed for the current user</span></span><br><span class="line">                | PackageManager.MATCH_UNINSTALLED_PACKAGES</span><br><span class="line">                <span class="comment">// Fetch signatures for verification</span></span><br><span class="line">                | PackageManager.GET_SIGNATURES</span><br><span class="line">                <span class="comment">// Get meta-data for meta data flag verification</span></span><br><span class="line">                | PackageManager.GET_META_DATA);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validate the newly fetched package info, throws MissingWebViewPackageException on</span></span><br><span class="line">        <span class="comment">// failure</span></span><br><span class="line">        verifyPackageInfo(response.packageInfo, newPackageInfo);</span><br><span class="line"></span><br><span class="line">        ApplicationInfo ai = newPackageInfo.applicationInfo;</span><br><span class="line">        fixupStubApplicationInfo(ai, pm);</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW,</span><br><span class="line">                <span class="string">"initialApplication.createApplicationContext"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»º WebView çš„ Application Context</span></span><br><span class="line">            Context webViewContext = initialApplication.createApplicationContext(</span><br><span class="line">                    ai,</span><br><span class="line">                    Context.CONTEXT_INCLUDE_CODE | Context.CONTEXT_IGNORE_SECURITY);</span><br><span class="line">            sPackageInfo = newPackageInfo;</span><br><span class="line">            <span class="keyword">return</span> webViewContext;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException | PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MissingWebViewPackageException(<span class="string">"Failed to load WebView provider: "</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewFactory.getWebViewContextAndSetProvider()ğŸ‘†</center>
</p>

<p>åŠ è½½è¿‡ç¨‹ï¼š</p>
<ol>
<li>é€šè¿‡ IWebViewUpdateService è·å¾— WebViewProviderResponse å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«äº† WebView çš„ PackageInfo</li>
<li>ç”¨è¿™ä¸ª PackageInfo é€šè¿‡ PackageManager åˆ›å»º New PackageInfoï¼ˆå¯èƒ½æ—§çš„ä¿¡æ¯ä¸å…¨ï¼‰</li>
<li>å†ç”¨è‡ªèº« app çš„ Application å¯¹è±¡è°ƒç”¨ <code>createApplicationContext(newPackageInfo.applicationInfo)</code> ä¾¿å¯è·å¾— WebView çš„ Application Context</li>
<li>æœ‰äº† WebView çš„ Application Context å¯¹è±¡ä¾¿å¯æ‹¿åˆ°å¾ˆå¤šä¿¡æ¯ï¼Œé¦–å…ˆæ˜¯è°ƒç”¨ <code>AssetManager.addAssetPathAsSharedLibrary(Context)</code> å°† WebView çš„èµ„æºåŠ è½½åˆ°è‡ªèº«çš„ AssetManager å†…</li>
<li>å…¶æ¬¡ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œå¯ä»¥è·å¾—åŸºäº WebView apk ç”Ÿæˆçš„ ClassLoader å¯¹è±¡ï¼Œåå°„å‡º Class<WebViewFacotryProvider>ï¼ŒWebViewFactoryProvider æ˜¯æ¥å£ï¼Œåå°„å‡ºçš„ Class æ˜¯å®ƒçš„å®ç°ç±»ï¼Œæ ¹æ® Android ç‰ˆæœ¬çš„ä¸åŒï¼Œåå°„å‡ºçš„å®ç°ç±»ä¹Ÿä¸ä¸€æ ·<blockquote>
<p>Android 7 -&gt; <code>com.android.webview.chromium.WebViewChromiumFactoryProvider</code><br>Android 8 -&gt; <code>com.android.webview.chromium.WebViewChromiumFactoryProviderForO</code><br>Android 9 -&gt; <code>com.android.webview.chromium.WebViewChromiumFactoryProviderForP</code><br>Android 10 -&gt; <code>com.android.webview.chromium.WebViewChromiumFactoryProviderForQ</code><br>Android 11 -&gt; <code>com.android.webview.chromium.WebViewChromiumFactoryProviderForR</code></p>
</blockquote>
</li>
<li>æœ€åï¼Œåå°„å®ç°ç±»çš„é™æ€æ–¹æ³• <code>create(WebViewDelegate)</code> å¾—åˆ° WebViewFactoryProvider å®ç°ç±»çš„å®ä¾‹</li>
</ol>
<h2 id="åˆå§‹åŒ–-WebView-å†…æ ¸"><a href="#åˆå§‹åŒ–-WebView-å†…æ ¸" class="headerlink" title="åˆå§‹åŒ– WebView å†…æ ¸"></a>åˆå§‹åŒ– WebView å†…æ ¸</h2><p>åˆ†æ <code>WebViewFactoryProvider.getStatics()</code> éœ€è¦å°† Chromium çš„<a href="https://chromium.googlesource.com/chromium/src" target="_blank" rel="noopener">æºç </a>æ‹‰å–ä¸‹æ¥ï¼Œæ•´ä¸ªå·¥ç¨‹å¾ˆå¤§ï¼Œæœ‰ 28Gï¼Œæ­¤æ¬¡åˆ†æåŸºäº <strong>tag: 87.0.4280.141</strong> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Statics <span class="title">getStatics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mAwInit.getLock()) &#123;</span><br><span class="line">        SharedStatics sharedStatics = mAwInit.getStatics();</span><br><span class="line">        <span class="keyword">if</span> (mStaticsAdapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mStaticsAdapter = <span class="keyword">new</span> WebViewChromiumFactoryProvider.Statics() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">findAddress</span><span class="params">(String addr)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> sharedStatics.findAddress(addr);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">getDefaultUserAgent</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> sharedStatics.getDefaultUserAgent(context);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åˆ é™¤ä¸å½±å“ç†è§£çš„ä»£ç </span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mStaticsAdapter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewFactoryProvider.getStatics()ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SharedStatics <span class="title">getStatics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSharedStatics == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Optimization potential: most these methods only need the native library</span></span><br><span class="line">            <span class="comment">// loaded and initialized, not the entire browser process started.</span></span><br><span class="line">            <span class="comment">// See also http://b/7009882</span></span><br><span class="line">            ensureChromiumStartedLocked(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mSharedStatics;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewChromiumAwInit.getStatics()ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This method is not private only because the downstream subclass needs to access it,</span></span><br><span class="line"><span class="comment">// it shouldn't be accessed from anywhere else.</span></span><br><span class="line"><span class="comment">/* package */</span> <span class="function"><span class="keyword">void</span> <span class="title">ensureChromiumStartedLocked</span><span class="params">(<span class="keyword">boolean</span> onMainThread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> Thread.holdsLock(mLock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mStarted) &#123; <span class="comment">// Early-out for the common case.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Looper looper = !onMainThread ? Looper.myLooper() : Looper.getMainLooper();</span><br><span class="line">    ThreadUtils.setUiThread(looper);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ThreadUtils.runningOnUiThread()) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœåœ¨ä¸»çº¿ç¨‹ï¼Œç›´æ¥è°ƒç”¨</span></span><br><span class="line">        startChromiumLocked();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœåœ¨å­çº¿ç¨‹ï¼Œå‘ä¸ªå¼‚æ­¥ Handler æ‰§è¡Œ</span></span><br><span class="line">    AwThreadUtils.postToUiThreadLooper(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                startChromiumLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">while</span> (!mStarted) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;                </span><br><span class="line">            <span class="comment">// ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ° startChromiumLocked æ‰§è¡Œå®Œå”¤é†’çº¿ç¨‹</span></span><br><span class="line">            mLock.wait();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// Keep trying... eventually the UI thread will process the task we sent it.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewChromiumAwInit.ensureChromiumStartedLocked(Boolean)ğŸ‘†</center>
</p>

<p>çœ‹åˆ°ä¸‹é¢è¿™æ®µä»£ç ä½ æ˜¯ä¸æ˜¯æç„¶å¤§æ‚Ÿäº†ï¼ŸğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AwThreadUtils.postToUiThreadLooper(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            startChromiumLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">while</span> (!mStarted) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mLock.wait();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸæ¥æ­»é”çš„åŸå› æ˜¯ <strong>ã€Œçº¿ç¨‹ tid=35ã€</strong> åœ¨æŒæœ‰ <strong>é”&lt;0x0901fb7f&gt;</strong> çš„æƒ…å†µä¸‹ï¼Œå‘ä¸»çº¿ç¨‹å‘é€äº†ä¸ªå¼‚æ­¥æ‰§è¡Œçš„ Handlerï¼Œå¹¶ wait å½“å‰çº¿ç¨‹ç­‰å¾… Handler æ‰§è¡Œå®Œè¢«å”¤é†’ï¼Œç„¶è€Œä¸»çº¿ç¨‹æ­¤æ—¶æ­£åœ¨ç­‰å¾… <strong>é”&lt;0x0901fb7f&gt;</strong> é‡Šæ”¾ï¼Œå‘é€çš„ Handler æ— æ³•è¢«æ‰§è¡Œï¼Œä»è€Œé€ æˆäº†æ­»é”ã€‚</p>
<h1 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h1><p>è§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°† <code>WebSettings.getDefaultUserAgent()</code> åœ¨ <code>MobileAds.initialize()</code> å‰é¢æ‰§è¡Œï¼Œé¿å…åœ¨ <strong>é”&lt;0x0901fb7f&gt;</strong> å†…åŠ è½½ã€åˆå§‹åŒ– WebView å†…æ ¸ï¼ŒåŠ è½½å’Œåˆå§‹åŒ–æ“ä½œåªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚è¯¥æ–¹æ¡ˆåœ¨å‡ å°å‡ ä¹å¿…ç°çš„å°ç±³æ‰‹æœºä¸Šå¾—åˆ°äº†éªŒè¯ã€‚</p>
<h1 id="æ–°çš„é—®é¢˜ä»¥åŠåˆ†æ"><a href="#æ–°çš„é—®é¢˜ä»¥åŠåˆ†æ" class="headerlink" title="æ–°çš„é—®é¢˜ä»¥åŠåˆ†æ"></a>æ–°çš„é—®é¢˜ä»¥åŠåˆ†æ</h1><p>bugfix ä¸Šçº¿åï¼Œæ„å¤–çš„æ–°å¢äº† ResourceNotFoundException å¼‚å¸¸ï¼Œè€Œä¸”æ¦‚ç‡è¿˜ä¸å°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Caused by android.content.res.Resources$NotFoundException: Resource ID #0x20c0021</span><br><span class="line">       at android.content.res.ResourcesImpl.getValue(ResourcesImpl.java:216)</span><br><span class="line">       at android.content.res.Resources.getInteger(Resources.java:1097)</span><br><span class="line">       at org.chromium.ui.base.DeviceFormFactor.isTablet(DeviceFormFactor.java:2)</span><br><span class="line">       at wm0.a(wm0.java:2)</span><br><span class="line">       at GE.run(GE.java:3)</span><br><span class="line">       at org.chromium.content.browser.BrowserStartupControllerImpl.g(BrowserStartupControllerImpl.java:12)</span><br><span class="line">       at org.chromium.content.browser.BrowserStartupControllerImpl.j(BrowserStartupControllerImpl.java:9)</span><br><span class="line">       at Cr.run(Cr.java:9)</span><br><span class="line">       at org.chromium.base.ThreadUtils.i(ThreadUtils.java:2)</span><br><span class="line">       at KY3.j(KY3.java:32)</span><br><span class="line">       at JY3.run(JY3.java:2)</span><br><span class="line">       at android.os.Handler.handleCallback(Handler.java:789)</span><br><span class="line">       at android.os.Handler.dispatchMessage(Handler.java:98)</span><br><span class="line">       at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">       at android.app.ActivityThread.main(ActivityThread.java:6944)</span><br><span class="line">       at java.lang.reflect.Method.invoke(Method.java)</span><br><span class="line">       at com.android.internal.os.Zygote$MethodAndArgsCaller.run(Zygote.java:327)</span><br><span class="line">       at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1374)</span><br></pre></td></tr></table></figure>
<p>è¿˜åŸåçš„é”™è¯¯å †æ ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Caused by android.content.res.Resources$NotFoundException: Resource ID #0x20c0021</span><br><span class="line">       at android.content.res.ResourcesImpl.getValue(ResourcesImpl.java:216)</span><br><span class="line">       at android.content.res.Resources.getInteger(Resources.java:1097)</span><br><span class="line">       at org.chromium.ui.base.DeviceFormFactor.isTablet(DeviceFormFactor.java:2)</span><br><span class="line">       at org.chromium.content.browser.DeviceUtilsImpl.addDeviceSpecificUserAgentSwitch()</span><br><span class="line">       at org.chromium.content.browser.BrowserStartupControllerImpl.prepareToStartBrowserProcess$Runnable.run()</span><br><span class="line">       at org.chromium.content.browser.BrowserStartupControllerImpl.prepareToStartBrowserProcess()</span><br><span class="line">       at org.chromium.content.browser.BrowserStartupControllerImpl.startBrowserProcessesSync()</span><br><span class="line">       at com.android.webview.chromium.AwBrowserProcess.start$Runnable.run()</span><br><span class="line">       at org.chromium.base.ThreadUtils.runOnUiThreadBlocking()</span><br><span class="line">       at com.android.webview.chromium.AwBrowserProcess.start()</span><br><span class="line">       at com.android.webview.chromium.WebViewChromiumAwInit.startChromiumLocked()</span><br><span class="line">       at com.android.webview.chromium.WebViewChromiumAwInit.ensureChromiumStartedLocked$Runnable.run()</span><br><span class="line">       at android.os.Handler.handleCallback(Handler.java:789)</span><br><span class="line">       at android.os.Handler.dispatchMessage(Handler.java:98)</span><br><span class="line">       at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">       at android.app.ActivityThread.main(ActivityThread.java:6944)</span><br><span class="line">       at java.lang.reflect.Method.invoke(Method.java)</span><br><span class="line">       at com.android.internal.os.Zygote$MethodAndArgsCaller.run(Zygote.java:327)</span><br><span class="line">       at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1374)</span><br></pre></td></tr></table></figure>
<p>ä»å †æ ˆé‡Œçœ‹ä¸å‡ºåŸå› ï¼Œè§£å†³é—®é¢˜çš„æ€è·¯å›å½’é—®é¢˜çš„æœ¬è´¨ï¼š<code>Resources.getInteger(int)</code> æ˜¯å¦‚ä½•å¯»æ‰¾èµ„æºçš„ï¼Ÿä¸ºä»€ä¹ˆèµ„æºæ¶ˆå¤±äº†ï¼Ÿ</p>
<h1 id="Resource-æ„å»ºä»¥åŠåŠ è½½èµ„æºæºç è§£æ"><a href="#Resource-æ„å»ºä»¥åŠåŠ è½½èµ„æºæºç è§£æ" class="headerlink" title="Resource æ„å»ºä»¥åŠåŠ è½½èµ„æºæºç è§£æ"></a>Resource æ„å»ºä»¥åŠåŠ è½½èµ„æºæºç è§£æ</h1><h2 id="åŠ è½½èµ„æºè¿‡ç¨‹"><a href="#åŠ è½½èµ„æºè¿‡ç¨‹" class="headerlink" title="åŠ è½½èµ„æºè¿‡ç¨‹"></a>åŠ è½½èµ„æºè¿‡ç¨‹</h2><p><code>Resources.getInteger(int)</code> è°ƒç”¨æ—¶åºå›¾ï¼š</p>
<pre style="background-color: #00000000">
+-------+             +-----------+                              +---------------+                                         +---------------+                  
| User  |             | Resources |                              | ResourcesImpl |                                         | AssetManager  |                  
+-------+             +-----------+                              +---------------+                                         +---------------+                  
    |                       |                                            |                                                         |                          
    | getInteger(int)       |                                            |                                                         |                          
    |---------------------->|                                            |                                                         |                          
    |                       |                                            |                                                         |                          
    |                       | getValue(int, TypedValue, boolean)         |                                                         |                          
    |                       |------------------------------------------->|                                                         |                          
    |                       |                                            |                                                         |                          
    |                       |                                            | getResourceValue(int, int, TypedValue, boolean)         |                          
    |                       |                                            |-------------------------------------------------------->|                          
    |                       |                                            |                                                         |                          
    |                       |                                            |                                                         | nativeGetResourceValue() 
    |                       |                                            |                                                         |------------------------- 
    |                       |                                            |                                                         |                        | 
    |                       |                                            |                                                         |<------------------------ 
    |                       |                                            |                                                         |                          
    |                       |                                            |                                                 boolean |                          
    |                       |                                            |<--------------------------------------------------------|                          
    |                       |                                            |                                                         |                          
    |                       |                                            |                                                         |                          
    |                       |<-------------------------------------------|                                                         |                          
    |                       |                                            |                                                         |                          
    |                   int |                                            |                                                         |                          
    |<----------------------|                                            |                                                         |                          
    |                       |                                            |                                                         |     
</pre>
<p>ä» AssetManager å†…ä¹Ÿçœ‹ä¸é—®é¢˜ï¼Œ<code>nativeGetResourceValue</code> ä¸å¤ªå¯èƒ½å‡ºé”™ï¼Œå‡ºé”™çš„å¯èƒ½æ˜¯è£…è½½èµ„æºçš„åœ°æ–¹ï¼Œé‚£ Application çš„èµ„æºä»¥åŠç¬¬ä¸‰æ–¹çš„èµ„æºæ˜¯å¦‚ä½•è£…è½½çš„å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">getResourceValue</span><span class="params">(@AnyRes <span class="keyword">int</span> resId, <span class="keyword">int</span> densityDpi, @NonNull TypedValue outValue, <span class="keyword">boolean</span> resolveRefs)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(outValue, <span class="string">"outValue"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        ensureValidLocked();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> cookie = nativeGetResourceValue(mObject, resId, (<span class="keyword">short</span>) densityDpi, outValue, resolveRefs);</span><br><span class="line">        <span class="keyword">if</span> (cookie &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Convert the changing configurations flags populated by native code.</span></span><br><span class="line">        outValue.changingConfigurations = ActivityInfo.activityInfoConfigNativeToJava(</span><br><span class="line">                outValue.changingConfigurations);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (outValue.type == TypedValue.TYPE_STRING) &#123;</span><br><span class="line">            outValue.string = mApkAssets[cookie - <span class="number">1</span>].getStringFromPool(outValue.data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">AssetManager.getResourceValue(int, int, TypedValue, boolean)ğŸ‘†</center>
</p>

<h2 id="èµ„æºæ„å»ºè¿‡ç¨‹"><a href="#èµ„æºæ„å»ºè¿‡ç¨‹" class="headerlink" title="èµ„æºæ„å»ºè¿‡ç¨‹"></a>èµ„æºæ„å»ºè¿‡ç¨‹</h2><p>é¦–å…ˆå…ˆææ¸…æ¥š Application çš„èµ„æºæ˜¯å¦‚ä½•æ„å»ºçš„ï¼Œæ„å»ºçš„è¿‡ç¨‹è‚¯å®šæ¶‰åŠåˆ°äº†è£…è½½ã€‚æˆ‘ä»¬çŸ¥é“ Activityã€Applicationã€Service éƒ½ç»§æ‰¿è‡³ ContextWrapperï¼Œè·å– <code>getResources()</code> å®é™…ä¸Šæ˜¯ <strong>mBase</strong> å®ç°ç±»å»å®Œæˆçš„ï¼Œé‚£è¿™ä¸ª <strong>mBase</strong> å®ç°ç±»æ˜¯è°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ <strong>ContextImpl</strong>ï¼Œ<strong>ContextImpl</strong> çš„åˆ›å»ºåœ¨ <code>LoadedApk.makeApplication()</code> å†…ï¼Œä»¥ä¸‹æ˜¯æ•´ä¸ªè¿‡ç¨‹çš„æ—¶åºå›¾ï¼š</p>
<pre style="background-color: #00000000">
+-----------------+          +-----------+              +-------------+ +-------------------+              
| ActivityThread  |          | LoadedApk |              | ContextImpl | | ResourcesManager  |              
+-----------------+          +-----------+              +-------------+ +-------------------+              
         |                         |                           |                  |                        
         | makeApplication()       |                           |                  |                        
         |------------------------>|                           |                  |                        
         |                         |                           |                  |                        
         |                         | createAppContext()        |                  |                        
         |                         |-------------------------->|                  |                        
         |                         |                           |                  |                        
         |                         |            getResources() |                  |                        
         |                         |<--------------------------|                  |                        
         |                         |                           |                  |                        
         |                         | getResources()            |                  |                        
         |                         |--------------------------------------------->|                        
         |                         |                           |                  |                        
         |                         |                           |                  | getOrCreateResources() 
         |                         |                           |                  |----------------------- 
         |                         |                           |                  |                      | 
         |                         |                           |                  |<---------------------- 
         |                         |                           |                  |                        
         |                         |                           |                  | createResourcesImpl()  
         |                         |                           |                  |----------------------  
         |                         |                           |                  |                     |  
         |                         |                           |                  |<---------------------  
         |                         |                           |                  |                        
         |                         |                           |                  | createAssetManager()   
         |                         |                           |                  |---------------------   
         |                         |                           |                  |                    |   
         |                         |                           |                  |<--------------------   
         |                         |                           |                  |                        
         |                         |                           |        Resources |                        
         |                         |<---------------------------------------------|                        
         |                         |                           |                  |                        
         |                         | Resources                 |                  |                        
         |                         |-------------------------->|                  |                        
         |                         |                           |                  |                        
         |                         |               Application |                  |                        
         |<----------------------------------------------------|                  |                        
         |                         |                           |                  |    
</pre>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mApplication;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Application app = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    String appClass = mApplicationInfo.className;</span><br><span class="line">    <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        appClass = <span class="string">"android.app.Application"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (!mPackageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">            initializeJavaContextClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»º Application å¹¶å°† appContext ä½œä¸º mBase</span></span><br><span class="line">        app = mActivityThread.mInstrumentation.newApplication(cl, appClass, appContext);</span><br><span class="line">        appContext.setOuterContext(app);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mActivityThread.mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate application "</span> + appClass</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mActivityThread.mAllApplications.add(app);</span><br><span class="line">    mApplication = app;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">LoadedApk.makeApplication(boolean, Instrumentation)ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createAppContext</span><span class="params">(ActivityThread mainThread, LoadedApk packageInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"packageInfo"</span>);</span><br><span class="line">    ContextImpl context = <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread, packageInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// Resources è¢«èµ‹å€¼çš„åœ°æ–¹</span></span><br><span class="line">    context.setResources(packageInfo.getResources());</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ContextImpl.createAppContext(ActivityThread, LoadedApk)ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resources <span class="title">getResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mResources == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> String[] splitPaths;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            splitPaths = getSplitPaths(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// This should never fail.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"null split not found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mResources = ResourcesManager.getInstance().getResources(<span class="keyword">null</span>, mResDir,</span><br><span class="line">                splitPaths, mOverlayDirs, mApplicationInfo.sharedLibraryFiles,</span><br><span class="line">                Display.DEFAULT_DISPLAY, <span class="keyword">null</span>, getCompatibilityInfo(),</span><br><span class="line">                getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mResources;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">LoadedApk.getResources()ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">Resources <span class="title">getResources</span><span class="params">(@Nullable IBinder activityToken,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String resDir,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String[] splitResDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String[] overlayDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String[] libDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_RESOURCES, <span class="string">"ResourcesManager#getResources"</span>);</span><br><span class="line">        <span class="keyword">final</span> ResourcesKey key = <span class="keyword">new</span> ResourcesKey(</span><br><span class="line">                resDir,</span><br><span class="line">                splitResDirs,</span><br><span class="line">                overlayDirs,</span><br><span class="line">                libDirs,</span><br><span class="line">                displayId,</span><br><span class="line">                overrideConfig != <span class="keyword">null</span> ? <span class="keyword">new</span> Configuration(overrideConfig) : <span class="keyword">null</span>, <span class="comment">// Copy</span></span><br><span class="line">                compatInfo);</span><br><span class="line">        classLoader = classLoader != <span class="keyword">null</span> ? classLoader : ClassLoader.getSystemClassLoader();</span><br><span class="line">        <span class="keyword">return</span> getOrCreateResources(activityToken, key, classLoader);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_RESOURCES);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.getResources(IBinder, String, String[], String[], String[], int, Configuration, CompatibilityInfo, ClassLoader)ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">Resources <span class="title">getOrCreateResources</span><span class="params">(@Nullable IBinder activityToken, @NonNull ResourcesKey key, @NonNull ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (activityToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// åˆ é™¤æ­¤éƒ¨åˆ†ä»£ç </span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Clean up any dead references so they don't pile up.</span></span><br><span class="line">            ArrayUtils.unstableRemoveIf(mResourceReferences, sEmptyReferencePredicate);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Not tied to an Activity, find a shared Resources that has the right ResourcesImpl</span></span><br><span class="line">            ResourcesImpl resourcesImpl = findResourcesImplForKeyLocked(key);</span><br><span class="line">            <span class="keyword">if</span> (resourcesImpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> getOrCreateResourcesLocked(classLoader, resourcesImpl, key.mCompatInfo);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We will create the ResourcesImpl object outside of holding this lock.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Resources ç›¸å½“äºä»£ç†ç±»ï¼ŒResourcesImpl æ‰æ˜¯çœŸæ­£è·å–èµ„æºçš„åœ°æ–¹</span></span><br><span class="line">        ResourcesImpl resourcesImpl = createResourcesImpl(key);</span><br><span class="line">        <span class="keyword">if</span> (resourcesImpl == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add this ResourcesImpl to the cache.</span></span><br><span class="line">        mResourceImpls.put(key, <span class="keyword">new</span> WeakReference&lt;&gt;(resourcesImpl));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Resources resources;</span><br><span class="line">        <span class="keyword">if</span> (activityToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resources = getOrCreateResourcesForActivityLocked(activityToken, classLoader, resourcesImpl, key.mCompatInfo);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resources = getOrCreateResourcesLocked(classLoader, resourcesImpl, key.mCompatInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resources;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.getOrCreateResources(IBinder, ResourcesKey, ClassLoader)</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">createResourcesImpl</span><span class="params">(@NonNull ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> DisplayAdjustments daj = <span class="keyword">new</span> DisplayAdjustments(key.mOverrideConfiguration);</span><br><span class="line">    daj.setCompatibilityInfo(key.mCompatInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º AssetManager</span></span><br><span class="line">    <span class="keyword">final</span> AssetManager assets = createAssetManager(key);</span><br><span class="line">    <span class="keyword">if</span> (assets == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> DisplayMetrics dm = getDisplayMetrics(key.mDisplayId, daj);</span><br><span class="line">    <span class="keyword">final</span> Configuration config = generateConfig(key, dm);</span><br><span class="line">    <span class="keyword">final</span> ResourcesImpl impl = <span class="keyword">new</span> ResourcesImpl(assets, dm, config, daj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> impl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.createResourcesImpl(ResourcesKey)</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="meta">@Nullable</span> <span class="function">AssetManager <span class="title">createAssetManager</span><span class="params">(@NonNull <span class="keyword">final</span> ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> AssetManager.Builder builder = <span class="keyword">new</span> AssetManager.Builder();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// resDir can be null if the 'android' package is creating a new Resources object.</span></span><br><span class="line">    <span class="comment">// This is fine, since each AssetManager automatically loads the 'android' package</span></span><br><span class="line">    <span class="comment">// already.</span></span><br><span class="line">    <span class="keyword">if</span> (key.mResDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            builder.addApkAssets(loadApkAssets(key.mResDir, <span class="keyword">false</span> <span class="comment">/*sharedLib*/</span>, <span class="keyword">false</span> <span class="comment">/*overlay*/</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"failed to add asset path "</span> + key.mResDir);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key.mSplitResDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> String splitResDir : key.mSplitResDirs) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                builder.addApkAssets(loadApkAssets(splitResDir, <span class="keyword">false</span> <span class="comment">/*sharedLib*/</span>, <span class="keyword">false</span> <span class="comment">/*overlay*/</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"failed to add split asset path "</span> + splitResDir);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key.mOverlayDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> String idmapPath : key.mOverlayDirs) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                builder.addApkAssets(loadApkAssets(idmapPath, <span class="keyword">false</span> <span class="comment">/*sharedLib*/</span>, <span class="keyword">true</span> <span class="comment">/*overlay*/</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"failed to add overlay path "</span> + idmapPath);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// continue.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key.mLibDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> String libDir : key.mLibDirs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (libDir.endsWith(<span class="string">".apk"</span>)) &#123;</span><br><span class="line">                <span class="comment">// Avoid opening files we know do not have resources,</span></span><br><span class="line">                <span class="comment">// like code-only .jar files.</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    builder.addApkAssets(loadApkAssets(libDir, <span class="keyword">true</span> <span class="comment">/*sharedLib*/</span>, <span class="keyword">false</span> <span class="comment">/*overlay*/</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">"Asset path '"</span> + libDir +</span><br><span class="line">                            <span class="string">"' does not exist or contains no resources."</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// continue.</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> builder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.createAssetManager(ResourcesKey)</center>
</p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œèµ„æºåˆ†ä¸ºå››ç±»ï¼Œåˆ†åˆ«æ˜¯<code>mResDir</code>ã€<code>mSplitResDir</code>ã€<code>mOverlayDirs</code>å’Œ<code>mLibDirs</code>ï¼Œå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä»¥ Snaptube App ä¸ºä¾‹ï¼Œå››ä¸ªå˜é‡çš„å€¼åˆ†åˆ«ä¸ºï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"mResDir"</span>: <span class="string">"/data/app/com.snaptube.premium-zCPItxCKMtiPLZuponnKNA==/base.apk"</span>,</span><br><span class="line">    <span class="attr">"mLibDirs"</span>: [</span><br><span class="line">        <span class="string">"/system/framework/org.apache.http.legacy.jar"</span>,</span><br><span class="line">        <span class="string">"/data/app/com.google.android.webview-iYfutTXhDoC6vtZnRdoEeA==/base.apk"</span>,</span><br><span class="line">        <span class="string">"/data/app/com.google.android.webview-iYfutTXhDoC6vtZnRdoEeA==/split_config.en.apk"</span>,</span><br><span class="line">        <span class="string">"/data/app/com.google.android.webview-iYfutTXhDoC6vtZnRdoEeA==/split_config.zh.apk"</span>,</span><br><span class="line">        <span class="string">"/data/app/com.google.android.trichromelibrary_432415233-dML7CdjKq4aFdFHYn4kICg==/base.apk"</span>,</span><br><span class="line">        <span class="string">"/product/overlay/NavigationBarMode3Button/NavigationBarMode3ButtonOverlay.apk"</span>,</span><br><span class="line">        <span class="string">"/vendor/overlay/oneplus_shape_circle/OnePlusIconShapeCircleOverlay.apk"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"mOverlayDirs"</span>: [</span><br><span class="line">        <span class="string">"/product/overlay/NavigationBarMode3Button/NatigationBarMode3ButtonOverlay.apk"</span>,</span><br><span class="line">        <span class="string">"/vendor/overlay/oneplus_shape_circle/OnePlusIconShapeCircleOverlay.apk"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"mSplitResDirs"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>mResDir</strong> å¾ˆæ˜¾ç„¶æ˜¯æŒ‡ app çš„èµ„æºè·¯å¾„ï¼Œå³ apk çš„è·¯å¾„<br><strong>mLibDirs</strong> æŒ‡ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“çš„èµ„æºè·¯å¾„ï¼Œä¾‹å¦‚ WebView èµ„æº<br><strong>mOverlayDirs</strong> åº”è¯¥æ˜¯æŒ‡ç³»ç»Ÿæµ®å±‚ç»„ä»¶çš„èµ„æºè·¯å¾„ï¼Œä¾‹å¦‚åº•éƒ¨å¯¼èˆªæ <br><strong>mSplitResDir</strong> ä¸å¤ªç†è§£â€¦</p>
</blockquote>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹ Resources çš„åŠ è½½ä»¥åŠæ„å»ºæœ‰äº†å¤§æ¦‚çš„äº†è§£ï¼Œä»¥åŠçœ‹åˆ°äº† WebView èµ„æºå­˜æ”¾çš„ä½ç½®ï¼Œå›è¿‡å¤´æ¥æ€è€ƒ ResourcesNotFoundException å¼‚å¸¸å‡ºç°çš„åŸå› ï¼Œä¼šä¸ä¼šåœ¨ WebView å†…æ ¸åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œ<strong>mLibDirs</strong> è¿˜æ²¡æœ‰èµ‹å€¼å‘¢ï¼Ÿé‚£ä¸ºä»€ä¹ˆæ˜¯æ¦‚ç‡æ€§å‘ç”Ÿå¼‚å¸¸ï¼Ÿåœ¨åŠ è½½ WebView å†…æ ¸æ—¶ï¼Œä¸æ˜¯å·²ç»è£…è½½å®ƒçš„èµ„æºäº†å—ï¼Ÿ</p>
<h1 id="å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬ä¸€ç§æ–¹å¼"><a href="#å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬ä¸€ç§æ–¹å¼" class="headerlink" title="å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬ä¸€ç§æ–¹å¼"></a>å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬ä¸€ç§æ–¹å¼</h1><p>å¸¦ç€ç–‘æƒ‘ï¼Œé‡æ–°å›åˆ° <code>WebViewFactory.getProviderClass()</code> è£…è½½ WebView èµ„æºçš„åœ°æ–¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initialApplication.getAssets().addAssetPathAsSharedLibrary(webViewContext.getApplicationInfo().sourceDir);</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewFactory.getProviderClass()ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addAssetPathAsSharedLibrary</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addAssetPathInternal(path, <span class="keyword">false</span> <span class="comment">/*overlay*/</span>, <span class="keyword">true</span> <span class="comment">/*appAsLib*/</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">AssetManager.addAssetPathAsSharedLibrary(String)</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">addAssetPathInternal</span><span class="params">(String path, <span class="keyword">boolean</span> overlay, <span class="keyword">boolean</span> appAsLib)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(path, <span class="string">"path"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        ensureOpenLocked();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> count = mApkAssets.length;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// See if we already have it loaded.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mApkAssets[i].getAssetPath().equals(path)) &#123;</span><br><span class="line">                <span class="keyword">return</span> i + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ApkAssets assets;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (overlay) &#123;</span><br><span class="line">                <span class="comment">// TODO(b/70343104): This hardcoded path will be removed once</span></span><br><span class="line">                <span class="comment">// addAssetPathInternal is deleted.</span></span><br><span class="line">                <span class="keyword">final</span> String idmapPath = <span class="string">"/data/resource-cache/"</span></span><br><span class="line">                        + path.substring(<span class="number">1</span>).replace(<span class="string">'/'</span>, <span class="string">'@'</span>)</span><br><span class="line">                        + <span class="string">"@idmap"</span>;</span><br><span class="line">                assets = ApkAssets.loadOverlayFromPath(idmapPath, <span class="keyword">false</span> <span class="comment">/*system*/</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                assets = ApkAssets.loadFromPath(path, <span class="keyword">false</span> <span class="comment">/*system*/</span>, appAsLib);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mApkAssets = Arrays.copyOf(mApkAssets, count + <span class="number">1</span>);</span><br><span class="line">        mApkAssets[count] = assets;</span><br><span class="line">        nativeSetApkAssets(mObject, mApkAssets, <span class="keyword">true</span>);</span><br><span class="line">        invalidateCachesLocked(-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> count + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">AssetManager.addAssetPathInternal(String, boolean, boolean)</center>
</p>
çœ‹åˆ°è¿™ï¼Œæˆ‘æƒŠå¥‡çš„å‘ç°ï¼Œè¿™ç§æ–¹å¼å¹¶æ²¡æœ‰å°† WebView çš„èµ„æºè·¯å¾„æ·»åŠ è¿› mLibDirsï¼Œè€Œä»…ä»…æ˜¯æ·»åŠ è¿› AssetManager çš„ mApkAssets çš„æ•°ç»„å†…ï¼Œé‚£ WebView çš„èµ„æºè·¯å¾„æ˜¯è°åœ¨ä»€ä¹ˆæ—¶å€™æ·»åŠ è¿› mLibDirs çš„å‘¢ï¼Ÿæœ‰æ²¡æœ‰å¯èƒ½ AssetManager è¢«é‡å»ºäº†å¯¼è‡´ mApkAssets ä¸¢å¤±äº† WebView çš„èµ„æºå‘¢ï¼Ÿ

<h1 id="å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬äºŒç§æ–¹å¼"><a href="#å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬äºŒç§æ–¹å¼" class="headerlink" title="å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬äºŒç§æ–¹å¼"></a>å¼•å…¥ç¬¬ä¸‰æ–¹èµ„æºçš„ç¬¬äºŒç§æ–¹å¼</h1><p>äº‹å®ä¸Šï¼Œåœ¨åˆ›å»º WebView å®ä¾‹æ—¶ï¼ŒWebView å†…æ ¸ä¼šç”¨å¦å¤–ä¸€ç§æ–¹å¼æ·»åŠ èµ„æºï¼Œè¿™ç§æ–¹å¼ä¼šå°†èµ„æºè·¯å¾„ä¿å­˜åœ¨ mLibDirsï¼Œä»¥ä¸‹æ˜¯æ•´ä¸ªè¿‡ç¨‹çš„æ—¶åºå›¾ï¼š</p>
<pre style="background-color: #00000000">
+---------+          +---------+                           +-----------------+ +---------------------------------+      +-----------------+              +-----------------+                         +-------------------+                               
| Outside |          | WebView |                           | WebViewFactory  | | WebViewChromiumFactoryProvider  |      | WebViewChromium |              | WebViewDelegate |                         | ResourcesManager  |                               
+---------+          +---------+                           +-----------------+ +---------------------------------+      +-----------------+              +-----------------+                         +-------------------+                               
     |                    |                                         |                           |                                |                                |                                            |                                         
     | new WebView()      |                                         |                           |                                |                                |                                            |                                         
     |------------------->|                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    | ensureProviderCreated()                 |                           |                                |                                |                                            |                                         
     |                    |------------------------                 |                           |                                |                                |                                            |                                         
     |                    |                       |                 |                           |                                |                                |                                            |                                         
     |                    |<-----------------------                 |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    | getProvider()                           |                           |                                |                                |                                            |                                         
     |                    |---------------------------------------->|                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |          WebViewChromiumFactoryProvider |                           |                                |                                |                                            |                                         
     |                    |<----------------------------------------|                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    | createWebView()                         |                           |                                |                                |                                            |                                         
     |                    |-------------------------------------------------------------------->|                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           | new WebViewChromium()          |                                |                                            |                                         
     |                    |                                         |                           |------------------------------->|                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                | addWebViewAssetPath()          |                                            |                                         
     |                    |                                         |                           |                                |------------------------------->|                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                | appendLibAssetForMainAssetPath()           |                                         
     |                    |                                         |                           |                                |                                |------------------------------------------->|                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            | redirectResourcesToNewImplLocked()      
     |                    |                                         |                           |                                |                                |                                            |-----------------------------------      
     |                    |                                         |                           |                                |                                |                                            |                                  |      
     |                    |                                         |                           |                                |                                |                                            |<----------------------------------      
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            | findOrCreateResourcesImplForKeyLocked() 
     |                    |                                         |                           |                                |                                |                                            |---------------------------------------- 
     |                    |                                         |                           |                                |                                |                                            |                                       | 
     |                    |                                         |                           |                                |                                |                                            |<--------------------------------------- 
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            | createResourcesImpl()                   
     |                    |                                         |                           |                                |                                |                                            |----------------------                   
     |                    |                                         |                           |                                |                                |                                            |                     |                   
     |                    |                                         |                           |                                |                                |                                            |<---------------------                   
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            | createAssetManager()                    
     |                    |                                         |                           |                                |                                |                                            |---------------------                    
     |                    |                                         |                           |                                |                                |                                            |                    |                    
     |                    |                                         |                           |                                |                                |                                            |<--------------------                    
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |<-------------------------------------------|                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |<-------------------------------|                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |<-------------------------------|                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |<--------------------------------------------------------------------|                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |<-------------------|                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
</pre>
<p>æˆ‘ä»¬ç›´æ¥ä» <code>WebViewDelegate.addWebViewAssetPath(Context)</code> å¼€å§‹çœ‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addWebViewAssetPath</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String[] newAssetPaths = WebViewFactory.getLoadedPackageInfo().applicationInfo.getAllApkPaths();</span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo appInfo = context.getApplicationInfo();</span><br><span class="line"></span><br><span class="line">    String[] newLibAssets = appInfo.sharedLibraryFiles;</span><br><span class="line">    <span class="keyword">for</span> (String newAssetPath : newAssetPaths) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ newLibAssets ä¸å­˜åœ¨ newAssetPathï¼Œåˆ™åŸºäº newLibAssets åˆ›å»ºåŒ…å« newAssetPath çš„æ–°æ•°ç»„</span></span><br><span class="line">        newLibAssets = ArrayUtils.appendElement(String<span class="class">.<span class="keyword">class</span>, <span class="title">newLibAssets</span>, <span class="title">newAssetPath</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newLibAssets != appInfo.sharedLibraryFiles) &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–° ApplicationInfo çš„ sharedLibraryFilesï¼Œåˆ›å»º ContextImpl æ—¶ï¼ŒsharedLibraryFiles å°†ä½œä¸º</span></span><br><span class="line">        <span class="comment">// mLibDirs</span></span><br><span class="line">        appInfo.sharedLibraryFiles = newLibAssets;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°† WebView èµ„æºè·¯å¾„æ·»åŠ è¿› mLibDirs</span></span><br><span class="line">        ResourcesManager.getInstance().appendLibAssetsForMainAssetPath(appInfo.getBaseResourcePath(), newAssetPaths);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewDelegate.addWebViewAssetPath(Context)ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendLibAssetsForMainAssetPath</span><span class="params">(String assetPath, String[] libAssets)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// ä¿å­˜å°†è¦æ›´æ–°çš„ ResourcesImplï¼Œåœ¨è¿™ä¸ªé›†åˆé‡Œï¼ŒResourcesImpl æ˜¯æ—§çš„ï¼Œå°†è¦æ›´æ–°çš„ï¼ŒResourcesKey åˆ™æ˜¯æ–°çš„</span></span><br><span class="line">        <span class="keyword">final</span> ArrayMap&lt;ResourcesImpl, ResourcesKey&gt; updatedResourceKeys = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> implCount = mResourceImpls.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; implCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> ResourcesKey key = mResourceImpls.keyAt(i);</span><br><span class="line">            <span class="keyword">final</span> WeakReference&lt;ResourcesImpl&gt; weakImplRef = mResourceImpls.valueAt(i);</span><br><span class="line">            <span class="keyword">final</span> ResourcesImpl impl = weakImplRef != <span class="keyword">null</span> ? weakImplRef.get() : <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// ä»…æ›´æ–° key.mResDir æ˜¯ apk è·¯å¾„çš„ ResourcesKeyï¼Œæœ‰äº› ResourcesKey çš„ mResDir æ˜¯ç©ºå€¼</span></span><br><span class="line">            <span class="keyword">if</span> (impl != <span class="keyword">null</span> &amp;&amp; Objects.equals(key.mResDir, assetPath)) &#123;</span><br><span class="line">                String[] newLibAssets = key.mLibDirs;</span><br><span class="line">                <span class="keyword">for</span> (String libAsset : libAssets) &#123;</span><br><span class="line">                    newLibAssets = ArrayUtils.appendElement(String<span class="class">.<span class="keyword">class</span>, <span class="title">newLibAssets</span>, <span class="title">libAsset</span>)</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (newLibAssets != key.mLibDirs) &#123;</span><br><span class="line">                    updatedResourceKeys.put(impl, <span class="keyword">new</span> ResourcesKey(</span><br><span class="line">                            key.mResDir,</span><br><span class="line">                            key.mSplitResDirs,</span><br><span class="line">                            key.mOverlayDirs,</span><br><span class="line">                            newLibAssets,</span><br><span class="line">                            key.mDisplayId,</span><br><span class="line">                            key.mOverrideConfiguration,</span><br><span class="line">                            key.mCompatInfo));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        redirectResourcesToNewImplLocked(updatedResourceKeys);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.appendLibAssetsForMainAssetPath(String, String[])ğŸ‘†</center>
</p>

<blockquote>
<p><strong>ResourcesKey</strong> ä»£è¡¨èµ„æºçš„é…ç½®ï¼Œè¿™ç›¸å½“äºèµ„æºä»“åº“ï¼ˆResourcesImplï¼‰çš„ç´¢å¼•ä¸€æ ·ï¼Œä¸åŒçš„èµ„æºé…ç½®ï¼ˆå±å¹•å°ºå¯¸ã€å±å¹•å¯†åº¦ã€è¯­è¨€ï¼‰å¯¹åº”çš„ ResourcesImpl ä¸ä¸€æ ·<br><strong>ResourcesImpl</strong> èµ„æºçš„å…·ä½“å®ç°ï¼Œé‡Œé¢åŒ…å«äº† AssetManagerï¼Œè¯¥ç±»æ˜¯æœ€ç»ˆè·å–èµ„æºçš„æ‰€åœ¨<br><strong>mResourceImpl</strong> ç±»å‹ ArrayMap&lt;ResourcesKey, ResourcesImpl&gt;ï¼Œèµ„æºé…ç½®ä¸èµ„æºâ€˜ä»“åº“â€™çš„ç´¢å¼•è¡¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">redirectResourcesToNewImplLocked</span><span class="params">(@NonNull <span class="keyword">final</span> ArrayMap&lt;ResourcesImpl, ResourcesKey&gt; updatedResourceKeys)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Bail early if there is no work to do.</span></span><br><span class="line">    <span class="keyword">if</span> (updatedResourceKeys.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update any references to ResourcesImpl that require reloading.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> resourcesCount = mResourceReferences.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; resourcesCount; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> WeakReference&lt;Resources&gt; ref = mResourceReferences.get(i);</span><br><span class="line">        <span class="keyword">final</span> Resources r = ref != <span class="keyword">null</span> ? ref.get() : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ResourcesKey key = updatedResourceKeys.get(r.getImpl());</span><br><span class="line">            <span class="comment">// å¦‚æœ  Resources çš„ ResourcesImpl çš„ ResourcesKey è¢«æ›´æ–°äº†</span></span><br><span class="line">            <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// åˆ›å»ºæ–°çš„ ResourcesImpl</span></span><br><span class="line">                <span class="keyword">final</span> ResourcesImpl impl = findOrCreateResourcesImplForKeyLocked(key);</span><br><span class="line">                <span class="keyword">if</span> (impl == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Resources.NotFoundException(<span class="string">"failed to redirect ResourcesImpl"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ›´æ–°è¯¥ Resources çš„å®ç°</span></span><br><span class="line">                r.setImpl(impl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update any references to ResourcesImpl that require reloading for each Activity.</span></span><br><span class="line">    <span class="keyword">for</span> (ActivityResources activityResources : mActivityResourceReferences.values()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> resCount = activityResources.activityResources.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; resCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> WeakReference&lt;Resources&gt; ref = activityResources.activityResources.get(i);</span><br><span class="line">            <span class="keyword">final</span> Resources r = ref != <span class="keyword">null</span> ? ref.get() : <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> ResourcesKey key = updatedResourceKeys.get(r.getImpl());</span><br><span class="line">                <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ResourcesImpl impl = findOrCreateResourcesImplForKeyLocked(key);</span><br><span class="line">                    <span class="keyword">if</span> (impl == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> Resources.NotFoundException(<span class="string">"failed to redirect ResourcesImpl"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.setImpl(impl);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.redirectResourcesToNewImplLocked(ArrayMap)ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">findOrCreateResourcesImplForKeyLocked</span><span class="params">(@NonNull ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä» mResourceImpls å†…å­˜åœ¨ï¼Œå› ä¸º key æ˜¯æ–°åˆ›å»ºçš„ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å› null</span></span><br><span class="line">    ResourcesImpl impl = findResourcesImplForKeyLocked(key);</span><br><span class="line">    <span class="keyword">if</span> (impl == <span class="keyword">null</span>) &#123;</span><br><span class="line">        impl = createResourcesImpl(key);</span><br><span class="line">        <span class="keyword">if</span> (impl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mResourceImpls.put(key, <span class="keyword">new</span> WeakReference&lt;&gt;(impl));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> impl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.findOrCreateResourcesImplForKeyLocked(ResourcesKey)ğŸ‘†</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">createResourcesImpl</span><span class="params">(@NonNull ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> DisplayAdjustments daj = <span class="keyword">new</span> DisplayAdjustments(key.mOverrideConfiguration);</span><br><span class="line">    daj.setCompatibilityInfo(key.mCompatInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°çš„ AssetManager</span></span><br><span class="line">    <span class="keyword">final</span> AssetManager assets = createAssetManager(key);</span><br><span class="line">    <span class="keyword">if</span> (assets == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> DisplayMetrics dm = getDisplayMetrics(key.mDisplayId, daj);</span><br><span class="line">    <span class="keyword">final</span> Configuration config = generateConfig(key, dm);</span><br><span class="line">    <span class="keyword">final</span> ResourcesImpl impl = <span class="keyword">new</span> ResourcesImpl(assets, dm, config, daj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"- creating impl="</span> + impl + <span class="string">" with key: "</span> + key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> impl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.createResourcesImpl(ResourcesKey)ğŸ‘†</center>
</p>

<p>ç›´ç™½çš„æ¥è¯´ï¼Œ<strong>å¦‚æœåˆ›å»ºäº† WebView å¯¹è±¡ï¼ŒApplication.getResources().getImpl() è¿”å›çš„å¯¹è±¡å°±è¢«æ”¹å˜äº†</strong>ã€‚ç»“åˆå‰é¢äº†è§£åˆ°çš„ä¿¡æ¯ï¼Œæˆ‘æœ‰ä¸ªå¤§èƒ†çš„çŒœæµ‹ï¼šåœ¨ WebViewFactory.getProvider() å°† WebView èµ„æºä»¥ <code>AssetManager.addAssetPathAsSharedLibrary(String)</code> çš„æ–¹å¼æ·»åŠ è¿› <code>AssetManager.mApkAssets</code> ä¹‹åï¼Œåœ¨ WebViewChromiumAwInit å‘ä¸»çº¿ç¨‹å‘é€äº† Handler å¼‚æ­¥æ‰§è¡Œ <code>startChromiumLocked()</code> ä¹‹å‰ï¼Œä¸­é—´æŸå¤„åœ°æ–¹æ‰§è¡Œäº†ç±»ä¼¼ <code>WebViewDelegate.addWebViewAssetPath(Context)</code> çš„æ“ä½œå¯¼è‡´ AssetManager è¢«é‡æ–°åˆ›å»ºï¼Œå› ä¸º mLibDirs è¿˜æœªè®°å½• WebView èµ„æºï¼Œæ‰€ä»¥æ–°åˆ›å»ºçš„ AssetManager æ‰¾ä¸åˆ° WebView èµ„æºã€‚</p>
<h1 id="æœ€ç»ˆè§£å†³æ–¹æ¡ˆ"><a href="#æœ€ç»ˆè§£å†³æ–¹æ¡ˆ" class="headerlink" title="æœ€ç»ˆè§£å†³æ–¹æ¡ˆ"></a>æœ€ç»ˆè§£å†³æ–¹æ¡ˆ</h1><p>åŸºäºä¸Šé¢çš„å‡è®¾ï¼Œæ‹Ÿå®šäº†è§£å†³åŠæ³•ï¼šåœ¨ <code>WebViewFactory.getProvider()</code> å’Œ <code>WebViewFactoryProvider.getStatics()</code> ä¹‹é—´ï¼Œè°ƒç”¨ä¸€ä¸‹ <code>WebViewDelegate.addWebViewAssetPath(Context)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="meta">@SuppressLint</span>(&#123;<span class="string">"PrivateApi"</span>, <span class="string">"DiscouragedPrivateApi"</span>&#125;)</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getWebViewFactoryProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class clazz = Class.forName(<span class="string">"android.webkit.WebViewFactory"</span>);</span><br><span class="line">        Method method = clazz.getDeclaredMethod(<span class="string">"getProvider"</span>);</span><br><span class="line">        method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        ProductionEnv.throwExceptForDebugging(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint</span>(<span class="string">"PrivateApi"</span>)</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">initWebComponents</span><span class="params">(Application context)</span> </span>&#123;</span><br><span class="line">    Object provider = getWebViewFactoryProvider();</span><br><span class="line">    <span class="keyword">if</span> (provider == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class clazz = Class.forName(<span class="string">"android.webkit.WebViewDelegate"</span>);</span><br><span class="line">        Object instance = UnsafeAllocator.create().newInstance(clazz);</span><br><span class="line">        Method method = clazz.getMethod(<span class="string">"addWebViewAssetPath"</span>, Context<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        method.invoke(instance, context);</span><br><span class="line">        ProductionEnv.debugLog(TAG, <span class="string">"addWebViewAssetPath"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        ProductionEnv.throwExceptForDebugging(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Method method = provider.getClass().getMethod(<span class="string">"getStatics"</span>);</span><br><span class="line">        method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object result = method.invoke(provider);</span><br><span class="line">        ProductionEnv.debugLog(TAG, <span class="string">"getStatics: "</span> + result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        ProductionEnv.throwExceptForDebugging(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¿®å¤åçš„ç‰ˆæœ¬ï¼ŒResourcesNotFoundException å¼‚å¸¸ç¡®å®æ¶ˆå¤±äº†ï¼è¯´æ˜çŒœæµ‹æ˜¯æˆç«‹çš„ï¼</p>
<p>ä½†è¿™å¹¶ä¸æ˜¯æˆ‘æœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆï¼Œè€ƒè™‘åˆ° <code>WebViewFactory.getProvider()</code> å’Œ <code>WebViewFactoryProvider.getStatics()</code> å†…éƒ¨æ‰§è¡Œæ—¶æ˜¯æœ‰é”çš„ï¼Œè·ŸåŠ è½½å¹¿å‘Šçš„é€»è¾‘å¹¶è¡Œæ‰§è¡Œæ²¡æœ‰æ„ä¹‰ï¼Œç”šè‡³è¿˜ä¼šé˜»å¡ä¸»çº¿ç¨‹ä¸€å°æ®µæ—¶é—´ï¼ˆåŠ è½½æ’å±å¹¿å‘Šå¿…é¡»æ”¾åœ¨ä¸»çº¿ç¨‹ï¼Œåœ¨æ€§èƒ½å·®çš„æ‰‹æœºèƒ½å¡é¡¿ 1 ç§’ï¼ï¼‰ï¼Œå€’ä¸å¦‚åœ¨ <code>MobileAds.initialize()</code> ä¹‹åå»åŠ è½½å¹¿å‘Šï¼Œä¸‡äº‹ä¿±å¤‡ï¼Œä¹‹ååŠ è½½å¹¿å‘Šçš„å¤„ç†é€Ÿåº¦ä¹Ÿä¼šæ›´å¿«ï¼Œé˜»å¡ä¸»çº¿ç¨‹çš„æ—¶é—´å¤§å¤§å‡å°‘ã€‚è®½åˆºçš„æ˜¯ï¼Œæˆ‘æœ€åˆçš„ç›®çš„æ˜¯ä¸ºäº†æå‰åŠ è½½æ’å±å¹¿å‘Šä»¥æé«˜å±•ç¤ºç‡ï¼Œç„¶åé‡åˆ°äº†ä¸€ä¸ª ANRï¼Œä¸€ä¸ª Crashï¼Œæœ€ç»ˆè§£å†³æ–¹æ¡ˆç¡®æ˜¯å›æ»šæ“ä½œï¼Œä»€ä¹ˆéƒ½ä¸åš :-)</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2021-02-15T14:47:27.000Z" itemprop="dateUpdated">2021-02-15 22:47:27</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://dylantseng1915.github.io">
            <img src="/img/avatar.png" alt="Dylan Tseng">
            Dylan Tseng
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ANR/" rel="tag">ANR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Resources/" rel="tag">Resources</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebView/" rel="tag">WebView</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&title=ã€ŠAdmob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯ã€‹ â€” Dylan Tseng çš„åšå®¢&pic=https://dylantseng1915.github.io/img/avatar.png" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&title=ã€ŠAdmob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯ã€‹ â€” Dylan Tseng çš„åšå®¢&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€ŠAdmob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯ã€‹ â€” Dylan Tseng çš„åšå®¢&url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&via=https://dylantseng1915.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2017/01/12/cklcih3in0008kyz1fwz53v04/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">è¯¦è§£Androidè§¦æ‘¸äº‹ä»¶å¤„ç†ç¨‹åº</h4>
      </a>
    </div>
  
</nav>



    

</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        ç«™ç‚¹æ€»è®¿å®¢æ•°ï¼š<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        ç«™ç‚¹æ€»è®¿é—®é‡ï¼š<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
        </p>
    </div>
    <div class="bottom">
        <p><span>Dylan Tseng &copy; 2017 - 2021</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
            <p><span>ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œå¦‚éœ€è½¬è½½ï¼Œè¯·é€šè¿‡é‚®ä»¶è”ç³»æˆ‘</span></p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&title=ã€ŠAdmob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯ã€‹ â€” Dylan Tseng çš„åšå®¢&pic=https://dylantseng1915.github.io/img/avatar.png" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&title=ã€ŠAdmob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯ã€‹ â€” Dylan Tseng çš„åšå®¢&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€ŠAdmob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯ã€‹ â€” Dylan Tseng çš„åšå®¢&url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&via=https://dylantseng1915.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACo0lEQVR42u3a0U7DQAwEQP7/p+EVBD3WZ7sUafJURUnqKVJ8rO/tLT7evx2de8/P+Xz+0efhAw8PD69d+vevzws6X3++ssqO7sXDw8Nb482+oM/3nr/xzMhrxsPDw3sdXl50cldSAx4eHt5/5+VNotoeztfg4eHhvRovCSM6y+4zKYkV1rMWPDw8vNrUKZoivc7nlfkeHh4eXnuqXm0SyTI9r+euwi9PwMPDw1vgVcvtbCxIgob8CfkPhIeHhzfLq2516se1+UisE+zi4eHhPYeXj8Tygjpn7oKSqJ/g4eHhjfKmwoh8KXw3EivEEHh4eHgLvE5ZeaBQbTADMTEeHh7eMq/zOu7EvlNbWh/O9/Dw8PDWeHcDsGoQnCCrVz5sFXh4eHjLvNnP/aX2OaSIFuh4eHh4a7zOpoFq/JpHEtWm9cMZPDw8vAVeHhxU44Dqcvwuboj+MHh4eHijvHzh2wFXNwpMNR48PDy8bV5eaH+hnJzp14mHh4e3wau2h7tgImkDCelyuxgeHh7eAq+/2M0bQF5iNfgotAc8PDy8Bi8p4q4BVMHVKLnQ8fDw8PAWeHlgml/T2TiVBxnlZTQeHh7eEK9wQ7wE7wS71S1ZvwzA8PDw8EZ5dwOqqRL747GoWjw8PLw1Xh5DzA7+q2HEWPfDw8PDG+LlX5w8Oh+h5TVUI2A8PDy8PV4+zm9FA1dL59aBh4eHN8p7Lx53o6ykbdyN5X75ufHw8PAWeJ13bN4kzsvfaljcb0t4eHh4fV4/bkhC3upGq/x8OcbFw8PDG+L1Q4q7zVv96CFqDHh4eHh/yssX0HkbuGsq0U+Jh4eH9wK8zkDrLpioRsx4eHh4z+ElYcRscZ1NCXkLwcPDw9vgVf/h77ys87uetOMMDw8Pr8b7AMw7fYKzeCjhAAAAAElFTkSuQmCC" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
