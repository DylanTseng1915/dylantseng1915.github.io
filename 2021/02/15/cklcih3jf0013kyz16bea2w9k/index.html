<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Admob 并行请求广告引发的 ANR 的解决思路 | Dylan Tseng 的博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="ANR,Resources,WebView">
    <meta name="description" content="背景Zapee 基于 Admob 在冷启动接入插屏广告后发现，在限定 7s 内，广告展示率仅有 20+%。为了进一步提升开屏广告的展示率，将 Admob 初始化和加载开屏广告从串行改成并行，广告展示率提升到了 30+%。在随后的版本，在部分小米手机上，开始出现打开 app 卡在欢迎界面的情况。 发生了什么事情（错误信息分析）通过 adb bugreport {output} 命令导出错误记录，提取">
<meta property="og:type" content="article">
<meta property="og:title" content="Admob 并行请求广告引发的 ANR 的解决思路">
<meta property="og:url" content="https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/index.html">
<meta property="og:site_name" content="Dylan Tseng 的博客">
<meta property="og:description" content="背景Zapee 基于 Admob 在冷启动接入插屏广告后发现，在限定 7s 内，广告展示率仅有 20+%。为了进一步提升开屏广告的展示率，将 Admob 初始化和加载开屏广告从串行改成并行，广告展示率提升到了 30+%。在随后的版本，在部分小米手机上，开始出现打开 app 卡在欢迎界面的情况。 发生了什么事情（错误信息分析）通过 adb bugreport {output} 命令导出错误记录，提取">
<meta property="article:published_time" content="2021-02-15T14:47:27.000Z">
<meta property="article:modified_time" content="2021-02-15T14:47:27.000Z">
<meta property="article:author" content="Dylan Tseng">
<meta property="article:tag" content="ANR">
<meta property="article:tag" content="Resources">
<meta property="article:tag" content="WebView">
<meta name="twitter:card" content="summary">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Dylan Tseng</h5>
          <a href="mailto:dylantseng1915@gmail.com" title="dylantseng1915@gmail.com" class="mail">dylantseng1915@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/DylanTseng1915" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Admob 并行请求广告引发的 ANR 的解决思路</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Admob 并行请求广告引发的 ANR 的解决思路</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-02-15T14:47:27.000Z" itemprop="datePublished" class="page-time">
  2021-02-15
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#背景"><span class="post-toc-number">1.</span> <span class="post-toc-text">背景</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#发生了什么事情（错误信息分析）"><span class="post-toc-number">2.</span> <span class="post-toc-text">发生了什么事情（错误信息分析）</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#怎么发生的（源码分析）"><span class="post-toc-number">3.</span> <span class="post-toc-text">怎么发生的（源码分析）</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#加载-WebView-内核"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">加载 WebView 内核</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#初始化-WebView-内核"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">初始化 WebView 内核</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#解决办法"><span class="post-toc-number">4.</span> <span class="post-toc-text">解决办法</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#新的问题以及分析"><span class="post-toc-number">5.</span> <span class="post-toc-text">新的问题以及分析</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Resource-构建以及加载资源源码解析"><span class="post-toc-number">6.</span> <span class="post-toc-text">Resource 构建以及加载资源源码解析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#加载资源过程"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">加载资源过程</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#资源构建过程"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">资源构建过程</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#引入第三方资源的第一种方式"><span class="post-toc-number">7.</span> <span class="post-toc-text">引入第三方资源的第一种方式</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#引入第三方资源的第二种方式"><span class="post-toc-number">8.</span> <span class="post-toc-text">引入第三方资源的第二种方式</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#最终解决方案"><span class="post-toc-number">9.</span> <span class="post-toc-text">最终解决方案</span></a></li></ol>
        </nav>
    </aside>


<article id="post-Admob-并行请求广告引发的-ANR-的解决思路"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Admob 并行请求广告引发的 ANR 的解决思路</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-02-15 22:47:27" datetime="2021-02-15T14:47:27.000Z"  itemprop="datePublished">2021-02-15</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>Zapee 基于 Admob 在冷启动接入插屏广告后发现，在限定 7s 内，广告展示率仅有 20+%。为了进一步提升开屏广告的展示率，将 Admob 初始化和加载开屏广告从串行改成并行，广告展示率提升到了 30+%。在随后的版本，在部分小米手机上，开始出现打开 app 卡在欢迎界面的情况。</p>
<h1 id="发生了什么事情（错误信息分析）"><a href="#发生了什么事情（错误信息分析）" class="headerlink" title="发生了什么事情（错误信息分析）"></a>发生了什么事情（错误信息分析）</h1><p>通过 <code>adb bugreport {output}</code> 命令导出错误记录，提取出 ANR 日志中关键的部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line">&quot;main&quot; prio&#x3D;5 tid&#x3D;1 Blocked</span><br><span class="line">  | group&#x3D;&quot;main&quot; sCount&#x3D;1 dsCount&#x3D;0 flags&#x3D;1 obj&#x3D;0x7a02c410 self&#x3D;0x7398414c00</span><br><span class="line">  | sysTid&#x3D;18522 nice&#x3D;-10 cgrp&#x3D;default sched&#x3D;0&#x2F;0 handle&#x3D;0x741deb8548</span><br><span class="line">  | state&#x3D;S schedstat&#x3D;( 208328084 23627658 543 ) utm&#x3D;16 stm&#x3D;4 core&#x3D;7 HZ&#x3D;100</span><br><span class="line">  | stack&#x3D;0x7fd9c57000-0x7fd9c59000 stackSize&#x3D;8MB</span><br><span class="line">  | held mutexes&#x3D;</span><br><span class="line">  at com.google.android.gms.internal.ads.zzbgm.zza(:2)</span><br><span class="line">  - waiting to lock &lt;0x0901fb7f&gt; (a java.lang.Class&lt;com.google.android.gms.internal.ads.zzbgm&gt;) held by thread 35</span><br><span class="line">  at com.google.android.gms.ads.internal.ClientApi.zzb(:8)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwh.zza(:12)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwn.zzpy(:25)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwn.zzd(:66)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzze.zza(:39)</span><br><span class="line">  at com.google.android.gms.ads.InterstitialAd.loadAd(:9)</span><br><span class="line">  at o.ckh$a.run(:53)</span><br><span class="line">  at o.ckm$a.run(:13)</span><br><span class="line">  at android.os.Handler.handleCallback(Handler.java:873)</span><br><span class="line">  at android.os.Handler.dispatchMessage(Handler.java:99)</span><br><span class="line">  at android.os.Looper.loop(Looper.java:201)</span><br><span class="line">  at android.app.ActivityThread.main(ActivityThread.java:6806)</span><br><span class="line">  at java.lang.reflect.Method.invoke(Native method)</span><br><span class="line">  at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:547)</span><br><span class="line">  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:873)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">&quot;RxIoScheduler-3&quot; daemon prio&#x3D;5 tid&#x3D;35 Waiting</span><br><span class="line">  | group&#x3D;&quot;main&quot; sCount&#x3D;1 dsCount&#x3D;0 flags&#x3D;1 obj&#x3D;0x13d040a8 self&#x3D;0x737bccc800</span><br><span class="line">  | sysTid&#x3D;18593 nice&#x3D;0 cgrp&#x3D;default sched&#x3D;0&#x2F;0 handle&#x3D;0x737a3224f0</span><br><span class="line">  | state&#x3D;S schedstat&#x3D;( 62125674 47960004 273 ) utm&#x3D;4 stm&#x3D;2 core&#x3D;7 HZ&#x3D;100</span><br><span class="line">  | stack&#x3D;0x737a21f000-0x737a221000 stackSize&#x3D;1041KB</span><br><span class="line">  | held mutexes&#x3D;</span><br><span class="line">  at java.lang.Object.wait(Native method)</span><br><span class="line">  - waiting on &lt;0x0979f381&gt; (a java.lang.Object)</span><br><span class="line">  at el.b(chromium-SystemWebViewGoogle.aab-stable-428014103:19)</span><br><span class="line">  at el.g(chromium-SystemWebViewGoogle.aab-stable-428014103:3)</span><br><span class="line">  - locked &lt;0x0979f381&gt; (a java.lang.Object)</span><br><span class="line">  at com.android.webview.chromium.WebViewChromiumFactoryProvider.getStatics(chromium-SystemWebViewGoogle.aab-stable-428014103:4)</span><br><span class="line">  - locked &lt;0x0979f381&gt; (a java.lang.Object)</span><br><span class="line">  at android.webkit.WebSettings.getDefaultUserAgent(WebSettings.java:1266)</span><br><span class="line">  at com.google.android.gms.ads.internal.util.zzbv.call(:15)</span><br><span class="line">  at com.google.android.gms.ads.internal.util.zzbu.zza(:24)</span><br><span class="line">  at com.google.android.gms.ads.internal.util.zzbu.zza(:1)</span><br><span class="line">  at com.google.android.gms.ads.internal.util.zzv.getDefaultUserAgent(:13)</span><br><span class="line">  at com.google.android.gms.ads.internal.util.zzm.zzq(:90)</span><br><span class="line">  - locked &lt;0x07e42c26&gt; (a java.lang.Object)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzayg.zzd(:37)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzbgm.zza(:21)</span><br><span class="line">  - locked &lt;0x0901fb7f&gt; (a java.lang.Class&lt;com.google.android.gms.internal.ads.zzbgm&gt;)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzbgm.zzf(:10)</span><br><span class="line">  at com.google.android.gms.ads.internal.ClientApi.zza(:44)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwj.zza(:12)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwn.zzpy(:25)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzwn.zzd(:66)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzzd.zzg(:168)</span><br><span class="line">  at com.google.android.gms.internal.ads.zzzd.zza(:29)</span><br><span class="line">  - locked &lt;0x0cfe9067&gt; (a java.lang.Object)</span><br><span class="line">  at com.google.android.gms.ads.MobileAds.initialize(:10)</span><br><span class="line">  at com.pugc.ads.Ads$a.ˊ(:202)</span><br><span class="line">  at com.pugc.ads.Ads$a.ˊ(:123)</span><br><span class="line">  at com.pugc.ads.Ads$a$a.ˊ(:154)</span><br><span class="line">  at com.pugc.ads.Ads$a$a.call(:151)</span><br><span class="line">  at rx.Observable.unsafeSubscribe(:10256)</span><br><span class="line">  at rx.internal.operators.OperatorSubscribeOn$SubscribeOnSubscriber.call(:100)</span><br><span class="line">  at rx.internal.schedulers.CachedThreadScheduler$EventLoopWorker$1.call(:230)</span><br><span class="line">  at rx.internal.schedulers.ScheduledAction.run(:55)</span><br><span class="line">  at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:458)</span><br><span class="line">  at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">  at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:301)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167)</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)</span><br><span class="line">  at java.lang.Thread.run(Thread.java:764)</span><br></pre></td></tr></table></figure>
<p>从日志中发现主线程正在等待 <strong>锁&lt;0x0901fb7f&gt;</strong> ，而这个锁被 <strong>tid=35</strong> 的线程所持有，主线程正在加载插屏广告，而线程正在初始化 Admob，也就是说加载广告和广告初始化并行处理会触发死锁。一般来说，死锁是两个线程互相持有对方需要的锁造成的，但是主线程除了等待 <strong>锁&lt;0x0901fb7f&gt;</strong> 之外并不持有其它锁，显然这不是常见的死锁行为。</p>
<h1 id="怎么发生的（源码分析）"><a href="#怎么发生的（源码分析）" class="headerlink" title="怎么发生的（源码分析）"></a>怎么发生的（源码分析）</h1><p>为什么 <code>WebSettings.getDefaultUserAgent()</code> 会导致线程处于无法被唤醒的状态？这个答案，要从源码里寻找。调用过程涉及到 WebView 内核的加载以及初始化，从 Android 7 开始，WebView 不再是内置的程序，变成了单独的 app（你会开发者选项内看到有个 WebView 选项），加载过程也变得复杂，我们分两部分分析：1. WebViewFactory.getProvider()（加载 WebView 内核）；2. WebViewFactoryProvider.getStatics()（初始化 WebView 内核）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDefaultUserAgent</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> WebViewFactory.getProvider().getStatics().getDefaultUserAgent(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewSettings.getDefaultUserAgent()👆</center>
</p>

<p>主要类说明：</p>
<blockquote>
<p><strong>WebViewFactory</strong>：主要用于创建 WebViewFactoryProvider<br><strong>WebViewFactoryProvider</strong>：WebView 所用到的主要对象的实现类都是由它创建，包括 WebView 的实现<br><strong>WebViewFactoryProvider.Statics</strong>：因为 WebView 以及实现类都是实现了 WebViewProvider 接口，WebView 使用的一些静态方法无法放入接口，所以都收归到这个类来实现</p>
</blockquote>
<h2 id="加载-WebView-内核"><a href="#加载-WebView-内核" class="headerlink" title="加载 WebView 内核"></a>加载 WebView 内核</h2><p>以下是加载内核的时序图：</p>
<pre style="background-color: #00000000">
+---------------------+             +-------------+                        +-------------------+ +---------------------------------+
| getUserDefaultAgent |             | getProvider |                        | getProviderClass  | | getWebViewContextAndSetProvider |
+---------------------+             +-------------+                        +-------------------+ +---------------------------------+
           |                               |                                         |                            |
           |                               |                                         |                            |
           |------------------------------>|                                         |                            |
           |                               |                                         |                            |
           |                               |                                         |                            |
           |                               |---------------------------------------->|                            |
           |                               |                                         |                            |
           |                               |                                         |                            |
           |                               |                                         |--------------------------->|
           |                               |                                         |                            |
           |                               |                                         |                    Context |
           |                               |                                         |<---------------------------|
           |                               |                                         |                            |
           |                               |          Class&lt;WebViewFactoryProvider&gt;  |                            |
           |                               |<----------------------------------------|                            |
           |                               |                                         |                            |
           |        WebViewFactoryProvider |                                         |                            |
           |<------------------------------|                                         |                            |
           |                               |                                         |                            |
</pre>

<p>主要源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> WebViewFactoryProvider <span class="title">getProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (sProviderLock) &#123;</span><br><span class="line">        <span class="comment">// For now the main purpose of this function (and the factory abstraction) is to keep</span></span><br><span class="line">        <span class="comment">// us honest and minimize usage of WebView internals when binding the proxy.</span></span><br><span class="line">        <span class="keyword">if</span> (sProviderInstance != <span class="keyword">null</span>) <span class="keyword">return</span> sProviderInstance;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除了一些不影响理解的代码</span></span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewFactory.getProvider()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;WebViewFactoryProvider&gt; providerClass = getProviderClass();</span><br><span class="line">            Method staticFactory = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 反射 WebViewChromiumFactoryProvider#create(WebViewDelegate) 方法</span></span><br><span class="line">                staticFactory = providerClass.getMethod(CHROMIUM_WEBVIEW_FACTORY_METHOD, WebViewDelegate<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewFactoryProvider invocation"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 创建 WebViewFactoryProvider 实现类的实例</span></span><br><span class="line">                sProviderInstance = (WebViewFactoryProvider) staticFactory.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> WebViewDelegate());</span><br><span class="line">                <span class="keyword">return</span> sProviderInstance;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewFactoryProvider.getProvider()👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Class&lt;WebViewFactoryProvider&gt; <span class="title">getProviderClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Context webViewContext = <span class="keyword">null</span>;</span><br><span class="line">    Application initialApplication = AppGlobals.getInitialApplication();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewFactory.getWebViewContextAndSetProvider()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 或者 WebView 的 Context</span></span><br><span class="line">            webViewContext = getWebViewContextAndSetProvider();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewFactory.getChromiumProviderClass()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 将 WebView 的资源加入 AssetManager，这步很重要，后面会讲</span></span><br><span class="line">            initialApplication.getAssets().addAssetPathAsSharedLibrary(webViewContext.getApplicationInfo().sourceDir);</span><br><span class="line">            ClassLoader clazzLoader = webViewContext.getClassLoader();</span><br><span class="line"></span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewFactory.loadNativeLibrary()"</span>);</span><br><span class="line">            WebViewLibraryLoader.loadNativeLibrary(clazzLoader, getWebViewLibrary(sPackageInfo.applicationInfo));</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line"></span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"Class.forName()"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 获得 WebViewFactoryProvider 实现类的 Class</span></span><br><span class="line">                <span class="keyword">return</span> getWebViewProviderClass(clazzLoader);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MissingWebViewPackageException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewFacotry.getProviderClass()👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Context <span class="title">getWebViewContextAndSetProvider</span><span class="params">()</span> <span class="keyword">throws</span> MissingWebViewPackageException </span>&#123;</span><br><span class="line">    <span class="comment">// initialApplication 是 app 的 application 对象</span></span><br><span class="line">    Application initialApplication = AppGlobals.getInitialApplication();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        WebViewProviderResponse response = <span class="keyword">null</span>;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"WebViewUpdateService.waitForAndGetProvider()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 从 IWebViewUpdateService 获取 WebView app 的主要信息，包括 packageInfo</span></span><br><span class="line">            response = getUpdateService().waitForAndGetProvider();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (response.status != LIBLOAD_SUCCESS &amp;&amp; response.status != LIBLOAD_FAILED_WAITING_FOR_RELRO) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MissingWebViewPackageException(<span class="string">"Failed to load WebView provider: "</span></span><br><span class="line">                    + getWebViewPreparationErrorReason(response.status));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Register to be killed before fetching package info - so that we will be</span></span><br><span class="line">        <span class="comment">// killed if the package info goes out-of-date.</span></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"ActivityManager.addPackageDependency()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ActivityManager.getService().addPackageDependency(response.packageInfo.packageName);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Fetch package info and verify it against the chosen package</span></span><br><span class="line">        PackageInfo newPackageInfo = <span class="keyword">null</span>;</span><br><span class="line">        PackageManager pm = initialApplication.getPackageManager();</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW, <span class="string">"PackageManager.getPackageInfo()"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            newPackageInfo = pm.getPackageInfo(</span><br><span class="line">                response.packageInfo.packageName,</span><br><span class="line">                PackageManager.GET_SHARED_LIBRARY_FILES</span><br><span class="line">                | PackageManager.MATCH_DEBUG_TRIAGED_MISSING</span><br><span class="line">                <span class="comment">// Make sure that we fetch the current provider even if its not</span></span><br><span class="line">                <span class="comment">// installed for the current user</span></span><br><span class="line">                | PackageManager.MATCH_UNINSTALLED_PACKAGES</span><br><span class="line">                <span class="comment">// Fetch signatures for verification</span></span><br><span class="line">                | PackageManager.GET_SIGNATURES</span><br><span class="line">                <span class="comment">// Get meta-data for meta data flag verification</span></span><br><span class="line">                | PackageManager.GET_META_DATA);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validate the newly fetched package info, throws MissingWebViewPackageException on</span></span><br><span class="line">        <span class="comment">// failure</span></span><br><span class="line">        verifyPackageInfo(response.packageInfo, newPackageInfo);</span><br><span class="line"></span><br><span class="line">        ApplicationInfo ai = newPackageInfo.applicationInfo;</span><br><span class="line">        fixupStubApplicationInfo(ai, pm);</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_WEBVIEW,</span><br><span class="line">                <span class="string">"initialApplication.createApplicationContext"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 WebView 的 Application Context</span></span><br><span class="line">            Context webViewContext = initialApplication.createApplicationContext(</span><br><span class="line">                    ai,</span><br><span class="line">                    Context.CONTEXT_INCLUDE_CODE | Context.CONTEXT_IGNORE_SECURITY);</span><br><span class="line">            sPackageInfo = newPackageInfo;</span><br><span class="line">            <span class="keyword">return</span> webViewContext;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_WEBVIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException | PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MissingWebViewPackageException(<span class="string">"Failed to load WebView provider: "</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewFactory.getWebViewContextAndSetProvider()👆</center>
</p>

<p>加载过程：</p>
<ol>
<li>通过 IWebViewUpdateService 获得 WebViewProviderResponse 对象，里面包含了 WebView 的 PackageInfo</li>
<li>用这个 PackageInfo 通过 PackageManager 创建 New PackageInfo（可能旧的信息不全）</li>
<li>再用自身 app 的 Application 对象调用 <code>createApplicationContext(newPackageInfo.applicationInfo)</code> 便可获得 WebView 的 Application Context</li>
<li>有了 WebView 的 Application Context 对象便可拿到很多信息，首先是调用 <code>AssetManager.addAssetPathAsSharedLibrary(Context)</code> 将 WebView 的资源加载到自身的 AssetManager 内</li>
<li>其次，最重要的是，可以获得基于 WebView apk 生成的 ClassLoader 对象，反射出 Class<WebViewFacotryProvider>，WebViewFactoryProvider 是接口，反射出的 Class 是它的实现类，根据 Android 版本的不同，反射出的实现类也不一样<blockquote>
<p>Android 7 -&gt; <code>com.android.webview.chromium.WebViewChromiumFactoryProvider</code><br>Android 8 -&gt; <code>com.android.webview.chromium.WebViewChromiumFactoryProviderForO</code><br>Android 9 -&gt; <code>com.android.webview.chromium.WebViewChromiumFactoryProviderForP</code><br>Android 10 -&gt; <code>com.android.webview.chromium.WebViewChromiumFactoryProviderForQ</code><br>Android 11 -&gt; <code>com.android.webview.chromium.WebViewChromiumFactoryProviderForR</code></p>
</blockquote>
</li>
<li>最后，反射实现类的静态方法 <code>create(WebViewDelegate)</code> 得到 WebViewFactoryProvider 实现类的实例</li>
</ol>
<h2 id="初始化-WebView-内核"><a href="#初始化-WebView-内核" class="headerlink" title="初始化 WebView 内核"></a>初始化 WebView 内核</h2><p>分析 <code>WebViewFactoryProvider.getStatics()</code> 需要将 Chromium 的<a href="https://chromium.googlesource.com/chromium/src" target="_blank" rel="noopener">源码</a>拉取下来，整个工程很大，有 28G，此次分析基于 <strong>tag: 87.0.4280.141</strong> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Statics <span class="title">getStatics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mAwInit.getLock()) &#123;</span><br><span class="line">        SharedStatics sharedStatics = mAwInit.getStatics();</span><br><span class="line">        <span class="keyword">if</span> (mStaticsAdapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mStaticsAdapter = <span class="keyword">new</span> WebViewChromiumFactoryProvider.Statics() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">findAddress</span><span class="params">(String addr)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> sharedStatics.findAddress(addr);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">getDefaultUserAgent</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> sharedStatics.getDefaultUserAgent(context);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 删除不影响理解的代码</span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mStaticsAdapter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewFactoryProvider.getStatics()👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SharedStatics <span class="title">getStatics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSharedStatics == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Optimization potential: most these methods only need the native library</span></span><br><span class="line">            <span class="comment">// loaded and initialized, not the entire browser process started.</span></span><br><span class="line">            <span class="comment">// See also http://b/7009882</span></span><br><span class="line">            ensureChromiumStartedLocked(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mSharedStatics;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewChromiumAwInit.getStatics()👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This method is not private only because the downstream subclass needs to access it,</span></span><br><span class="line"><span class="comment">// it shouldn't be accessed from anywhere else.</span></span><br><span class="line"><span class="comment">/* package */</span> <span class="function"><span class="keyword">void</span> <span class="title">ensureChromiumStartedLocked</span><span class="params">(<span class="keyword">boolean</span> onMainThread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> Thread.holdsLock(mLock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mStarted) &#123; <span class="comment">// Early-out for the common case.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Looper looper = !onMainThread ? Looper.myLooper() : Looper.getMainLooper();</span><br><span class="line">    ThreadUtils.setUiThread(looper);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ThreadUtils.runningOnUiThread()) &#123;</span><br><span class="line">        <span class="comment">// 如果在主线程，直接调用</span></span><br><span class="line">        startChromiumLocked();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果在子线程，发个异步 Handler 执行</span></span><br><span class="line">    AwThreadUtils.postToUiThreadLooper(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                startChromiumLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">while</span> (!mStarted) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;                </span><br><span class="line">            <span class="comment">// 一直等待，直到 startChromiumLocked 执行完唤醒线程</span></span><br><span class="line">            mLock.wait();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// Keep trying... eventually the UI thread will process the task we sent it.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewChromiumAwInit.ensureChromiumStartedLocked(Boolean)👆</center>
</p>

<p>看到下面这段代码你是不是恍然大悟了？👇</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AwThreadUtils.postToUiThreadLooper(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            startChromiumLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">while</span> (!mStarted) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mLock.wait();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原来死锁的原因是 <strong>「线程 tid=35」</strong> 在持有 <strong>锁&lt;0x0901fb7f&gt;</strong> 的情况下，向主线程发送了个异步执行的 Handler，并 wait 当前线程等待 Handler 执行完被唤醒，然而主线程此时正在等待 <strong>锁&lt;0x0901fb7f&gt;</strong> 释放，发送的 Handler 无法被执行，从而造成了死锁。</p>
<h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><p>解决办法也很简单，将 <code>WebSettings.getDefaultUserAgent()</code> 在 <code>MobileAds.initialize()</code> 前面执行，避免在 <strong>锁&lt;0x0901fb7f&gt;</strong> 内加载、初始化 WebView 内核，加载和初始化操作只会执行一次。该方案在几台几乎必现的小米手机上得到了验证。</p>
<h1 id="新的问题以及分析"><a href="#新的问题以及分析" class="headerlink" title="新的问题以及分析"></a>新的问题以及分析</h1><p>bugfix 上线后，意外的新增了 ResourceNotFoundException 异常，而且概率还不小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Caused by android.content.res.Resources$NotFoundException: Resource ID #0x20c0021</span><br><span class="line">       at android.content.res.ResourcesImpl.getValue(ResourcesImpl.java:216)</span><br><span class="line">       at android.content.res.Resources.getInteger(Resources.java:1097)</span><br><span class="line">       at org.chromium.ui.base.DeviceFormFactor.isTablet(DeviceFormFactor.java:2)</span><br><span class="line">       at wm0.a(wm0.java:2)</span><br><span class="line">       at GE.run(GE.java:3)</span><br><span class="line">       at org.chromium.content.browser.BrowserStartupControllerImpl.g(BrowserStartupControllerImpl.java:12)</span><br><span class="line">       at org.chromium.content.browser.BrowserStartupControllerImpl.j(BrowserStartupControllerImpl.java:9)</span><br><span class="line">       at Cr.run(Cr.java:9)</span><br><span class="line">       at org.chromium.base.ThreadUtils.i(ThreadUtils.java:2)</span><br><span class="line">       at KY3.j(KY3.java:32)</span><br><span class="line">       at JY3.run(JY3.java:2)</span><br><span class="line">       at android.os.Handler.handleCallback(Handler.java:789)</span><br><span class="line">       at android.os.Handler.dispatchMessage(Handler.java:98)</span><br><span class="line">       at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">       at android.app.ActivityThread.main(ActivityThread.java:6944)</span><br><span class="line">       at java.lang.reflect.Method.invoke(Method.java)</span><br><span class="line">       at com.android.internal.os.Zygote$MethodAndArgsCaller.run(Zygote.java:327)</span><br><span class="line">       at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1374)</span><br></pre></td></tr></table></figure>
<p>还原后的错误堆栈：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Caused by android.content.res.Resources$NotFoundException: Resource ID #0x20c0021</span><br><span class="line">       at android.content.res.ResourcesImpl.getValue(ResourcesImpl.java:216)</span><br><span class="line">       at android.content.res.Resources.getInteger(Resources.java:1097)</span><br><span class="line">       at org.chromium.ui.base.DeviceFormFactor.isTablet(DeviceFormFactor.java:2)</span><br><span class="line">       at org.chromium.content.browser.DeviceUtilsImpl.addDeviceSpecificUserAgentSwitch()</span><br><span class="line">       at org.chromium.content.browser.BrowserStartupControllerImpl.prepareToStartBrowserProcess$Runnable.run()</span><br><span class="line">       at org.chromium.content.browser.BrowserStartupControllerImpl.prepareToStartBrowserProcess()</span><br><span class="line">       at org.chromium.content.browser.BrowserStartupControllerImpl.startBrowserProcessesSync()</span><br><span class="line">       at com.android.webview.chromium.AwBrowserProcess.start$Runnable.run()</span><br><span class="line">       at org.chromium.base.ThreadUtils.runOnUiThreadBlocking()</span><br><span class="line">       at com.android.webview.chromium.AwBrowserProcess.start()</span><br><span class="line">       at com.android.webview.chromium.WebViewChromiumAwInit.startChromiumLocked()</span><br><span class="line">       at com.android.webview.chromium.WebViewChromiumAwInit.ensureChromiumStartedLocked$Runnable.run()</span><br><span class="line">       at android.os.Handler.handleCallback(Handler.java:789)</span><br><span class="line">       at android.os.Handler.dispatchMessage(Handler.java:98)</span><br><span class="line">       at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">       at android.app.ActivityThread.main(ActivityThread.java:6944)</span><br><span class="line">       at java.lang.reflect.Method.invoke(Method.java)</span><br><span class="line">       at com.android.internal.os.Zygote$MethodAndArgsCaller.run(Zygote.java:327)</span><br><span class="line">       at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1374)</span><br></pre></td></tr></table></figure>
<p>从堆栈里看不出原因，解决问题的思路回归问题的本质：<code>Resources.getInteger(int)</code> 是如何寻找资源的？为什么资源消失了？</p>
<h1 id="Resource-构建以及加载资源源码解析"><a href="#Resource-构建以及加载资源源码解析" class="headerlink" title="Resource 构建以及加载资源源码解析"></a>Resource 构建以及加载资源源码解析</h1><h2 id="加载资源过程"><a href="#加载资源过程" class="headerlink" title="加载资源过程"></a>加载资源过程</h2><p><code>Resources.getInteger(int)</code> 调用时序图：</p>
<pre style="background-color: #00000000">
+-------+             +-----------+                              +---------------+                                         +---------------+                  
| User  |             | Resources |                              | ResourcesImpl |                                         | AssetManager  |                  
+-------+             +-----------+                              +---------------+                                         +---------------+                  
    |                       |                                            |                                                         |                          
    | getInteger(int)       |                                            |                                                         |                          
    |---------------------->|                                            |                                                         |                          
    |                       |                                            |                                                         |                          
    |                       | getValue(int, TypedValue, boolean)         |                                                         |                          
    |                       |------------------------------------------->|                                                         |                          
    |                       |                                            |                                                         |                          
    |                       |                                            | getResourceValue(int, int, TypedValue, boolean)         |                          
    |                       |                                            |-------------------------------------------------------->|                          
    |                       |                                            |                                                         |                          
    |                       |                                            |                                                         | nativeGetResourceValue() 
    |                       |                                            |                                                         |------------------------- 
    |                       |                                            |                                                         |                        | 
    |                       |                                            |                                                         |<------------------------ 
    |                       |                                            |                                                         |                          
    |                       |                                            |                                                 boolean |                          
    |                       |                                            |<--------------------------------------------------------|                          
    |                       |                                            |                                                         |                          
    |                       |                                            |                                                         |                          
    |                       |<-------------------------------------------|                                                         |                          
    |                       |                                            |                                                         |                          
    |                   int |                                            |                                                         |                          
    |<----------------------|                                            |                                                         |                          
    |                       |                                            |                                                         |     
</pre>
<p>从 AssetManager 内也看不问题，<code>nativeGetResourceValue</code> 不太可能出错，出错的可能是装载资源的地方，那 Application 的资源以及第三方的资源是如何装载的呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">getResourceValue</span><span class="params">(@AnyRes <span class="keyword">int</span> resId, <span class="keyword">int</span> densityDpi, @NonNull TypedValue outValue, <span class="keyword">boolean</span> resolveRefs)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(outValue, <span class="string">"outValue"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        ensureValidLocked();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> cookie = nativeGetResourceValue(mObject, resId, (<span class="keyword">short</span>) densityDpi, outValue, resolveRefs);</span><br><span class="line">        <span class="keyword">if</span> (cookie &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Convert the changing configurations flags populated by native code.</span></span><br><span class="line">        outValue.changingConfigurations = ActivityInfo.activityInfoConfigNativeToJava(</span><br><span class="line">                outValue.changingConfigurations);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (outValue.type == TypedValue.TYPE_STRING) &#123;</span><br><span class="line">            outValue.string = mApkAssets[cookie - <span class="number">1</span>].getStringFromPool(outValue.data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">AssetManager.getResourceValue(int, int, TypedValue, boolean)👆</center>
</p>

<h2 id="资源构建过程"><a href="#资源构建过程" class="headerlink" title="资源构建过程"></a>资源构建过程</h2><p>首先先搞清楚 Application 的资源是如何构建的，构建的过程肯定涉及到了装载。我们知道 Activity、Application、Service 都继承至 ContextWrapper，获取 <code>getResources()</code> 实际上是 <strong>mBase</strong> 实现类去完成的，那这个 <strong>mBase</strong> 实现类是谁呢？答案是 <strong>ContextImpl</strong>，<strong>ContextImpl</strong> 的创建在 <code>LoadedApk.makeApplication()</code> 内，以下是整个过程的时序图：</p>
<pre style="background-color: #00000000">
+-----------------+          +-----------+              +-------------+ +-------------------+              
| ActivityThread  |          | LoadedApk |              | ContextImpl | | ResourcesManager  |              
+-----------------+          +-----------+              +-------------+ +-------------------+              
         |                         |                           |                  |                        
         | makeApplication()       |                           |                  |                        
         |------------------------>|                           |                  |                        
         |                         |                           |                  |                        
         |                         | createAppContext()        |                  |                        
         |                         |-------------------------->|                  |                        
         |                         |                           |                  |                        
         |                         |            getResources() |                  |                        
         |                         |<--------------------------|                  |                        
         |                         |                           |                  |                        
         |                         | getResources()            |                  |                        
         |                         |--------------------------------------------->|                        
         |                         |                           |                  |                        
         |                         |                           |                  | getOrCreateResources() 
         |                         |                           |                  |----------------------- 
         |                         |                           |                  |                      | 
         |                         |                           |                  |<---------------------- 
         |                         |                           |                  |                        
         |                         |                           |                  | createResourcesImpl()  
         |                         |                           |                  |----------------------  
         |                         |                           |                  |                     |  
         |                         |                           |                  |<---------------------  
         |                         |                           |                  |                        
         |                         |                           |                  | createAssetManager()   
         |                         |                           |                  |---------------------   
         |                         |                           |                  |                    |   
         |                         |                           |                  |<--------------------   
         |                         |                           |                  |                        
         |                         |                           |        Resources |                        
         |                         |<---------------------------------------------|                        
         |                         |                           |                  |                        
         |                         | Resources                 |                  |                        
         |                         |-------------------------->|                  |                        
         |                         |                           |                  |                        
         |                         |               Application |                  |                        
         |<----------------------------------------------------|                  |                        
         |                         |                           |                  |    
</pre>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mApplication;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Application app = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    String appClass = mApplicationInfo.className;</span><br><span class="line">    <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        appClass = <span class="string">"android.app.Application"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (!mPackageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">            initializeJavaContextClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 创建 Application 并将 appContext 作为 mBase</span></span><br><span class="line">        app = mActivityThread.mInstrumentation.newApplication(cl, appClass, appContext);</span><br><span class="line">        appContext.setOuterContext(app);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mActivityThread.mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate application "</span> + appClass</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mActivityThread.mAllApplications.add(app);</span><br><span class="line">    mApplication = app;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">LoadedApk.makeApplication(boolean, Instrumentation)👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createAppContext</span><span class="params">(ActivityThread mainThread, LoadedApk packageInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"packageInfo"</span>);</span><br><span class="line">    ContextImpl context = <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread, packageInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// Resources 被赋值的地方</span></span><br><span class="line">    context.setResources(packageInfo.getResources());</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ContextImpl.createAppContext(ActivityThread, LoadedApk)👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resources <span class="title">getResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mResources == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> String[] splitPaths;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            splitPaths = getSplitPaths(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// This should never fail.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"null split not found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mResources = ResourcesManager.getInstance().getResources(<span class="keyword">null</span>, mResDir,</span><br><span class="line">                splitPaths, mOverlayDirs, mApplicationInfo.sharedLibraryFiles,</span><br><span class="line">                Display.DEFAULT_DISPLAY, <span class="keyword">null</span>, getCompatibilityInfo(),</span><br><span class="line">                getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mResources;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">LoadedApk.getResources()👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">Resources <span class="title">getResources</span><span class="params">(@Nullable IBinder activityToken,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String resDir,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String[] splitResDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String[] overlayDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String[] libDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_RESOURCES, <span class="string">"ResourcesManager#getResources"</span>);</span><br><span class="line">        <span class="keyword">final</span> ResourcesKey key = <span class="keyword">new</span> ResourcesKey(</span><br><span class="line">                resDir,</span><br><span class="line">                splitResDirs,</span><br><span class="line">                overlayDirs,</span><br><span class="line">                libDirs,</span><br><span class="line">                displayId,</span><br><span class="line">                overrideConfig != <span class="keyword">null</span> ? <span class="keyword">new</span> Configuration(overrideConfig) : <span class="keyword">null</span>, <span class="comment">// Copy</span></span><br><span class="line">                compatInfo);</span><br><span class="line">        classLoader = classLoader != <span class="keyword">null</span> ? classLoader : ClassLoader.getSystemClassLoader();</span><br><span class="line">        <span class="keyword">return</span> getOrCreateResources(activityToken, key, classLoader);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_RESOURCES);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.getResources(IBinder, String, String[], String[], String[], int, Configuration, CompatibilityInfo, ClassLoader)👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">Resources <span class="title">getOrCreateResources</span><span class="params">(@Nullable IBinder activityToken, @NonNull ResourcesKey key, @NonNull ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (activityToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 删除此部分代码</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Clean up any dead references so they don't pile up.</span></span><br><span class="line">            ArrayUtils.unstableRemoveIf(mResourceReferences, sEmptyReferencePredicate);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Not tied to an Activity, find a shared Resources that has the right ResourcesImpl</span></span><br><span class="line">            ResourcesImpl resourcesImpl = findResourcesImplForKeyLocked(key);</span><br><span class="line">            <span class="keyword">if</span> (resourcesImpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> getOrCreateResourcesLocked(classLoader, resourcesImpl, key.mCompatInfo);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We will create the ResourcesImpl object outside of holding this lock.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Resources 相当于代理类，ResourcesImpl 才是真正获取资源的地方</span></span><br><span class="line">        ResourcesImpl resourcesImpl = createResourcesImpl(key);</span><br><span class="line">        <span class="keyword">if</span> (resourcesImpl == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add this ResourcesImpl to the cache.</span></span><br><span class="line">        mResourceImpls.put(key, <span class="keyword">new</span> WeakReference&lt;&gt;(resourcesImpl));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Resources resources;</span><br><span class="line">        <span class="keyword">if</span> (activityToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resources = getOrCreateResourcesForActivityLocked(activityToken, classLoader, resourcesImpl, key.mCompatInfo);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resources = getOrCreateResourcesLocked(classLoader, resourcesImpl, key.mCompatInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resources;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.getOrCreateResources(IBinder, ResourcesKey, ClassLoader)</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">createResourcesImpl</span><span class="params">(@NonNull ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> DisplayAdjustments daj = <span class="keyword">new</span> DisplayAdjustments(key.mOverrideConfiguration);</span><br><span class="line">    daj.setCompatibilityInfo(key.mCompatInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 AssetManager</span></span><br><span class="line">    <span class="keyword">final</span> AssetManager assets = createAssetManager(key);</span><br><span class="line">    <span class="keyword">if</span> (assets == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> DisplayMetrics dm = getDisplayMetrics(key.mDisplayId, daj);</span><br><span class="line">    <span class="keyword">final</span> Configuration config = generateConfig(key, dm);</span><br><span class="line">    <span class="keyword">final</span> ResourcesImpl impl = <span class="keyword">new</span> ResourcesImpl(assets, dm, config, daj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> impl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.createResourcesImpl(ResourcesKey)</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="meta">@Nullable</span> <span class="function">AssetManager <span class="title">createAssetManager</span><span class="params">(@NonNull <span class="keyword">final</span> ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> AssetManager.Builder builder = <span class="keyword">new</span> AssetManager.Builder();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// resDir can be null if the 'android' package is creating a new Resources object.</span></span><br><span class="line">    <span class="comment">// This is fine, since each AssetManager automatically loads the 'android' package</span></span><br><span class="line">    <span class="comment">// already.</span></span><br><span class="line">    <span class="keyword">if</span> (key.mResDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            builder.addApkAssets(loadApkAssets(key.mResDir, <span class="keyword">false</span> <span class="comment">/*sharedLib*/</span>, <span class="keyword">false</span> <span class="comment">/*overlay*/</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"failed to add asset path "</span> + key.mResDir);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key.mSplitResDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> String splitResDir : key.mSplitResDirs) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                builder.addApkAssets(loadApkAssets(splitResDir, <span class="keyword">false</span> <span class="comment">/*sharedLib*/</span>, <span class="keyword">false</span> <span class="comment">/*overlay*/</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"failed to add split asset path "</span> + splitResDir);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key.mOverlayDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> String idmapPath : key.mOverlayDirs) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                builder.addApkAssets(loadApkAssets(idmapPath, <span class="keyword">false</span> <span class="comment">/*sharedLib*/</span>, <span class="keyword">true</span> <span class="comment">/*overlay*/</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"failed to add overlay path "</span> + idmapPath);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// continue.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key.mLibDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> String libDir : key.mLibDirs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (libDir.endsWith(<span class="string">".apk"</span>)) &#123;</span><br><span class="line">                <span class="comment">// Avoid opening files we know do not have resources,</span></span><br><span class="line">                <span class="comment">// like code-only .jar files.</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    builder.addApkAssets(loadApkAssets(libDir, <span class="keyword">true</span> <span class="comment">/*sharedLib*/</span>, <span class="keyword">false</span> <span class="comment">/*overlay*/</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">"Asset path '"</span> + libDir +</span><br><span class="line">                            <span class="string">"' does not exist or contains no resources."</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// continue.</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> builder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.createAssetManager(ResourcesKey)</center>
</p>

<p>可以看到，资源分为四类，分别是<code>mResDir</code>、<code>mSplitResDir</code>、<code>mOverlayDirs</code>和<code>mLibDirs</code>，它们之间的区别是什么？以 Snaptube App 为例，四个变量的值分别为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"mResDir"</span>: <span class="string">"/data/app/com.snaptube.premium-zCPItxCKMtiPLZuponnKNA==/base.apk"</span>,</span><br><span class="line">    <span class="attr">"mLibDirs"</span>: [</span><br><span class="line">        <span class="string">"/system/framework/org.apache.http.legacy.jar"</span>,</span><br><span class="line">        <span class="string">"/data/app/com.google.android.webview-iYfutTXhDoC6vtZnRdoEeA==/base.apk"</span>,</span><br><span class="line">        <span class="string">"/data/app/com.google.android.webview-iYfutTXhDoC6vtZnRdoEeA==/split_config.en.apk"</span>,</span><br><span class="line">        <span class="string">"/data/app/com.google.android.webview-iYfutTXhDoC6vtZnRdoEeA==/split_config.zh.apk"</span>,</span><br><span class="line">        <span class="string">"/data/app/com.google.android.trichromelibrary_432415233-dML7CdjKq4aFdFHYn4kICg==/base.apk"</span>,</span><br><span class="line">        <span class="string">"/product/overlay/NavigationBarMode3Button/NavigationBarMode3ButtonOverlay.apk"</span>,</span><br><span class="line">        <span class="string">"/vendor/overlay/oneplus_shape_circle/OnePlusIconShapeCircleOverlay.apk"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"mOverlayDirs"</span>: [</span><br><span class="line">        <span class="string">"/product/overlay/NavigationBarMode3Button/NatigationBarMode3ButtonOverlay.apk"</span>,</span><br><span class="line">        <span class="string">"/vendor/overlay/oneplus_shape_circle/OnePlusIconShapeCircleOverlay.apk"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"mSplitResDirs"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>mResDir</strong> 很显然是指 app 的资源路径，即 apk 的路径<br><strong>mLibDirs</strong> 指依赖的第三方库的资源路径，例如 WebView 资源<br><strong>mOverlayDirs</strong> 应该是指系统浮层组件的资源路径，例如底部导航栏<br><strong>mSplitResDir</strong> 不太理解…</p>
</blockquote>
<p>到这里，我们对 Resources 的加载以及构建有了大概的了解，以及看到了 WebView 资源存放的位置，回过头来思考 ResourcesNotFoundException 异常出现的原因，会不会在 WebView 内核在初始化的时候，<strong>mLibDirs</strong> 还没有赋值呢？那为什么是概率性发生异常？在加载 WebView 内核时，不是已经装载它的资源了吗？</p>
<h1 id="引入第三方资源的第一种方式"><a href="#引入第三方资源的第一种方式" class="headerlink" title="引入第三方资源的第一种方式"></a>引入第三方资源的第一种方式</h1><p>带着疑惑，重新回到 <code>WebViewFactory.getProviderClass()</code> 装载 WebView 资源的地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initialApplication.getAssets().addAssetPathAsSharedLibrary(webViewContext.getApplicationInfo().sourceDir);</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewFactory.getProviderClass()👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addAssetPathAsSharedLibrary</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addAssetPathInternal(path, <span class="keyword">false</span> <span class="comment">/*overlay*/</span>, <span class="keyword">true</span> <span class="comment">/*appAsLib*/</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">AssetManager.addAssetPathAsSharedLibrary(String)</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">addAssetPathInternal</span><span class="params">(String path, <span class="keyword">boolean</span> overlay, <span class="keyword">boolean</span> appAsLib)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(path, <span class="string">"path"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        ensureOpenLocked();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> count = mApkAssets.length;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// See if we already have it loaded.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mApkAssets[i].getAssetPath().equals(path)) &#123;</span><br><span class="line">                <span class="keyword">return</span> i + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ApkAssets assets;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (overlay) &#123;</span><br><span class="line">                <span class="comment">// TODO(b/70343104): This hardcoded path will be removed once</span></span><br><span class="line">                <span class="comment">// addAssetPathInternal is deleted.</span></span><br><span class="line">                <span class="keyword">final</span> String idmapPath = <span class="string">"/data/resource-cache/"</span></span><br><span class="line">                        + path.substring(<span class="number">1</span>).replace(<span class="string">'/'</span>, <span class="string">'@'</span>)</span><br><span class="line">                        + <span class="string">"@idmap"</span>;</span><br><span class="line">                assets = ApkAssets.loadOverlayFromPath(idmapPath, <span class="keyword">false</span> <span class="comment">/*system*/</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                assets = ApkAssets.loadFromPath(path, <span class="keyword">false</span> <span class="comment">/*system*/</span>, appAsLib);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mApkAssets = Arrays.copyOf(mApkAssets, count + <span class="number">1</span>);</span><br><span class="line">        mApkAssets[count] = assets;</span><br><span class="line">        nativeSetApkAssets(mObject, mApkAssets, <span class="keyword">true</span>);</span><br><span class="line">        invalidateCachesLocked(-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> count + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">AssetManager.addAssetPathInternal(String, boolean, boolean)</center>
</p>
看到这，我惊奇的发现，这种方式并没有将 WebView 的资源路径添加进 mLibDirs，而仅仅是添加进 AssetManager 的 mApkAssets 的数组内，那 WebView 的资源路径是谁在什么时候添加进 mLibDirs 的呢？有没有可能 AssetManager 被重建了导致 mApkAssets 丢失了 WebView 的资源呢？

<h1 id="引入第三方资源的第二种方式"><a href="#引入第三方资源的第二种方式" class="headerlink" title="引入第三方资源的第二种方式"></a>引入第三方资源的第二种方式</h1><p>事实上，在创建 WebView 实例时，WebView 内核会用另外一种方式添加资源，这种方式会将资源路径保存在 mLibDirs，以下是整个过程的时序图：</p>
<pre style="background-color: #00000000">
+---------+          +---------+                           +-----------------+ +---------------------------------+      +-----------------+              +-----------------+                         +-------------------+                               
| Outside |          | WebView |                           | WebViewFactory  | | WebViewChromiumFactoryProvider  |      | WebViewChromium |              | WebViewDelegate |                         | ResourcesManager  |                               
+---------+          +---------+                           +-----------------+ +---------------------------------+      +-----------------+              +-----------------+                         +-------------------+                               
     |                    |                                         |                           |                                |                                |                                            |                                         
     | new WebView()      |                                         |                           |                                |                                |                                            |                                         
     |------------------->|                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    | ensureProviderCreated()                 |                           |                                |                                |                                            |                                         
     |                    |------------------------                 |                           |                                |                                |                                            |                                         
     |                    |                       |                 |                           |                                |                                |                                            |                                         
     |                    |<-----------------------                 |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    | getProvider()                           |                           |                                |                                |                                            |                                         
     |                    |---------------------------------------->|                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |          WebViewChromiumFactoryProvider |                           |                                |                                |                                            |                                         
     |                    |<----------------------------------------|                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    | createWebView()                         |                           |                                |                                |                                            |                                         
     |                    |-------------------------------------------------------------------->|                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           | new WebViewChromium()          |                                |                                            |                                         
     |                    |                                         |                           |------------------------------->|                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                | addWebViewAssetPath()          |                                            |                                         
     |                    |                                         |                           |                                |------------------------------->|                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                | appendLibAssetForMainAssetPath()           |                                         
     |                    |                                         |                           |                                |                                |------------------------------------------->|                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            | redirectResourcesToNewImplLocked()      
     |                    |                                         |                           |                                |                                |                                            |-----------------------------------      
     |                    |                                         |                           |                                |                                |                                            |                                  |      
     |                    |                                         |                           |                                |                                |                                            |<----------------------------------      
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            | findOrCreateResourcesImplForKeyLocked() 
     |                    |                                         |                           |                                |                                |                                            |---------------------------------------- 
     |                    |                                         |                           |                                |                                |                                            |                                       | 
     |                    |                                         |                           |                                |                                |                                            |<--------------------------------------- 
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            | createResourcesImpl()                   
     |                    |                                         |                           |                                |                                |                                            |----------------------                   
     |                    |                                         |                           |                                |                                |                                            |                     |                   
     |                    |                                         |                           |                                |                                |                                            |<---------------------                   
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            | createAssetManager()                    
     |                    |                                         |                           |                                |                                |                                            |---------------------                    
     |                    |                                         |                           |                                |                                |                                            |                    |                    
     |                    |                                         |                           |                                |                                |                                            |<--------------------                    
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |<-------------------------------------------|                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |<-------------------------------|                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |<-------------------------------|                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |<--------------------------------------------------------------------|                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
     |<-------------------|                                         |                           |                                |                                |                                            |                                         
     |                    |                                         |                           |                                |                                |                                            |                                         
</pre>
<p>我们直接从 <code>WebViewDelegate.addWebViewAssetPath(Context)</code> 开始看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addWebViewAssetPath</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String[] newAssetPaths = WebViewFactory.getLoadedPackageInfo().applicationInfo.getAllApkPaths();</span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo appInfo = context.getApplicationInfo();</span><br><span class="line"></span><br><span class="line">    String[] newLibAssets = appInfo.sharedLibraryFiles;</span><br><span class="line">    <span class="keyword">for</span> (String newAssetPath : newAssetPaths) &#123;</span><br><span class="line">        <span class="comment">// 如果 newLibAssets 不存在 newAssetPath，则基于 newLibAssets 创建包含 newAssetPath 的新数组</span></span><br><span class="line">        newLibAssets = ArrayUtils.appendElement(String<span class="class">.<span class="keyword">class</span>, <span class="title">newLibAssets</span>, <span class="title">newAssetPath</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newLibAssets != appInfo.sharedLibraryFiles) &#123;</span><br><span class="line">        <span class="comment">// 更新 ApplicationInfo 的 sharedLibraryFiles，创建 ContextImpl 时，sharedLibraryFiles 将作为</span></span><br><span class="line">        <span class="comment">// mLibDirs</span></span><br><span class="line">        appInfo.sharedLibraryFiles = newLibAssets;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 WebView 资源路径添加进 mLibDirs</span></span><br><span class="line">        ResourcesManager.getInstance().appendLibAssetsForMainAssetPath(appInfo.getBaseResourcePath(), newAssetPaths);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">WebViewDelegate.addWebViewAssetPath(Context)👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendLibAssetsForMainAssetPath</span><span class="params">(String assetPath, String[] libAssets)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 保存将要更新的 ResourcesImpl，在这个集合里，ResourcesImpl 是旧的，将要更新的，ResourcesKey 则是新的</span></span><br><span class="line">        <span class="keyword">final</span> ArrayMap&lt;ResourcesImpl, ResourcesKey&gt; updatedResourceKeys = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> implCount = mResourceImpls.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; implCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> ResourcesKey key = mResourceImpls.keyAt(i);</span><br><span class="line">            <span class="keyword">final</span> WeakReference&lt;ResourcesImpl&gt; weakImplRef = mResourceImpls.valueAt(i);</span><br><span class="line">            <span class="keyword">final</span> ResourcesImpl impl = weakImplRef != <span class="keyword">null</span> ? weakImplRef.get() : <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 仅更新 key.mResDir 是 apk 路径的 ResourcesKey，有些 ResourcesKey 的 mResDir 是空值</span></span><br><span class="line">            <span class="keyword">if</span> (impl != <span class="keyword">null</span> &amp;&amp; Objects.equals(key.mResDir, assetPath)) &#123;</span><br><span class="line">                String[] newLibAssets = key.mLibDirs;</span><br><span class="line">                <span class="keyword">for</span> (String libAsset : libAssets) &#123;</span><br><span class="line">                    newLibAssets = ArrayUtils.appendElement(String<span class="class">.<span class="keyword">class</span>, <span class="title">newLibAssets</span>, <span class="title">libAsset</span>)</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (newLibAssets != key.mLibDirs) &#123;</span><br><span class="line">                    updatedResourceKeys.put(impl, <span class="keyword">new</span> ResourcesKey(</span><br><span class="line">                            key.mResDir,</span><br><span class="line">                            key.mSplitResDirs,</span><br><span class="line">                            key.mOverlayDirs,</span><br><span class="line">                            newLibAssets,</span><br><span class="line">                            key.mDisplayId,</span><br><span class="line">                            key.mOverrideConfiguration,</span><br><span class="line">                            key.mCompatInfo));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        redirectResourcesToNewImplLocked(updatedResourceKeys);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.appendLibAssetsForMainAssetPath(String, String[])👆</center>
</p>

<blockquote>
<p><strong>ResourcesKey</strong> 代表资源的配置，这相当于资源仓库（ResourcesImpl）的索引一样，不同的资源配置（屏幕尺寸、屏幕密度、语言）对应的 ResourcesImpl 不一样<br><strong>ResourcesImpl</strong> 资源的具体实现，里面包含了 AssetManager，该类是最终获取资源的所在<br><strong>mResourceImpl</strong> 类型 ArrayMap&lt;ResourcesKey, ResourcesImpl&gt;，资源配置与资源‘仓库’的索引表</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">redirectResourcesToNewImplLocked</span><span class="params">(@NonNull <span class="keyword">final</span> ArrayMap&lt;ResourcesImpl, ResourcesKey&gt; updatedResourceKeys)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Bail early if there is no work to do.</span></span><br><span class="line">    <span class="keyword">if</span> (updatedResourceKeys.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update any references to ResourcesImpl that require reloading.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> resourcesCount = mResourceReferences.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; resourcesCount; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> WeakReference&lt;Resources&gt; ref = mResourceReferences.get(i);</span><br><span class="line">        <span class="keyword">final</span> Resources r = ref != <span class="keyword">null</span> ? ref.get() : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ResourcesKey key = updatedResourceKeys.get(r.getImpl());</span><br><span class="line">            <span class="comment">// 如果  Resources 的 ResourcesImpl 的 ResourcesKey 被更新了</span></span><br><span class="line">            <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 创建新的 ResourcesImpl</span></span><br><span class="line">                <span class="keyword">final</span> ResourcesImpl impl = findOrCreateResourcesImplForKeyLocked(key);</span><br><span class="line">                <span class="keyword">if</span> (impl == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Resources.NotFoundException(<span class="string">"failed to redirect ResourcesImpl"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 更新该 Resources 的实现</span></span><br><span class="line">                r.setImpl(impl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update any references to ResourcesImpl that require reloading for each Activity.</span></span><br><span class="line">    <span class="keyword">for</span> (ActivityResources activityResources : mActivityResourceReferences.values()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> resCount = activityResources.activityResources.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; resCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> WeakReference&lt;Resources&gt; ref = activityResources.activityResources.get(i);</span><br><span class="line">            <span class="keyword">final</span> Resources r = ref != <span class="keyword">null</span> ? ref.get() : <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> ResourcesKey key = updatedResourceKeys.get(r.getImpl());</span><br><span class="line">                <span class="keyword">if</span> (key != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ResourcesImpl impl = findOrCreateResourcesImplForKeyLocked(key);</span><br><span class="line">                    <span class="keyword">if</span> (impl == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> Resources.NotFoundException(<span class="string">"failed to redirect ResourcesImpl"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.setImpl(impl);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.redirectResourcesToNewImplLocked(ArrayMap)👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">findOrCreateResourcesImplForKeyLocked</span><span class="params">(@NonNull ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从 mResourceImpls 内存在，因为 key 是新创建的，这个方法返回 null</span></span><br><span class="line">    ResourcesImpl impl = findResourcesImplForKeyLocked(key);</span><br><span class="line">    <span class="keyword">if</span> (impl == <span class="keyword">null</span>) &#123;</span><br><span class="line">        impl = createResourcesImpl(key);</span><br><span class="line">        <span class="keyword">if</span> (impl != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mResourceImpls.put(key, <span class="keyword">new</span> WeakReference&lt;&gt;(impl));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> impl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.findOrCreateResourcesImplForKeyLocked(ResourcesKey)👆</center>
</p>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">createResourcesImpl</span><span class="params">(@NonNull ResourcesKey key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> DisplayAdjustments daj = <span class="keyword">new</span> DisplayAdjustments(key.mOverrideConfiguration);</span><br><span class="line">    daj.setCompatibilityInfo(key.mCompatInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建新的 AssetManager</span></span><br><span class="line">    <span class="keyword">final</span> AssetManager assets = createAssetManager(key);</span><br><span class="line">    <span class="keyword">if</span> (assets == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> DisplayMetrics dm = getDisplayMetrics(key.mDisplayId, daj);</span><br><span class="line">    <span class="keyword">final</span> Configuration config = generateConfig(key, dm);</span><br><span class="line">    <span class="keyword">final</span> ResourcesImpl impl = <span class="keyword">new</span> ResourcesImpl(assets, dm, config, daj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"- creating impl="</span> + impl + <span class="string">" with key: "</span> + key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> impl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<center style="margin-top: -15px; font-size: 9px; color: #5a5a5a">ResourcesManager.createResourcesImpl(ResourcesKey)👆</center>
</p>

<p>直白的来说，<strong>如果创建了 WebView 对象，Application.getResources().getImpl() 返回的对象就被改变了</strong>。结合前面了解到的信息，我有个大胆的猜测：在 WebViewFactory.getProvider() 将 WebView 资源以 <code>AssetManager.addAssetPathAsSharedLibrary(String)</code> 的方式添加进 <code>AssetManager.mApkAssets</code> 之后，在 WebViewChromiumAwInit 向主线程发送了 Handler 异步执行 <code>startChromiumLocked()</code> 之前，中间某处地方执行了类似 <code>WebViewDelegate.addWebViewAssetPath(Context)</code> 的操作导致 AssetManager 被重新创建，因为 mLibDirs 还未记录 WebView 资源，所以新创建的 AssetManager 找不到 WebView 资源。</p>
<h1 id="最终解决方案"><a href="#最终解决方案" class="headerlink" title="最终解决方案"></a>最终解决方案</h1><p>基于上面的假设，拟定了解决办法：在 <code>WebViewFactory.getProvider()</code> 和 <code>WebViewFactoryProvider.getStatics()</code> 之间，调用一下 <code>WebViewDelegate.addWebViewAssetPath(Context)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="meta">@SuppressLint</span>(&#123;<span class="string">"PrivateApi"</span>, <span class="string">"DiscouragedPrivateApi"</span>&#125;)</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getWebViewFactoryProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class clazz = Class.forName(<span class="string">"android.webkit.WebViewFactory"</span>);</span><br><span class="line">        Method method = clazz.getDeclaredMethod(<span class="string">"getProvider"</span>);</span><br><span class="line">        method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        ProductionEnv.throwExceptForDebugging(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint</span>(<span class="string">"PrivateApi"</span>)</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">initWebComponents</span><span class="params">(Application context)</span> </span>&#123;</span><br><span class="line">    Object provider = getWebViewFactoryProvider();</span><br><span class="line">    <span class="keyword">if</span> (provider == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class clazz = Class.forName(<span class="string">"android.webkit.WebViewDelegate"</span>);</span><br><span class="line">        Object instance = UnsafeAllocator.create().newInstance(clazz);</span><br><span class="line">        Method method = clazz.getMethod(<span class="string">"addWebViewAssetPath"</span>, Context<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        method.invoke(instance, context);</span><br><span class="line">        ProductionEnv.debugLog(TAG, <span class="string">"addWebViewAssetPath"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        ProductionEnv.throwExceptForDebugging(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Method method = provider.getClass().getMethod(<span class="string">"getStatics"</span>);</span><br><span class="line">        method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object result = method.invoke(provider);</span><br><span class="line">        ProductionEnv.debugLog(TAG, <span class="string">"getStatics: "</span> + result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        ProductionEnv.throwExceptForDebugging(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修复后的版本，ResourcesNotFoundException 异常确实消失了！说明猜测是成立的！</p>
<p>但这并不是我最终的解决方案，考虑到 <code>WebViewFactory.getProvider()</code> 和 <code>WebViewFactoryProvider.getStatics()</code> 内部执行时是有锁的，跟加载广告的逻辑并行执行没有意义，甚至还会阻塞主线程一小段时间（加载插屏广告必须放在主线程，在性能差的手机能卡顿 1 秒！），倒不如在 <code>MobileAds.initialize()</code> 之后去加载广告，万事俱备，之后加载广告的处理速度也会更快，阻塞主线程的时间大大减少。讽刺的是，我最初的目的是为了提前加载插屏广告以提高展示率，然后遇到了一个 ANR，一个 Crash，最终解决方案确是回滚操作，什么都不做 :-)</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2021-02-15T14:47:27.000Z" itemprop="dateUpdated">2021-02-15 22:47:27</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://dylantseng1915.github.io">
            <img src="/img/avatar.png" alt="Dylan Tseng">
            Dylan Tseng
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ANR/" rel="tag">ANR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Resources/" rel="tag">Resources</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebView/" rel="tag">WebView</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&title=《Admob 并行请求广告引发的 ANR 的解决思路》 — Dylan Tseng 的博客&pic=https://dylantseng1915.github.io/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&title=《Admob 并行请求广告引发的 ANR 的解决思路》 — Dylan Tseng 的博客&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Admob 并行请求广告引发的 ANR 的解决思路》 — Dylan Tseng 的博客&url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&via=https://dylantseng1915.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2017/01/12/cklcih3in0008kyz1fwz53v04/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">详解Android触摸事件处理程序</h4>
      </a>
    </div>
  
</nav>



    

</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
        </p>
    </div>
    <div class="bottom">
        <p><span>Dylan Tseng &copy; 2017 - 2021</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
            <p><span>版权归作者所有，如需转载，请通过邮件联系我</span></p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&title=《Admob 并行请求广告引发的 ANR 的解决思路》 — Dylan Tseng 的博客&pic=https://dylantseng1915.github.io/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&title=《Admob 并行请求广告引发的 ANR 的解决思路》 — Dylan Tseng 的博客&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Admob 并行请求广告引发的 ANR 的解决思路》 — Dylan Tseng 的博客&url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/&via=https://dylantseng1915.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACo0lEQVR42u3a0U7DQAwEQP7/p+EVBD3WZ7sUafJURUnqKVJ8rO/tLT7evx2de8/P+Xz+0efhAw8PD69d+vevzws6X3++ssqO7sXDw8Nb482+oM/3nr/xzMhrxsPDw3sdXl50cldSAx4eHt5/5+VNotoeztfg4eHhvRovCSM6y+4zKYkV1rMWPDw8vNrUKZoivc7nlfkeHh4eXnuqXm0SyTI9r+euwi9PwMPDw1vgVcvtbCxIgob8CfkPhIeHhzfLq2516se1+UisE+zi4eHhPYeXj8Tygjpn7oKSqJ/g4eHhjfKmwoh8KXw3EivEEHh4eHgLvE5ZeaBQbTADMTEeHh7eMq/zOu7EvlNbWh/O9/Dw8PDWeHcDsGoQnCCrVz5sFXh4eHjLvNnP/aX2OaSIFuh4eHh4a7zOpoFq/JpHEtWm9cMZPDw8vAVeHhxU44Dqcvwuboj+MHh4eHijvHzh2wFXNwpMNR48PDy8bV5eaH+hnJzp14mHh4e3wau2h7tgImkDCelyuxgeHh7eAq+/2M0bQF5iNfgotAc8PDy8Bi8p4q4BVMHVKLnQ8fDw8PAWeHlgml/T2TiVBxnlZTQeHh7eEK9wQ7wE7wS71S1ZvwzA8PDw8EZ5dwOqqRL747GoWjw8PLw1Xh5DzA7+q2HEWPfDw8PDG+LlX5w8Oh+h5TVUI2A8PDy8PV4+zm9FA1dL59aBh4eHN8p7Lx53o6ykbdyN5X75ufHw8PAWeJ13bN4kzsvfaljcb0t4eHh4fV4/bkhC3upGq/x8OcbFw8PDG+L1Q4q7zVv96CFqDHh4eHh/yssX0HkbuGsq0U+Jh4eH9wK8zkDrLpioRsx4eHh4z+ElYcRscZ1NCXkLwcPDw9vgVf/h77ys87uetOMMDw8Pr8b7AMw7fYKzeCjhAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
