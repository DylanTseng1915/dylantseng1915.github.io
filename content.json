{"meta":{"title":"Dylan Tseng çš„åšå®¢","subtitle":null,"description":null,"author":"Dylan Tseng","url":"https://dylantseng1915.github.io"},"pages":[{"title":"categories","date":"2021-02-14T15:51:40.000Z","updated":"2021-02-14T15:52:11.366Z","comments":false,"path":"categories/index.html","permalink":"https://dylantseng1915.github.io/categories/index.html","excerpt":"","text":""},{"title":"tags","date":"2021-02-14T15:51:28.000Z","updated":"2021-02-14T15:52:35.805Z","comments":false,"path":"tags/index.html","permalink":"https://dylantseng1915.github.io/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"Admob å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„ ANR çš„è§£å†³æ€è·¯","slug":"Admob-å¹¶è¡Œè¯·æ±‚å¹¿å‘Šå¼•å‘çš„-ANR-çš„è§£å†³æ€è·¯","date":"2021-02-15T14:47:27.000Z","updated":"2021-02-15T14:47:27.000Z","comments":false,"path":"2021/02/15/cklcih3jf0013kyz16bea2w9k/","link":"","permalink":"https://dylantseng1915.github.io/2021/02/15/cklcih3jf0013kyz16bea2w9k/","excerpt":"","text":"èƒŒæ™¯Zapee åŸºäº Admob åœ¨å†·å¯åŠ¨æ¥å…¥æ’å±å¹¿å‘Šåå‘ç°ï¼Œåœ¨é™å®š 7s å†…ï¼Œå¹¿å‘Šå±•ç¤ºç‡ä»…æœ‰ 20+%ã€‚ä¸ºäº†è¿›ä¸€æ­¥æå‡å¼€å±å¹¿å‘Šçš„å±•ç¤ºç‡ï¼Œå°† Admob åˆå§‹åŒ–å’ŒåŠ è½½å¼€å±å¹¿å‘Šä»ä¸²è¡Œæ”¹æˆå¹¶è¡Œï¼Œå¹¿å‘Šå±•ç¤ºç‡æå‡åˆ°äº† 30+%ã€‚åœ¨éšåçš„ç‰ˆæœ¬ï¼Œåœ¨éƒ¨åˆ†å°ç±³æ‰‹æœºä¸Šï¼Œå¼€å§‹å‡ºç°æ‰“å¼€ app å¡åœ¨æ¬¢è¿ç•Œé¢çš„æƒ…å†µã€‚ å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼ˆé”™è¯¯ä¿¡æ¯åˆ†æï¼‰é€šè¿‡ adb bugreport {output} å‘½ä»¤å¯¼å‡ºé”™è¯¯è®°å½•ï¼Œæå–å‡º ANR æ—¥å¿—ä¸­å…³é”®çš„éƒ¨åˆ† 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273......&quot;main&quot; prio&#x3D;5 tid&#x3D;1 Blocked | group&#x3D;&quot;main&quot; sCount&#x3D;1 dsCount&#x3D;0 flags&#x3D;1 obj&#x3D;0x7a02c410 self&#x3D;0x7398414c00 | sysTid&#x3D;18522 nice&#x3D;-10 cgrp&#x3D;default sched&#x3D;0&#x2F;0 handle&#x3D;0x741deb8548 | state&#x3D;S schedstat&#x3D;( 208328084 23627658 543 ) utm&#x3D;16 stm&#x3D;4 core&#x3D;7 HZ&#x3D;100 | stack&#x3D;0x7fd9c57000-0x7fd9c59000 stackSize&#x3D;8MB | held mutexes&#x3D; at com.google.android.gms.internal.ads.zzbgm.zza(:2) - waiting to lock &lt;0x0901fb7f&gt; (a java.lang.Class&lt;com.google.android.gms.internal.ads.zzbgm&gt;) held by thread 35 at com.google.android.gms.ads.internal.ClientApi.zzb(:8) at com.google.android.gms.internal.ads.zzwh.zza(:12) at com.google.android.gms.internal.ads.zzwn.zzpy(:25) at com.google.android.gms.internal.ads.zzwn.zzd(:66) at com.google.android.gms.internal.ads.zzze.zza(:39) at com.google.android.gms.ads.InterstitialAd.loadAd(:9) at o.ckh$a.run(:53) at o.ckm$a.run(:13) at android.os.Handler.handleCallback(Handler.java:873) at android.os.Handler.dispatchMessage(Handler.java:99) at android.os.Looper.loop(Looper.java:201) at android.app.ActivityThread.main(ActivityThread.java:6806) at java.lang.reflect.Method.invoke(Native method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:547) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:873)......&quot;RxIoScheduler-3&quot; daemon prio&#x3D;5 tid&#x3D;35 Waiting | group&#x3D;&quot;main&quot; sCount&#x3D;1 dsCount&#x3D;0 flags&#x3D;1 obj&#x3D;0x13d040a8 self&#x3D;0x737bccc800 | sysTid&#x3D;18593 nice&#x3D;0 cgrp&#x3D;default sched&#x3D;0&#x2F;0 handle&#x3D;0x737a3224f0 | state&#x3D;S schedstat&#x3D;( 62125674 47960004 273 ) utm&#x3D;4 stm&#x3D;2 core&#x3D;7 HZ&#x3D;100 | stack&#x3D;0x737a21f000-0x737a221000 stackSize&#x3D;1041KB | held mutexes&#x3D; at java.lang.Object.wait(Native method) - waiting on &lt;0x0979f381&gt; (a java.lang.Object) at el.b(chromium-SystemWebViewGoogle.aab-stable-428014103:19) at el.g(chromium-SystemWebViewGoogle.aab-stable-428014103:3) - locked &lt;0x0979f381&gt; (a java.lang.Object) at com.android.webview.chromium.WebViewChromiumFactoryProvider.getStatics(chromium-SystemWebViewGoogle.aab-stable-428014103:4) - locked &lt;0x0979f381&gt; (a java.lang.Object) at android.webkit.WebSettings.getDefaultUserAgent(WebSettings.java:1266) at com.google.android.gms.ads.internal.util.zzbv.call(:15) at com.google.android.gms.ads.internal.util.zzbu.zza(:24) at com.google.android.gms.ads.internal.util.zzbu.zza(:1) at com.google.android.gms.ads.internal.util.zzv.getDefaultUserAgent(:13) at com.google.android.gms.ads.internal.util.zzm.zzq(:90) - locked &lt;0x07e42c26&gt; (a java.lang.Object) at com.google.android.gms.internal.ads.zzayg.zzd(:37) at com.google.android.gms.internal.ads.zzbgm.zza(:21) - locked &lt;0x0901fb7f&gt; (a java.lang.Class&lt;com.google.android.gms.internal.ads.zzbgm&gt;) at com.google.android.gms.internal.ads.zzbgm.zzf(:10) at com.google.android.gms.ads.internal.ClientApi.zza(:44) at com.google.android.gms.internal.ads.zzwj.zza(:12) at com.google.android.gms.internal.ads.zzwn.zzpy(:25) at com.google.android.gms.internal.ads.zzwn.zzd(:66) at com.google.android.gms.internal.ads.zzzd.zzg(:168) at com.google.android.gms.internal.ads.zzzd.zza(:29) - locked &lt;0x0cfe9067&gt; (a java.lang.Object) at com.google.android.gms.ads.MobileAds.initialize(:10) at com.pugc.ads.Ads$a.ËŠ(:202) at com.pugc.ads.Ads$a.ËŠ(:123) at com.pugc.ads.Ads$a$a.ËŠ(:154) at com.pugc.ads.Ads$a$a.call(:151) at rx.Observable.unsafeSubscribe(:10256) at rx.internal.operators.OperatorSubscribeOn$SubscribeOnSubscriber.call(:100) at rx.internal.schedulers.CachedThreadScheduler$EventLoopWorker$1.call(:230) at rx.internal.schedulers.ScheduledAction.run(:55) at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:458) at java.util.concurrent.FutureTask.run(FutureTask.java:266) at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:301) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641) at java.lang.Thread.run(Thread.java:764) ä»æ—¥å¿—ä¸­å‘ç°ä¸»çº¿ç¨‹æ­£åœ¨ç­‰å¾… é”&lt;0x0901fb7f&gt; ï¼Œè€Œè¿™ä¸ªé”è¢« tid=35 çš„çº¿ç¨‹æ‰€æŒæœ‰ï¼Œä¸»çº¿ç¨‹æ­£åœ¨åŠ è½½æ’å±å¹¿å‘Šï¼Œè€Œçº¿ç¨‹æ­£åœ¨åˆå§‹åŒ– Admobï¼Œä¹Ÿå°±æ˜¯è¯´åŠ è½½å¹¿å‘Šå’Œå¹¿å‘Šåˆå§‹åŒ–å¹¶è¡Œå¤„ç†ä¼šè§¦å‘æ­»é”ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ­»é”æ˜¯ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æŒæœ‰å¯¹æ–¹éœ€è¦çš„é”é€ æˆçš„ï¼Œä½†æ˜¯ä¸»çº¿ç¨‹é™¤äº†ç­‰å¾… é”&lt;0x0901fb7f&gt; ä¹‹å¤–å¹¶ä¸æŒæœ‰å…¶å®ƒé”ï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯å¸¸è§çš„æ­»é”è¡Œä¸ºã€‚ æ€ä¹ˆå‘ç”Ÿçš„ï¼ˆæºç åˆ†æï¼‰ä¸ºä»€ä¹ˆ WebSettings.getDefaultUserAgent() ä¼šå¯¼è‡´çº¿ç¨‹å¤„äºæ— æ³•è¢«å”¤é†’çš„çŠ¶æ€ï¼Ÿè¿™ä¸ªç­”æ¡ˆï¼Œè¦ä»æºç é‡Œå¯»æ‰¾ã€‚è°ƒç”¨è¿‡ç¨‹æ¶‰åŠåˆ° WebView å†…æ ¸çš„åŠ è½½ä»¥åŠåˆå§‹åŒ–ï¼Œä» Android 7 å¼€å§‹ï¼ŒWebView ä¸å†æ˜¯å†…ç½®çš„ç¨‹åºï¼Œå˜æˆäº†å•ç‹¬çš„ appï¼ˆä½ ä¼šå¼€å‘è€…é€‰é¡¹å†…çœ‹åˆ°æœ‰ä¸ª WebView é€‰é¡¹ï¼‰ï¼ŒåŠ è½½è¿‡ç¨‹ä¹Ÿå˜å¾—å¤æ‚ï¼Œæˆ‘ä»¬åˆ†ä¸¤éƒ¨åˆ†åˆ†æï¼š1. WebViewFactory.getProvider()ï¼ˆåŠ è½½ WebView å†…æ ¸ï¼‰ï¼›2. WebViewFactoryProvider.getStatics()ï¼ˆåˆå§‹åŒ– WebView å†…æ ¸ï¼‰ 123public static String getDefaultUserAgent(Context context) &#123; return WebViewFactory.getProvider().getStatics().getDefaultUserAgent(context);&#125; WebViewSettings.getDefaultUserAgent()ğŸ‘† ä¸»è¦ç±»è¯´æ˜ï¼š WebViewFactoryï¼šä¸»è¦ç”¨äºåˆ›å»º WebViewFactoryProviderWebViewFactoryProviderï¼šWebView æ‰€ç”¨åˆ°çš„ä¸»è¦å¯¹è±¡çš„å®ç°ç±»éƒ½æ˜¯ç”±å®ƒåˆ›å»ºï¼ŒåŒ…æ‹¬ WebView çš„å®ç°WebViewFactoryProvider.Staticsï¼šå› ä¸º WebView ä»¥åŠå®ç°ç±»éƒ½æ˜¯å®ç°äº† WebViewProvider æ¥å£ï¼ŒWebView ä½¿ç”¨çš„ä¸€äº›é™æ€æ–¹æ³•æ— æ³•æ”¾å…¥æ¥å£ï¼Œæ‰€ä»¥éƒ½æ”¶å½’åˆ°è¿™ä¸ªç±»æ¥å®ç° åŠ è½½ WebView å†…æ ¸ä»¥ä¸‹æ˜¯åŠ è½½å†…æ ¸çš„æ—¶åºå›¾ï¼š +---------------------+ +-------------+ +-------------------+ +---------------------------------+ | getUserDefaultAgent | | getProvider | | getProviderClass | | getWebViewContextAndSetProvider | +---------------------+ +-------------+ +-------------------+ +---------------------------------+ | | | | | | | | |------------------------------>| | | | | | | | | | | | |---------------------------------------->| | | | | | | | | | | | |--------------------------->| | | | | | | | Context | | | || | | | | | | | | | | | | | | appendLibAssetForMainAssetPath() | | | | | | |------------------------------------------->| | | | | | | | | | | | | | | redirectResourcesToNewImplLocked() | | | | | | |----------------------------------- | | | | | | | | | | | | | | |","categories":[{"name":"Android","slug":"Android","permalink":"https://dylantseng1915.github.io/categories/Android/"}],"tags":[{"name":"ANR","slug":"ANR","permalink":"https://dylantseng1915.github.io/tags/ANR/"},{"name":"Resources","slug":"Resources","permalink":"https://dylantseng1915.github.io/tags/Resources/"},{"name":"WebView","slug":"WebView","permalink":"https://dylantseng1915.github.io/tags/WebView/"}]},{"title":"è¯¦è§£Androidè§¦æ‘¸äº‹ä»¶å¤„ç†ç¨‹åº","slug":"è¯¦è§£Androidè§¦æ‘¸äº‹ä»¶å¤„ç†ç¨‹åº","date":"2017-01-12T07:30:16.000Z","updated":"2021-02-14T14:01:43.639Z","comments":true,"path":"2017/01/12/cklcih3in0008kyz1fwz53v04/","link":"","permalink":"https://dylantseng1915.github.io/2017/01/12/cklcih3in0008kyz1fwz53v04/","excerpt":"","text":"è¯¦è§£Androidè§¦æ‘¸äº‹ä»¶å¤„ç†ç¨‹åºåœ¨äº†è§£è§¦æ‘¸æ—¶é—´å¤„ç†ç¨‹åºä¹‹å‰ï¼Œæˆ‘ä»¬æ¥äº†è§£è¿™å‡ ä¸ªä¸»è§’ï¼š dispatchTouchEvent(MotionEvent ev)ï¼šæ­¤æ–¹æ³•å…è®¸ ViewGroup åœ¨åˆ†æ´¾ä¹‹å‰æˆªè·æ‰€æœ‰è§¦æ‘¸äº‹ä»¶ onInterceptTouchEvent(MotionEvent ev)ï¼šæ­¤æ–¹æ³•å…è®¸ ViewGroup ç›‘è§†åˆ†æ´¾ç»™å­è§†å›¾çš„äº‹ä»¶ onTouchEvent(MotionEvent ev)ï¼š åœ¨å‘ç”Ÿè§¦æ‘¸å±è¿åŠ¨äº‹ä»¶æ—¶è°ƒç”¨ æ¥ä¸‹æ¥å±•ç¤ºä¸€ä¸‹å·¥ä½œç•Œé¢ï¼Œæ³¨æ„ï¼ŒLayout03æ˜¯åµŒå¥—åœ¨Layout02é‡Œé¢çš„ å›¾1.1å¸ƒå±€æ–‡ä»¶ é¦–å…ˆï¼ŒæŒ‰ä¸‹Layout03ï¼Œäº‹ä»¶æµç¨‹å¦‚å›¾æ‰€ç¤ºï¼š å›¾1.2 æŒ‰ä¸‹çš„æ—¶å€™æ€»å…±æœ‰è§¦å‘ä¸¤ä¸ªäº‹ä»¶ï¼šACTION_DOWNå’ŒACTION_UPï¼Œä½†æ˜¯å› ä¸ºæ•´ä¸ªäº‹ä»¶æµç¨‹ä¸­å¹¶æ²¡æœ‰å“ªä¸ªç»„ä»¶æ¶ˆè´¹äº†ACTION_DOWNäº‹ä»¶ï¼Œè€Œåªæœ‰åœ¨onTouchEventä¸­æ¶ˆè´¹äº†ACTION_DOWNäº‹ä»¶ï¼Œåç»­äº‹ä»¶ACTION_UP,ACTION_MOVEâ€¦æ‰ä¼šè§¦å‘ï¼Œæ‰€ä»¥è¿™é‡ŒACTION_DOWNäº‹ä»¶ä¸€è·¯æŒ¥æ­Œç›´ä¸‹ï¼ŒACTION_UPåˆ™å¹¶æ²¡æœ‰å‘ç”Ÿã€‚ æˆ‘ä»¬è®©Layout02çš„onTouchEventè¿”å›trueï¼Œæ¶ˆè´¹ACTION_DOWNäº‹ä»¶ï¼Œäº‹ä»¶æµç¨‹å¦‚å›¾æ‰€ç¤ºï¼š å›¾1.3 å¯ä»¥çœ‹åˆ°Layout02çš„onTouchEventæ¶ˆè´¹ACTION_DOWNäº‹ä»¶ä¹‹åä¾¿ä¸åœ¨å¾€ä¸‹ä¼ äº†ï¼Œåç»­äº‹ä»¶ä¹Ÿéšåå¼€å§‹å‡ºç°ï¼Œå¹¶ä¸”Layout02ç›´æ¥å°†åç»­äº‹ä»¶æ´¾å‘ç»™æ¶ˆè´¹è€…ã€‚æ‰€ä»¥å½“ä¸€ä¸ªç»„ä»¶æ¶ˆè´¹äº†ACTION_DOWNäº‹ä»¶æ—¶ï¼Œåç»­äº‹ä»¶ä»çª—å£ä¼ åˆ°è¯¥ç»„ä»¶çš„dispatchTouchEventä¹‹åä¾¿ç›´æ¥äº¤ç»™å®ƒçš„onTouchEventæ–¹æ³•å¤„ç† æˆ‘ä»¬åœ¨Layout02çš„onInterceptTouchEventé‡Œè¿”å›trueï¼Œäº‹ä»¶æµç¨‹å¦‚ä¸‹ï¼š å›¾1.4 è¿™æ—¶å€™äº‹ä»¶ä¼ é€’å°±ä¼šå‘ç”Ÿæˆªæ–­çš„æƒ…å†µï¼ŒACTION_DOWNç»è¿‡Layout02çš„onInterceptTouchEventæ—¶è¢«å¼ºåˆ¶ç›´æ¥äº¤ç»™è‡ªå·±çš„onTouchEventç»§ç»­ä¼ é€’ã€‚æ­¤æ—¶å¦‚æœLayout01çš„onTouchEventæ¶ˆè´¹æ­¤äº‹ä»¶ï¼š å›¾1.5 åˆ™åç»­äº‹ä»¶å°±ç›´æ¥ä¼ é€’ç»™Layout01çš„onTouchEventå¤„ç†äº†ï¼Œå¦‚æœè®©Layout02çš„dispatchTouchEventç›´æ¥è¿”å›trueå‘¢ï¼Ÿ å›¾1.6 è¿™ç§æƒ…å†µä¸‹ACTION_DOWNæµç»Layout02çš„dispatchTouchEventæ—¶å°±å¾ˆå¹²è„†çš„æ–­äº†ï¼Œåç»­äº‹ä»¶åœ¨Layout02çš„dispatchTouchEventå°±ç›´æ¥æ´¾å‘ç»™è‡ªå·±çš„onTouchEventå¤„ç†ï¼Œç›¸å½“äºLayout02åœ¨è¯´ï¼šæˆ‘ä¸å¾€ä¸‹æ´¾å‘äº†ï¼Œç›´æ¥äº¤ç»™æˆ‘æ¥å¤„ç†å§ï¼ è¿˜æœ‰äº›æ¯”è¾ƒæç«¯çš„æƒ…å†µï¼šå¦‚æœè®©Layout03çš„onTouchEventæ¥æ¶ˆè´¹ACTION_DOWNäº‹ä»¶ï¼Œåç»­äº‹ä»¶åœ¨æµç»Layout02çš„dispatchTouchEventçš„æ—¶å€™å°±è¿”å›äº†trueå‘¢ï¼Ÿ å›¾1.7 å¦‚å›¾æ‰€ç¤ºï¼Œåç»­äº‹ä»¶åœ¨Layout02çš„dispatchTouchEventå°±æ¶ˆå¤±äº†ï¼Œä¸å†å¾€ä¸‹ä¼ é€’ï¼ŒLayout03ä¹Ÿå°±æ¥æ”¶ä¸åˆ°ACTION_UP,ACTION_MOVEä¹‹ç±»çš„åç»­äº‹ä»¶äº†ã€‚æœ€åï¼Œå¦‚æœä¸åœ¨Layout02çš„dispatchTouchEventè¿”å›trueï¼Œè€Œæ˜¯åœ¨å®ƒçš„onInterceptTouchEventè¿”å›å‘¢ï¼Ÿ å›¾1.8 è¿™æ—¶å€™äº‹ä»¶åˆ°è¾¾Layout02çš„onInterceptTouchEventä¹‹åå°±å˜æˆäº†ACTION_CENCELï¼Œç›´åˆ°ä¼ é€’ç»™æ¶ˆè´¹è€…ã€‚","categories":[{"name":"Android","slug":"Android","permalink":"https://dylantseng1915.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://dylantseng1915.github.io/tags/Android/"}]},{"title":"Android Looperã€Messageã€Handlerã€MessageQueueæºç è§£æ","slug":"Android-Looperã€Messageã€Handlerã€MessageQueueæºç è§£æ","date":"2017-01-12T07:28:07.000Z","updated":"2021-02-14T14:01:43.638Z","comments":true,"path":"2017/01/12/cklcih3i70000kyz1c693gru7/","link":"","permalink":"https://dylantseng1915.github.io/2017/01/12/cklcih3i70000kyz1c693gru7/","excerpt":"","text":"åœ¨Androidå¼€å‘è¿‡ç¨‹ä¸­ï¼ŒMessageå’ŒHandleræ˜¯ç»å¸¸ä¼šä½¿ç”¨åˆ°çš„ç±»ï¼Œæˆ‘ä»¬å¯¹å®ƒä»¬å¹¿æ³›çš„è®¤çŸ¥æ˜¯ä¸ºäº†åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­æ›´æ–°ä¸»çº¿ç¨‹çš„UIï¼Œå› ä¸ºåœ¨ä¸»çº¿ç¨‹å¤„ç†è€—æ—¶çš„ä»»åŠ¡æ˜¯ä¼šANRçš„ã€‚Messageå’ŒHandleræ™®éä½¿ç”¨çš„åœºæ™¯æ˜¯HTTPè¯·æ±‚ï¼ŒHTTPè¯·æ±‚å¯èƒ½ä¼šé€ æˆé•¿æ—¶é—´çš„çº¿ç¨‹é˜»å¡ï¼Œä¸€èˆ¬æ¥è¯´éƒ½æ˜¯æ–°å¼€ä¸€ä¸ªçº¿ç¨‹å¤„ç†è¯·æ±‚ä»»åŠ¡ï¼Œåœ¨æ•°æ®æœ€ç»ˆè¿”å›çš„æ—¶å€™è°ƒç”¨Handlerçš„handlerMessageæ–¹æ³•ï¼Œäº¤ç»™ä¸»çº¿ç¨‹å¤„ç†ï¼Œä½†æ˜¯å®ƒä»¬å†…éƒ¨æ˜¯å¦‚ä½•è¿ä½œçš„å‘¢ï¼Ÿä¸ºäº†ææ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆä»ActivityThreadè¿™ä¸ªmainæ–¹æ³•å¼€å§‹ï¼Œä¸€æ­¥ä¸€æ­¥åˆ†æï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142public static void main(String[] args) &#123; Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"ActivityThreadMain\"); SamplingProfilerIntegration.start(); // CloseGuard defaults to true and can be quite spammy. We // disable it here, but selectively enable it later (via // StrictMode) on debug builds, but using DropBox, not logs. CloseGuard.setEnabled(false); Environment.initForCurrentUser(); // Set the reporter for event logging in libcore EventLogger.setReporter(new EventLoggingReporter()); AndroidKeyStoreProvider.install(); // Make sure TrustedCertificateStore looks in the right place for CA certificates final File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId()); TrustedCertificateStore.setDefaultUserDirectory(configDir); Process.setArgV0(\"&lt;pre-initialized&gt;\"); Looper.prepareMainLooper(); ActivityThread thread = new ActivityThread(); thread.attach(false); if (sMainThreadHandler == null) &#123; sMainThreadHandler = thread.getHandler(); &#125; if (false) &#123; Looper.myLooper().setMessageLogging(new LogPrinter(Log.DEBUG, \"ActivityThread\")); &#125; // End of event ActivityThreadMain. Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); Looper.loop(); throw new RuntimeException(\"Main thread loop unexpectedly exited\");&#125; å°†ç›®å…‰èšç„¦åœ¨å…³é”®éƒ¨åˆ†ï¼Œåœ¨mainæ–¹æ³•é‡Œï¼Œé¦–å…ˆè°ƒç”¨Looperçš„é™æ€æ–¹æ³•prepareMainLooperï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹prepareMainLooperå¹²äº†äº›ä»€ä¹ˆäº‹ï¼Ÿ 123456789public static void prepareMainLooper() &#123; prepare(false); synchronized (Looper.class) &#123; if (sMainLooper != null) &#123; throw new IllegalStateException(\"The main Looper has already been prepared.\"); &#125; sMainLooper = myLooper(); &#125;&#125; éƒ½æ˜¯ä¸€äº›é™æ€è°ƒç”¨ï¼Œæˆ‘ä»¬è¿½è¸ªä¸‹å» 123456private static void prepare(boolean quitAllowed) &#123; if (sThreadLocal.get() != null) &#123; throw new RuntimeException(\"Only one Looper may be created per thread\"); &#125; sThreadLocal.set(new Looper(quitAllowed));&#125; 1234private Looper(boolean quitAllowed) &#123; mQueue = new MessageQueue(quitAllowed); mThread = Thread.currentThread();&#125; sThreadLocalè¿™ä¸ªé™æ€å˜é‡æ˜¯ä»€ä¹ˆï¼Ÿå®ƒçš„å£°æ˜å’Œåˆå§‹åŒ–æ˜¯è¿™æ ·çš„ï¼š 1static final ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;(); ThreadLocalè¿™ä¸ªç±»ä»å­—é¢æ„æ€å°±åº”è¯¥çŒœå¾—å‡ºæ¥ï¼Œå®ƒå¯ä»¥ä¿å­˜æœ¬åœ°çº¿ç¨‹å˜é‡ï¼Œä¸å—å…¶ä»–çº¿ç¨‹çš„å¹²æ‰°ã€‚é‚£ä¹ˆï¼Œæ„æ€å°±å¾ˆæ˜ç¡®äº†ï¼ŒprepareMainLooper()æ–¹æ³•é¦–å…ˆæ£€æŸ¥æœ¬åœ°å˜é‡æ˜¯å¦ä¿å­˜æœ‰å€¼ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æŠ›å¼‚å¸¸é€€å‡ºï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±æ–°å»ºä¸€ä¸ªLooperå®ä¾‹ï¼Œä½œä¸ºçº¿ç¨‹å”¯ä¸€å‰¯æœ¬ä¿å­˜åœ¨ThreadLocalä¹‹ä¸­ï¼ŒLooperåœ¨å®ä¾‹åŒ–æ—¶ï¼Œåˆå§‹åŒ–äº†ä¸€ä¸ªMessageQueueå¯¹è±¡ï¼Œè€Œè¿™ä¸ªMessageQueueå¯¹è±¡ï¼Œå°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ã€‚å‰©ä¸‹çš„sMainLooper = myLooper()å¾ˆç®€å•ï¼Œå°±æ˜¯å°†çº¿ç¨‹å”¯ä¸€Looperå®ä¾‹å˜é‡å‰¯æœ¬èµ‹å€¼ç»™sMainLooperå˜é‡ã€‚æ¥ä¸‹æ¥æœ‰ä¸€å¥ç¥å¥‡çš„ä»£ç ï¼š 123if (false) &#123; Looper.myLooper().setMessageLogging(new LogPrinter(Log.DEBUG, \"ActivityThread\"));&#125; ä¸€è„¸æ‡µé€¼ ä»€ä¹ˆé¬¼ï¼Ÿï¼ï¼è¿™å¥ä»£ç æœ‰ä»€ä¹ˆç‰¹æ®Šçš„è€ƒé‡å—ï¼Ÿï¼ï¼ï¼æˆ‘åªèƒ½è®¤ä¸ºGoogle developerä»¬è°ƒè¯•åå¿˜äº†åˆ æ‰è¿™æ®µä»£ç äº† æœ€åå°±è°ƒç”¨Looper.loop()æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯é‡å¤´æˆï¼ 123456789101112131415161718192021222324252627282930313233343536373839404142434445public static void loop() &#123; final Looper me = myLooper(); if (me == null) &#123; throw new RuntimeException(\"No Looper; Looper.prepare() wasn't called on this thread.\"); &#125; final MessageQueue queue = me.mQueue; // Make sure the identity of this thread is that of the local process, // and keep track of what that identity token actually is. Binder.clearCallingIdentity(); final long ident = Binder.clearCallingIdentity(); for (;;) &#123; Message msg = queue.next(); // might block if (msg == null) &#123; // No message indicates that the message queue is quitting. return; &#125; // This must be in a local variable, in case a UI event sets the logger Printer logging = me.mLogging; if (logging != null) &#123; logging.println(\"&gt;&gt;&gt;&gt;&gt; Dispatching to \" + msg.target + \" \" + msg.callback + \": \" + msg.what); &#125; msg.target.dispatchMessage(msg); if (logging != null) &#123; logging.println(\"&lt;&lt;&lt;&lt;&lt; Finished to \" + msg.target + \" \" + msg.callback); &#125; // Make sure that during the course of dispatching the // identity of the thread wasn't corrupted. final long newIdent = Binder.clearCallingIdentity(); if (ident != newIdent) &#123; Log.wtf(TAG, \"Thread identity changed from 0x\" + Long.toHexString(ident) + \" to 0x\" + Long.toHexString(newIdent) + \" while dispatching to \" + msg.target.getClass().getName() + \" \" + msg.callback + \" what=\" + msg.what); &#125; msg.recycleUnchecked(); &#125;&#125; è¿™å—ä»£ç ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œé¦–å…ˆä»æœ¬åœ°çº¿ç¨‹ä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹å–å‡ºä¿å­˜åœ¨ThreadLocalé‡Œçš„Looperå¯¹å®ä¾‹ï¼Œç„¶åä»Looperé‡Œå–å‡ºMessageQueueå®ä¾‹ï¼Œç„¶å..ç„¶åâ€¦æ²¡é”™ï¼ä½ æ²¡æœ‰çœ‹é”™ï¼ï¼å°±å¼€å§‹æ­»å¾ªç¯äº†â€¦ç„¶åä½ ä¼šå‘ç°ï¼Œ**Androidä¸»çº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œè¿™ä¸ªæ­»å¾ªç¯å‘ç”Ÿåœ¨Looperå†…éƒ¨ï¼Œä½ ä¹Ÿå¯ä»¥è®¤ä¸ºLooperå°±æ˜¯è¿™ä¸ªæ­»å¾ªç¯ï¼Œå®ƒä¸æ–­çš„ä»MessageQueueå–å‡ºMessageï¼Œç„¶åæ‰§è¡Œå¤„ç†ï¼Œæœ€åå›æ”¶Message**ï¼ŒAndroidçš„ä¸»çº¿ç¨‹å°±æ˜¯è¿™ä¸ªç®€å•ï¼Œç°åœ¨ä½ ä¹Ÿåº”è¯¥çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ä»¬å¿…é¡»è¦äº†è§£Looperã€Messageã€Handlerå’ŒMessageQueueï¼Œä»¥åŠé€å½»ä»–ä»¬çš„å·¥ä½œæœºåˆ¶äº†å§ã€‚é‚£ä¹ˆï¼ŸActivity,Service,Intent,BroadcastReceiverçš„åŠ¨ä½œæ˜¯å¦‚ä½•æœ€ç»ˆå˜æˆHandlerå’ŒMessageçš„å‘¢ï¼Ÿè¿™æ˜¯ä¸€ä¸ªå¤§å‘ï¼Œä»¥åå†å¡«ï¼Œå…ˆæŠ›ä¸‹è¿™ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹è¿™ä¸‰ä¸ªæ–¹æ³•ï¼š ä¸æ–­ä»MessageQueueå–å‡ºMessageçš„æ–¹æ³•ï¼š 1Message msg = queue.next(); æ‰§è¡Œå¤„ç†Messageçš„æ–¹æ³•ï¼š 1msg.target.dispatchMessage(msg); å›æ”¶Messageçš„æ–¹æ³•ï¼š 1msg.recycleUnchecked(); ç¬¬ä¸€ä¸ªæ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬å…ˆè§£ææ‰§è¡Œå¤„ç†Messageçš„æ–¹æ³•msg.target.dispatchMessage(Message msg)ã€‚msg.targetå˜é‡æ˜¯ä¸ªHandlerå¯¹è±¡ï¼Œå®ƒä»ä½•è€Œæ¥å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜è¿˜å¾—ä»æˆ‘ä»¬å‘é€ä¸€ä¸ªMessageå¼€å§‹è¯´èµ·ã€‚ é€šå¸¸æˆ‘ä»¬å‘é€ä¸€ä¸ªMessageæ˜¯é…±ç´«çš„ï¼š 123456789Handler handler = new Handler()&#123; @Override public void handleMessage(Message msg) &#123; super.handleMessage(msg); // do something &#125;&#125;;Message message = handler.obtainMessage();handler.sendMessage(message); è¿›å…¥Handler.obtainMessage()æ–¹æ³•ï¼š 1234public final Message obtainMessage()&#123; return Message.obtain(this);&#125; Google Coderçš„å¼€å‘äººå‘˜æœ‰ç²¾ç¥åˆ†è£‚ä¹ˆï¼Ÿè¿™èŠ±æ‹¬å·â€¦ å†è¿›å…¥Message.obtain(Handler handler)æ–¹æ³•ï¼š 123456public static Message obtain(Handler h) &#123; Message m = obtain(); m.target = h; return m;&#125; å¥½å§ï¼ŒåŸæ¥targetå˜é‡å°±æ˜¯Handler.obtainMessage()è¿™ä¸ªHandlerå¯¹è±¡ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¤§è‡´æ˜ç™½äº†ï¼ŒMessageQueueå¾ªç¯å–å‡ºMessageï¼Œæ¯ä¸ªMessageéƒ½å¸¦ç€ä¸€ä¸ªHandlerï¼Œç”±Handlerçš„dispatchMessage(Message msg)æ¥å¤„ç†è¯¥æ¶ˆæ¯ã€‚è¾£ä¹ˆï¼ŒHandlerå¦‚ä½•å¤„ç†è¿™ä¸ªæ¶ˆæ¯çš„å‘¢ï¼Ÿ æ¥çœ‹çœ‹dispatchMessage(Message msg)æ–¹æ³•ï¼š 123456789101112public void dispatchMessage(Message msg) &#123; if (msg.callback != null) &#123; handleCallback(msg); &#125; else &#123; if (mCallback != null) &#123; if (mCallback.handleMessage(msg)) &#123; return; &#125; &#125; handleMessage(msg); &#125;&#125; ä»æºç ä¸­å¯ä»¥çœ‹å‡ºæœ€ç»ˆæ‰§è¡Œçš„åœ°æ–¹æœ‰ä¸‰å¤„ï¼Œå…ˆåä¸ºï¼šmsg.callback, mCallback.handleMessage(msg)å’ŒhandleMessage(msg)ã€‚handleMessage(msg)å¥½ç†è§£ï¼Œå› ä¸ºé€šå¸¸æˆ‘ä»¬éƒ½æ˜¯å¤å†™Handlerçš„handleMessage(Message msg)æ¥å®ç°æˆ‘ä»¬æ›´æ–°ä¸»çº¿ç¨‹UIçš„é€»è¾‘ï¼Œå¦å¤–ä¸¤ä¸ªå°±æ¯”è¾ƒé™Œç”Ÿäº†ï¼Œæˆ‘ä»¬ä¸€ä¸€è§£æã€‚ msg.callbackèµ‹å€¼çš„åœ°æ–¹åœ¨ä¸¤å¤„ï¼š 123456789101112private static Message getPostMessage(Runnable r) &#123; Message m = Message.obtain(); m.callback = r; return m;&#125;private static Message getPostMessage(Runnable r, Object token) &#123; Message m = Message.obtain(); m.obj = token; m.callback = r; return m;&#125; getPostMessage(Runnable r)å’ŒgetPostMessage(Runnable r, Object token)è¿™ä¸ªä¸¤ä¸ªæ–¹æ³•åˆæ˜¯åˆ†åˆ«åœ¨è¿™äº›åœ°æ–¹è°ƒç”¨: 1234567891011121314151617181920public final boolean post(Runnable r)&#123; return sendMessageDelayed(getPostMessage(r), 0);&#125;public final boolean postAtTime(Runnable r, long uptimeMillis)&#123; return sendMessageAtTime(getPostMessage(r), uptimeMillis);&#125;public final boolean postAtTime(Runnable r, Object token, long uptimeMillis)&#123; return sendMessageAtTime(getPostMessage(r, token), uptimeMillis);&#125;public final boolean postDelayed(Runnable r, long delayMillis)&#123; return sendMessageDelayed(getPostMessage(r), delayMillis);&#125; æœ‰æ²¡æœ‰ç†Ÿæ‚‰çš„æ„Ÿè§‰ï¼Ÿæ²¡é”™ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„å‘é€æ›´æ–°ä¸»çº¿ç¨‹UIæ¶ˆæ¯çš„ä¸€ç§æ–¹å¼ï¼š 123456new Handler().post(new Runnable() &#123; @Override public void run() &#123; // do something &#125;&#125;); post(Runnable r)ã€postAtTime(Runnable r, long uptimeMillis)ã€sendMessageDelayed(Message, delayMillis)â€¦â€¦è¾£ä¹ˆå¤šæ–¹æ³•ï¼Œä¼šä¸ä¼šè¢«ææ™•äº†ï¼Ÿ ä¸€è„¸æ‡µé€¼ æˆ‘ä»¬ç”¨ä¸€å¼ å›¾æ¥æ¢³ç†ä¸€ä¸‹è¿™äº›æ–¹æ³• æ©ï¼Œè¿™ä¸‹æ¸…æ¥šå¤šäº†ã€‚ æ¥ä¸‹æ¥æœç´¢ä¸€ä¸‹mCallbackçš„å‡ºå¤„ï¼Œå…¶å®å®ƒæ˜¯åœ¨Handlerç±»çš„æ„é€ å‡½æ•°é‡Œè¢«èµ‹å€¼çš„ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public Handler() &#123; this(null, false);&#125;public Handler(Callback callback) &#123; this(callback, false);&#125;public Handler(Looper looper) &#123; this(looper, null, false);&#125;public Handler(Looper looper, Callback callback) &#123; this(looper, callback, false);&#125;public Handler(boolean async) &#123; this(null, async);&#125;public Handler(Callback callback, boolean async) &#123; if (FIND_POTENTIAL_LEAKS) &#123; final Class&lt;? extends Handler&gt; klass = getClass(); if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp; (klass.getModifiers() &amp; Modifier.STATIC) == 0) &#123; Log.w(TAG, \"The following Handler class should be static or leaks might occur: \" + klass.getCanonicalName()); &#125; &#125; mLooper = Looper.myLooper(); if (mLooper == null) &#123; throw new RuntimeException( \"Can't create handler inside thread that has not called Looper.prepare()\"); &#125; mQueue = mLooper.mQueue; mCallback = callback; mAsynchronous = async;&#125;public Handler(Looper looper, Callback callback, boolean async) &#123; mLooper = looper; mQueue = looper.mQueue; mCallback = callback; mAsynchronous = async;&#125; ç”¨å›¾è¡¨æ¢³ç†ä¸€ä¸‹å®ƒä»¬ä¹‹é—´ä¸ªå…³ç³»ï¼š ä»å›¾ä¸­å°±å¾ˆæ˜æ˜¾çš„çœ‹å‡º7ä¸ªæ„é€ æ–¹æ³•åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯é»˜è®¤ä½¿ç”¨æœ¬åœ°çº¿ç¨‹çš„Looperå¯¹è±¡ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯éœ€è¦ä¼ å…¥ä¸€ä¸ªLooperå¯¹è±¡ï¼Œä¸¤éƒ¨åˆ†ä½ éƒ½å¯ä»¥ä¼ å…¥ä¸€ä¸ªCallbackå›è°ƒï¼Œå®ƒçš„å®šä¹‰æ˜¯åœ¨Handlerç±»å†…éƒ¨ä¹‹ä¸­ï¼š 123public interface Callback &#123; public boolean handleMessage(Message msg);&#125; æ‰€ä»¥æ‰ä¼šæœ‰mCallback.handleMessage(msg)çš„è°ƒç”¨ã€‚æ‰€ä»¥ä½ çš„Handlerå®ä¾‹å¯ä»¥è¿™æ ·å®ä¾‹åŒ–ï¼š 123456new Handler(new Handler.Callback() &#123; @Override public boolean handleMessage(Message msg) &#123; return false; &#125;&#125;); è·Ÿ 123456new Handler().post(new Runnable() &#123; @Override public void run() &#123; // do something &#125;&#125;); å…¶å®æ˜¯ä¸€ä¸ªé“ç†ã€‚ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ææ‡‚äº†æ¶ˆæ¯æ˜¯å¦‚ä½•è¢«å¤„ç†çš„â€”â€”å®ƒæ˜¯ç”±Handlerä¸‰ä¸ªéƒ¨åˆ†ï¼šRunnable Callbackï¼ŒCallback Functionä»¥åŠHandler Default handleMessage Methodå…¶ä¸­ä¹‹ä¸€å¤„ç†çš„ã€‚ç°åœ¨æˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹çœ‹æ¶ˆæ¯æ˜¯å¦‚ä½•ä»MessageQueueå–å‡ºæ¥çš„ï¼Œä½†é¦–å…ˆæˆ‘ä»¬å¾—çŸ¥é“ï¼ŒMessageæ˜¯å¦‚ä½•ä¼ å…¥é˜Ÿåˆ—çš„ã€‚ç”±ä¸Šé¢å‘é€æ¶ˆæ¯æ–¹æ³•çš„å…³ç³»å›¾å¯æ˜¯çŸ¥é“ï¼Œæ— è®ºä½ æ˜¯é€‰æ‹©å“ªä¸€ç§æ–¹å¼å‘é€æ¶ˆæ¯ï¼Œæœ€ç»ˆå®ƒéƒ½ä¼šè°ƒç”¨enqueueMessage(MessageQueue, Message, long)æ–¹æ³•æ”¾å…¥é˜Ÿåˆ—ï¼š 1234567private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) &#123; msg.target = this; if (mAsynchronous) &#123; msg.setAsynchronous(true); &#125; return queue.enqueueMessage(msg, uptimeMillis);&#125; å†è¿›å…¥MessageQueueçš„enqueueMessage(Message, long)æ–¹æ³•çœ‹çœ‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253boolean enqueueMessage(Message msg, long when) &#123; if (msg.target == null) &#123; throw new IllegalArgumentException(\"Message must have a target.\"); &#125; if (msg.isInUse()) &#123; throw new IllegalStateException(msg + \" This message is already in use.\"); &#125; synchronized (this) &#123; if (mQuitting) &#123; IllegalStateException e = new IllegalStateException( msg.target + \" sending message to a Handler on a dead thread\"); Log.w(TAG, e.getMessage(), e); msg.recycle(); return false; &#125; msg.markInUse(); msg.when = when; Message p = mMessages; boolean needWake; if (p == null || when == 0 || when &lt; p.when) &#123; // New head, wake up the event queue if blocked. msg.next = p; mMessages = msg; needWake = mBlocked; &#125; else &#123; // Inserted within the middle of the queue. Usually we don't have to wake // up the event queue unless there is a barrier at the head of the queue // and the message is the earliest asynchronous message in the queue. needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous(); Message prev; for (;;) &#123; prev = p; p = p.next; if (p == null || when &lt; p.when) &#123; break; &#125; if (needWake &amp;&amp; p.isAsynchronous()) &#123; needWake = false; &#125; &#125; msg.next = p; // invariant: p == prev.next prev.next = msg; &#125; // We can assume mPtr != 0 because mQuitting is false. if (needWake) &#123; nativeWake(mPtr); &#125; &#125; return true;&#125; ä»£ç æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬ä»msg.when = whenè¿™ä¸€æ®µå¼€å§‹è¯»èµ·ï¼Œç¬¬ä¸€ä¸ªé—®é¢˜å°±æ¥äº†ï¼ŒmMessageæ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿå®ƒçš„å˜é‡å£°æ˜å…¶å®æ˜¯ä¸ªMessageå¯¹è±¡ï¼Œå®ƒæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿå¾€ä¸‹çœ‹ï¼Œæœ‰ä¸ªæ³¨é‡Šæš—ç¤ºäº†å®ƒçš„ä½œç”¨â€”â€”New head, wake up the event queue if blocked.**æ„æ€å°±ä¸è¨€è€Œå–»äº†ï¼ŒmMessageå°±æ˜¯MessageQueueæ¶ˆæ¯é˜Ÿåˆ—çš„é˜Ÿåˆ—å¤´**ï¼Œå¾€ä¸‹çœ‹æ¥ä¸‹æ¥çš„åˆ¤æ–­è¯­å¥ï¼š 123456if (p == null || when == 0 || when &lt; p.when) &#123; // New head, wake up the event queue if blocked. msg.next = p; mMessages = msg; needWake = mBlocked;&#125; é¦–å…ˆæˆ‘ä»¬å¾—çŸ¥é“ï¼Œæ¯ä¸ªMessageéƒ½æ˜¯æœ‰è‡ªå·±çš„å¤„ç†æ—¶é—´çš„â€”â€”whenå±æ€§ï¼Œè¿™ä¸ªwhenå±æ€§å†³å®šäº†è¿™ä¸ªMessageåœ¨MessageQueueçš„ä½ç½®(Messageæ˜¯æ ¹æ®whenæ¥æ’åˆ—çš„)ä»¥åŠå¤„ç†çš„è§„å®šæ—¶é—´ç‚¹ï¼Œä½†æ˜¯æœ‰ç§Messageä¾‹å¤–ï¼Œå®ƒçš„whenå±æ€§æ˜¯0ï¼Œç”±Handler.sendMessageAtFrontOfQueue(Message)å‘é€ï¼Œä»è¿™ä¸ªæ–¹æ³•çš„å‘½åå°±å¯ä»¥çŸ¥é“å®ƒçš„æ„å›¾â€”â€”å¸Œæœ›è¿™ä¸ªMessageæ’åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œä¹Ÿå°±æ˜¯å¸Œæœ›è¿™ä¸ªæ¶ˆæ¯èƒ½å¤Ÿç«‹åˆ»å¤„ç†ã€‚é‚£ä¹ˆè¿™ä¸ªåˆ¤æ–­è¯­å¥æˆ‘ä»¬ä¹Ÿåº”è¯¥çŸ¥é“å®ƒçš„æ„æ€äº†ï¼šå¦‚æœé˜Ÿåˆ—å¤´ä¸ºç©ºæˆ–è€…whenä¸º0æˆ–è€…éœ€è¦å¤„ç†çš„æ—¶é—´æ¯”é˜Ÿå¤´çš„æ—¶é—´è¿˜è¦ç´§è¿«ï¼Œåˆ™å°†è¿™ä¸ªMessageä½œä¸ºæ–°çš„é˜Ÿå¤´ã€‚ enqueue MessageQueue header 00 enqueue MessageQueue header 01 enqueue MessageQueue header 02 å†çœ‹çœ‹elseè¯­å¥ï¼Œå›¾æˆ‘ä¹Ÿä¸ç”»äº†ï¼Œæ„æ€ä¹Ÿç®€å•ï¼Œä»é˜Ÿå¤´å¾€åéå†Messageï¼Œæ ¹æ®whenå€¼å°†æ–°çš„Messageæ’å…¥åˆ°åˆé€‚çš„ä½ç½®ã€‚ çœ‹å®Œäº†MessageQueue.enqueueMessage(Message, long)æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ¢è®¨ä¸€ä¸‹Messageæ˜¯å¦‚ä½•ä»MessageQueueå–å‡ºæ¥çš„äº†ï¼Œçœ‹æºç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455Message next() &#123; final long ptr = mPtr; if (ptr == 0) &#123; return null; &#125; int pendingIdleHandlerCount = -1; int nextPollTimeoutMillis = 0; for (;;) &#123; if (nextPollTimeoutMillis != 0) &#123; Binder.flushPendingCommands(); // é˜»å¡çš„æ—¶é—´å¯èƒ½å¾ˆé•¿,ç¡®ä¿åœ¨æ­¤æœŸé—´é‡Šæ”¾æ¸²æŸ“å¯¹è±¡çš„å¼•ç”¨,ä»¥å…å ç”¨ç©ºé—´ &#125; nativePollOnce(ptr, nextPollTimeoutMillis); // è½®è¯¢, é˜»å¡ synchronized (this) &#123; // å°è¯•æ£€ç´¢ä¸‹ä¸€ä¸ªMessage final long now = SystemClock.uptimeMillis(); Message prevMsg = null; Message msg = mMessages; if (msg != null &amp;&amp; msg.target == null) &#123; // Stalled by a barrier. Find the next asynchronous message in the queue. // msg.targetä¸ºç©ºçš„æƒ…å†µæˆ‘ä¸çŸ¥é“, do-whileè¯­å¥æ˜¯å¯»æ‰¾ä¸‹ä¸€ä¸ªå¯å¼‚æ­¥æ‰§è¡Œçš„Message do &#123; prevMsg = msg; msg = msg.next; &#125; while (msg != null &amp;&amp; !msg.isAsynchronous()); &#125; if (msg != null) &#123; if (now &lt; msg.when) &#123; // ä¸‹ä¸€ä¸ªMessageçš„å¯æ‰§è¡Œæ—¶é—´ç‚¹æœªåˆ°, è¿™ä¸ªMessageæœ‰ä¸¤ç§,ä¸€ä¸ªæ˜¯é˜Ÿå¤´Message, å¦ä¸€ä¸ªæ˜¯ä¸‹ä¸€ä¸ªå¯å¼‚æ­¥æ‰§è¡Œçš„Message nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE); &#125; else &#123; // å¾—åˆ°ä¸€ä¸ªMessage,å¦‚æœæ˜¯å¾—åˆ°å¯å¼‚æ­¥æ‰§è¡Œçš„Message, prevMsg.next -&gt; msg.next, return msg // å¦‚æœæ˜¯è¡¨å¤´,å°†mMessageæŒ‡å‘ä¸‹ä¸€ä¸ªMessage, return msg mBlocked = false; if (prevMsg != null) &#123; prevMsg.next = msg.next; &#125; else &#123; mMessages = msg.next; &#125; msg.next = null; if (DEBUG) Log.v(TAG, \"Returning message: \" + msg); msg.markInUse(); return msg; &#125; &#125; else &#123; // No more messages. nextPollTimeoutMillis = -1; &#125; ... &#125; ... &#125;&#125; æ— å…³ï¼ˆçœ‹ä¸æ‡‚çš„ï¼‰çš„ä»£ç æˆ‘ç”¨çœç•¥å·ä»£æ›¿äº†ï¼Œå…³é”®éƒ¨åˆ†çš„ä»£ç çš„æ„æ€æˆ‘å†™åœ¨æ³¨é‡Šä¸­ã€‚åˆ°è¿™é‡Œï¼ŒMessageQueueå¦‚ä½•å»é™¤Messageçš„ä¹Ÿå·²ç»è®²è§£å®Œäº†ï¼Œè¯´ç™½äº†ï¼Œå°±æ˜¯ä¸€ä¸ªé˜Ÿåˆ—çš„è¿ç”¨è€Œå·²ã€‚æœ€åï¼Œæ‰“èµ·ç²¾ç¥ï¼Œå’¬ä¸‹æœ€åä¸€æ ¹ç¡¬éª¨å¤´ï¼ŒMessage.recycleUnchecked() 1234567891011121314151617181920212223void recycleUnchecked() &#123; // Mark the message as in use while it remains in the recycled object pool. // Clear out all other details. flags = FLAG_IN_USE; what = 0; arg1 = 0; arg2 = 0; obj = null; replyTo = null; sendingUid = -1; when = 0; target = null; callback = null; data = null; synchronized (sPoolSync) &#123; if (sPoolSize &lt; MAX_POOL_SIZE) &#123; next = sPool; sPool = this; sPoolSize++; &#125; &#125;&#125; è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œåªæ˜¯ä¸€äº›æ¸…ç©ºæ•°æ®çš„ä»£ç è€Œå·²ï¼Œä½†æ˜¯æ³¨æ„åˆ°ä¸€ä¸ªé™æ€å˜é‡æ²¡æœ‰â€”â€”sPoolï¼Œè¿™æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿå®ƒçš„å˜é‡å£°æ˜ä¹Ÿæ˜¯ä¸€ä¸ªMessageå¯¹è±¡ï¼Œå®ƒæ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿè§£ç­”ç–‘æƒ‘çš„åœ°æ–¹åœ¨Messageçš„é™æ€æ–¹æ³•obtainé‡Œï¼š 12345678910111213public static Message obtain() &#123; synchronized (sPoolSync) &#123; if (sPool != null) &#123; Message m = sPool; sPool = m.next; m.next = null; m.flags = 0; // clear in-use flag sPoolSize--; return m; &#125; &#125; return new Message();&#125; ä¸ç®¡æ˜¯Handler.obtainMessageæ–¹æ³•ï¼Œè¿˜æ˜¯Messageå¦å¤–å‡ ä¸ªobtainæ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šé€šè¿‡è°ƒç”¨Message.obtain()è¿™ä¸ªæ— å‚é™æ€æ–¹æ³•ï¼Œå®ƒçš„ä»£ç ä¹Ÿå‘Šè¯‰äº†æˆ‘ä»¬sPoolçš„ä½œç”¨ï¼Œå®ƒç›¸å½“äºæŒ‡å‘ä¸€ä¸ªæ ˆçš„æ ˆé¡¶ï¼Œæ¯æ¬¡ä½¿ç”¨åçš„Messageå®ä¾‹éƒ½ä¼šå‹å…¥è¿™ä¸ªæ ˆä¸­ï¼Œæ¯æ¬¡ä½¿ç”¨æˆ–é—´æ¥ä½¿ç”¨Message.obtain()æ–¹æ³•éƒ½ä¼šä»æ ˆä¸­å¼¹å‡ºä¸€ä¸ªMessageå®ä¾‹ï¼Œä»¥ä¾¿åšåˆ°å¾ªç¯ä½¿ç”¨ï¼Œå¦‚æœä¸è¿™æ ·å­ï¼Œè¿™ä¸ªæ ˆå°±ä¼šæ— é™å¢åŠ Messageå®ä¾‹ï¼Œé€ æˆå†…å­˜æ³„éœ²ï¼Œç”šè‡³å†…å­˜æº¢å‡ºï¼Œè¿™ä¸€ç‚¹åœ¨å¼€å‘çš„æ—¶å€™è¦æ³¨æ„ã€‚ æœ€åæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ç ”ç©¶æˆæœï¼š Looper: å®ƒæ˜¯æ•´ä¸ªè¿ä½œçš„åœºæ™¯ï¼Œå®ƒåœ¨ä¸»çº¿ç¨‹ä¸­æœ‰å”¯ä¸€å®ä¾‹ï¼Œå®ƒå†…éƒ¨æœ‰å”¯ä¸€çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”±å®ƒå¯¹æ•´ä¸ªè¿ä½œè¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸”è°ƒç”¨loop()æ–¹æ³•å¼€å§‹å¾ªç¯ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–æ¶ˆæ¯ï¼Œå¤„ç†æ¶ˆæ¯ï¼Œå›æ”¶æ¶ˆæ¯ã€‚ MessageQueue: å®ƒç›¸å½“äºä¸€ä¸ªé˜Ÿåˆ—å®¹å™¨ï¼Œç”±å®ƒæ¥æ”¶æ–°çš„æ¶ˆæ¯ï¼Œåœ¨æ¥æ”¶çš„æ—¶å€™ä¼šä¾ç…§æ¶ˆæ¯æŒ‡å®šçš„å¤„ç†æ—¶é—´ç‚¹é€‚å½“çš„æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œåœ¨å–å‡ºçš„æ—¶å€™å¯èƒ½ä¼šå› ä¸ºä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶é—´ç‚¹æœªåˆ°è€Œé˜»å¡ã€‚ Message: å®ƒæ˜¯ä¸€ä¸ªæ¶ˆæ¯ï¼Œå®ƒç”±æŒ‡å®šå¤„ç†æ—¶é—´ç‚¹ã€è¾…åŠ©å¤„ç†çš„æ•°æ®ä»¥åŠå¤„ç†å¯¹è±¡ç­‰å…ƒç´ ç»„æˆã€‚ Handler: å®ƒæ˜¯æŸä¸ªæ¶ˆæ¯çš„æ¶ˆæ¯å¤„ç†è€…ï¼Œå®ƒå¤„ç†æ¶ˆæ¯çš„æ–¹å¼æœ‰ä¸‰ç§ï¼Œä½†åªèƒ½æ˜¯å…¶ä¸­ä¹‹ä¸€å¤„ç†ï¼Œå®ƒä»¬ä¾æ¬¡æ˜¯Runnableçš„run()æ–¹æ³•ï¼ŒHandlerçš„å†…éƒ¨ç±»Callbackçš„handleMessage(Message)æ–¹æ³•ä»¥åŠHandlerçš„é»˜è®¤æ–¹æ³•handleMessage(Message)","categories":[{"name":"Android","slug":"Android","permalink":"https://dylantseng1915.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://dylantseng1915.github.io/tags/Android/"},{"name":"Looper","slug":"Looper","permalink":"https://dylantseng1915.github.io/tags/Looper/"},{"name":"Message","slug":"Message","permalink":"https://dylantseng1915.github.io/tags/Message/"},{"name":"Handler","slug":"Handler","permalink":"https://dylantseng1915.github.io/tags/Handler/"},{"name":"MessageQueue","slug":"MessageQueue","permalink":"https://dylantseng1915.github.io/tags/MessageQueue/"}]},{"title":"èŠèŠAndroid Themeçš„é‚£äº›äº‹","slug":"èŠèŠAndroid-Themeçš„é‚£äº›äº‹","date":"2017-01-12T07:26:50.000Z","updated":"2021-02-14T14:01:43.639Z","comments":true,"path":"2017/01/12/cklcih3im0007kyz12imnfi41/","link":"","permalink":"https://dylantseng1915.github.io/2017/01/12/cklcih3im0007kyz12imnfi41/","excerpt":"","text":"1. æ¦‚è¿°è¯è¯´Androidé‡Œé¢çš„ä¸»é¢˜çœŸæ˜¯ç³ç…æ»¡ç›®ï¼Œè™½ç„¶å¹³æ—¶å¼€å‘æ—¶æˆ‘ä»¬éƒ½æ˜¯å›ºå®šï¼Œçº¦å®šæˆç†Ÿçš„ä½¿ç”¨æŸä¸ªä¸»é¢˜ï¼Œä¾‹å¦‚å®˜æ–¹æ¨èçš„AppComatç³»åˆ—ï¼Œä½†æ˜¯Androidæœ‰å¤šå°‘ä¸»é¢˜ï¼Œå®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆè”ç³»å’ŒåŒºåˆ«å¾ˆå°‘äººå»è®¤çœŸæ¢ç©¶ã€‚æˆ‘æœ¬äººå¼€å‘æ—¶éƒ½æ˜¯ç›´æ¥ä½¿ç”¨Android Studioç”Ÿæˆçš„ä¸»é¢˜ï¼Œæˆ–è€…æ˜¯ç»§æ‰¿è‡³å®ƒã€‚Holoä¸»é¢˜åŸºæœ¬æ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œä¼¼ä¹æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€çš„ä¸»é¢˜ï¼Œæ¯”æˆ‘æ—©æ¥è§¦Androidçš„å‰è¾ˆä»¬åº”è¯¥æ¯”è¾ƒç†Ÿæ‚‰ã€‚Materialä¸»é¢˜å°±å±äºæ¯”è¾ƒæ–°çš„ä¸»é¢˜ã€‚è¿˜æœ‰å‘¢ï¼Ÿ 2. ä¸€äº›ä¸»è¦çš„æ ¹ä¸»é¢˜ä»¥åŠå®ƒçš„ç»§æ‰¿ç»“æ„è¿™é‡Œæˆ‘ä½¿ç”¨äº†â€œæ ¹ä¸»é¢˜â€çš„è¯´æ³•ï¼Œå› ä¸ºå¤§å¤šæ•°ä¸»é¢˜éƒ½æ˜¯ç»§æ‰¿è‡³æŸä¸ªä¸»é¢˜ï¼Œè¿½æ ¹ç©¶åº•ï¼Œä¼šæ‰¾åˆ°å‡ ä¸ªæ²¡æœ‰parentçš„æ ¹ä¸»é¢˜ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹è¿™å‡ ä¸ªæ ¹ä¸»é¢˜ï¼š Themeï¼šAPI 10åŠå…¶ä»¥ä¸‹çš„é»˜è®¤ä¸»é¢˜ã€‚ Theme.Holoï¼šAPI 11 - 13çš„é»˜è®¤ä¸»é¢˜ï¼Œ Theme.Materialï¼šAPI 21åŠå…¶ä»¥ä¸Šã€‚ 2.1 å¦‚ä½•è¿½æº¯åˆ°è¿™äº›Themeï¼Ÿä½ å¯ä»¥éšä¾¿æ–°å»ºä¸€ä¸ªThemeï¼Œparentç»§æ‰¿è‡³Theme.AppCompatï¼ŒæŒ‰ä½Ctrl(åœ¨Macä¸Šæ˜¯Command)ç‚¹å‡»parentä¸»é¢˜ï¼Œè¿™æ ·ä¸€ç›´è¿½æº¯åˆ°Platform.AppComatä¼šæœ‰å‡ ä¸ªé€‰æ‹©ï¼š platform version list åˆ°è¿™é‡Œï¼ŒThemeçš„ç»§æ‰¿å°±åŒºåˆ«å¼€æ¥äº†ï¼Œ/values.xmlæœ€ç»ˆä¼šç»§æ‰¿è‡³Themeï¼Œ/values-v11.xmlå’Œ/values-v14.xmlæœ€ç»ˆä¼šç»§æ‰¿è‡³Theme.Holoï¼Œè€Œ/values-v21.xmlä¼šç»§æ‰¿è‡³Theme.Materialã€‚æ‰€ä»¥è¯´ï¼Œä¸€èˆ¬æˆ‘ä»¬é€‰æ‹©ä¸»é¢˜é€‰æ‹©ç»§æ‰¿è‡³AppCompatç³»åˆ—çš„ä¸»é¢˜å°±å¯ä»¥äº†(è‡³å°‘ç°åœ¨æ˜¯å¦‚æ­¤)ï¼ŒAppCompatå·²ç»åšå¥½é€‚é…å·¥ä½œäº†ã€‚ 2.2 å®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢?æ®æˆ‘æ‰€å¯¹æ¯”è§‚å¯Ÿï¼Œå®ƒä»¬çš„å‚æ•°åŸºæœ¬ä¸Šç›¸åŒï¼š Theme diff åŒæ–¹æœ‰äº›ç»†å¾®çš„å¢ç¼ºï¼Œåªæœ‰å€¼å¤§ä¸ä¸€æ ·ï¼Œä½†è¿™å¹¶ä¸å½±å“ä»€ä¹ˆï¼Œæˆ‘ä»¬å¿…è¦çš„æ—¶å€™ç›´æ¥å»æ‰€å…³å¿ƒçš„Themeé‚£é‡Œäº†è§£ä¸€ä¸‹ç›®æ ‡å‚æ•°ã€‚ä¸€ä¸ªä¸»é¢˜è§„èŒƒä¸¥æ ¼çš„appï¼Œé£æ ¼çš„å®šä¹‰åº”è¯¥åœ¨App Themeä¸Šå°±å¾—åˆ°äº†ç»Ÿä¸€ï¼Œè¿™äº›æ ¹ä¸»é¢˜çš„å‚æ•°ç»™äº†æˆ‘ä»¬ä¿®æ”¹ï¼Œå‚è€ƒçš„ä¾æ®ï¼Œäº†è§£è¿™äº›å‚æ•°æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ 2.3 åªæœ‰è¿™äº›æ ¹ä¸»é¢˜å—?å½“ç„¶ï¼ŒAndroidç³»ç»Ÿå¦‚æ­¤åºæ‚ï¼Œè¿œè¿œä¸æ­¢è¿™äº›æ ¹ä¸»é¢˜ï¼Œä¸Šè¿°3ä¸ªæ ¹ä¸»é¢˜æ‰€åœ¨çš„xmlæ–‡ä»¶é‡Œå®šä¹‰äº†å¾ˆå¤šæ ¹ä¸»é¢˜ï¼Œé€‚å½“äº†è§£ä¸€ä¸‹ä¼šæœ‰å¥½å¤„ã€‚ 2.4 å¦‚æ­¤å¤šçš„å­ä¸»é¢˜ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•æŠ‰æ‹©ï¼Ÿçœ‹çœ‹å®ƒçš„ç»§æ‰¿ç»“æ„ã€‚æˆ‘å…ˆè´´ä¸Šä¸€å¼ è‡ªå·±æ€»ç»“çš„å›¾ï¼š theme construction æˆ‘ä»¥AppCompatç³»åˆ—çš„ä¸»é¢˜ä¸ºä¾‹ï¼Œå›¾ä¸­å¹¶æ²¡æœ‰å°†æ‰€æœ‰ä¸»é¢˜éƒ½æ”¶æ‹¢è¿›å»ï¼Œæ¯•ç«Ÿå¤ªå¤šäº†ã€‚å›¾ä¸­æèŠ‚ç‚¹çš„ä¾æ®æ˜¯è¿™æ ·å­ï¼šä¾‹å¦‚Base.TextAppearance.AppCompat.Widget.Actionbar.Subtitle.Inverseè¿™ä¸ªstyleï¼Œå·².ä¸ºåˆ†å‰²çº¿ï¼ŒBaseã€TextAppearanceâ€¦ä¸ºèŠ‚ç‚¹ä½œæˆçš„ç»“æ„å›¾ã€‚ä»å›¾ä¸­å¯ä»¥å¾ˆç›´è§‚çš„å¾—å‡ºç»“è®ºï¼šä¸»é¢˜åˆ†ä¸ºTextAppearanceã€Themeã€ThemeOverlayå’ŒWidget4ç§ã€‚ TextAppeareance: å®šä¹‰å­—ä½“æ ·å¼ã€‚ Theme: å®šä¹‰Dialogå’ŒApplicationçš„æ ·å¼ã€‚ ThemeOverlay: å®šä¹‰æ‚¬æµ®å±‚çš„æ ·å¼ï¼Œä¾‹å¦‚ç‚¹å‡»ActionBarä¸Šçš„æ›´å¤šæˆ–è€…ä¸‹æ‹‰èœå•å¼¹å‡ºçš„æ‚¬æµ®ç•Œé¢çš„æ ·å¼ã€‚ Widgetï¼šé¡¾åæ€ä¹‰ï¼Œå®šä¹‰Buttonä¹‹ç±»çš„ç»„ä»¶çš„æ ·å¼ã€‚ å¦‚æœä½ æƒ³ä½¿ç”¨æŸä¸ªå­—ä½“ä¸»é¢˜æˆ–è€…è‡ªå®šä¹‰ï¼Œä½ å¯ä»¥ä½¿ç”¨æˆ–è€…ç»§æ‰¿TextAppearanceç³»åˆ—ï¼š TextAppearance Theme åŒæ ·çš„Themeç³»åˆ—ï¼š Theme Theme ThemeOverlayç³»åˆ—ï¼š ThemeOverlay Theme Widgetç³»åˆ—ï¼š Widget Theme Androidçš„Styleå‘½åå·²ç»æå¤§çš„ä¾¿åˆ©æˆ‘ä»¬ä½¿ç”¨ï¼Œæˆ‘ä»¬å”¯ä¸€è¦åšçš„äº‹å°±æ˜¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚äº†è§£æŸä¸ªä¸»é¢˜çš„å‚æ•°å’Œå€¼ï¼Œå¹¶ä¸”åœ¨å¿…è¦çš„æ—¶å€™å¤å†™å®ƒã€‚ 3 è‡ªå®šä¹‰æ ·å¼ç°åœ¨ç”¨å®é™…è¡ŒåŠ¨æ¥éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³ã€‚æˆ‘æ–°å»ºäº†ä¸€ä¸ªActivityï¼Œå®ƒæ˜¯è¿™æ ·å­ï¼š origin Activityä»£ç ï¼š 1234567891011121314151617181920212223242526272829public class ActionBarActivity extends AppCompatActivity &#123; @Bind(R.id.toolbar) Toolbar mToolbar; @Override protected void onCreate(@Nullable Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); setContentView(R.layout.activity_action_bar); ButterKnife.bind(this); mToolbar.setTitle(\"Thanatosx\"); mToolbar.setSubtitle(\"Widgets\"); setSupportActionBar(mToolbar); ActionBar mActionBar = getSupportActionBar(); if (mActionBar != null)&#123; mActionBar.setDisplayHomeAsUpEnabled(true); mActionBar.setHomeButtonEnabled(false); &#125; &#125; @Override public boolean onCreateOptionsMenu(Menu menu) &#123; getMenuInflater().inflate(R.menu.menus, menu); return super.onCreateOptionsMenu(menu); &#125;&#125; Layoutå¸ƒå±€æ–‡ä»¶ï¼š 1234567891011121314&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;&lt;LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\" android:orientation=\"vertical\" android:background=\"#80123456\" android:layout_width=\"match_parent\" android:layout_height=\"match_parent\"&gt; &lt;android.support.v7.widget.Toolbar android:id=\"@+id/toolbar\" android:layout_width=\"match_parent\" android:layout_height=\"wrap_content\"/&gt;&lt;/LinearLayout&gt; ä»¥åŠThemeä¸»é¢˜ï¼š 1234567&lt;style name=\"AppTheme\" parent=\"Theme.AppCompat.Light\"&gt; &lt;!-- Customize your theme here. --&gt; &lt;item name=\"windowActionBar\"&gt;false&lt;/item&gt; &lt;item name=\"windowNoTitle\"&gt;true&lt;/item&gt; &lt;item name=\"colorPrimary\"&gt;@color/colorPrimary&lt;/item&gt; &lt;item name=\"colorPrimaryDark\"&gt;@color/colorPrimaryDark&lt;/item&gt;&lt;/style&gt; ç°åœ¨æˆ‘ä»¬æƒ³è¦é€šè¿‡ä¿®æ”¹Themeæ¥æ”¹å˜Toolbarçš„æ ·å¼è¾¾åˆ°ä»¥ä¸‹æ•ˆæœï¼š æ”¹å˜è¿”å›å›¾æ ‡ æ”¹å˜Titleå’ŒSubtitleçš„å­—ä½“å¤§å°å’Œé¢œè‰² æ”¹å˜more iconçš„é¢œè‰² é¦–å…ˆï¼Œç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå»å“ªé‡Œä¿®æ”¹ï¼Ÿå‰é¢è¯´åˆ°ï¼ŒThemeä¸»é¢˜åŸºæœ¬å¯ä»¥å®šä¹‰ä¸€ä¸ªApplicationçš„å¤§éƒ¨åˆ†åœ°æ–¹çš„æ ·å¼ï¼Œæˆ‘ä»¬éœ€è¦å»æœç´¢ä¸€ä¸‹çˆ¶ä¸»é¢˜æ˜¯å¦æœ‰è¿™æ ·çš„å®šä¹‰ï¼Œä»Theme.AppCompat.Lightè¿™ä¸ªä¸»é¢˜å¼€å§‹å¾€ä¸Šè¿½æº¯ï¼Œåœ¨Base.Theme.AppCompat.Lightä¸Šä¼šæœ‰ä¸ªç‰ˆæœ¬é€‰æ‹©ï¼š show version list è¿™ä¸ªæ— æ‰€è°“ï¼Œé€‰æ‹©ä½ç‰ˆæœ¬çš„å°±å¯ä»¥äº†ï¼Œä½ç‰ˆæœ¬éƒ½æ”¯æŒçš„è¯å°±ä¸ç”¨æ‹…å¿ƒé«˜ç‰ˆæœ¬ï¼Œé¦–å…ˆä¼šåœ¨Base.v7.Theme.AppCompat.Lightä¸Šå‘ç°Toolbar Styleçš„å®šä¹‰ï¼š found out toolbar style é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤å†™è¿™ä¸ªå±æ€§ï¼Œè‡ªå®šä¹‰æˆ‘ä»¬çš„Toolbar Styleäº†ï¼ŒåŒæ ·çš„ï¼Œæœ‰ä¸ªactionOverflowButtonStyleå±æ€§ï¼Œå®ƒå°±æ˜¯å®šä¹‰more icon buttonçš„å±æ€§äº†ã€‚ ä¿®æ”¹åçš„Themeï¼š 12345678910111213141516171819202122232425262728293031&lt;style name=\"AppTheme\" parent=\"Theme.AppCompat.Light\"&gt; &lt;!-- Customize your theme here. --&gt; &lt;item name=\"windowActionBar\"&gt;false&lt;/item&gt; &lt;item name=\"windowNoTitle\"&gt;true&lt;/item&gt; &lt;item name=\"colorPrimary\"&gt;@color/colorPrimary&lt;/item&gt; &lt;item name=\"colorPrimaryDark\"&gt;@color/colorPrimaryDark&lt;/item&gt; &lt;item name=\"actionOverflowButtonStyle\"&gt;@style/AppWidget.ActionButton.Overflow&lt;/item&gt; &lt;item name=\"toolbarStyle\"&gt;@style/AppTheme.Toolbar&lt;/item&gt;&lt;/style&gt;&lt;style name=\"AppTheme.Toolbar\" parent=\"Widget.AppCompat.Toolbar\"&gt; &lt;item name=\"android:minHeight\"&gt;50dp&lt;/item&gt; &lt;item name=\"titleTextAppearance\"&gt;@style/AppTextAppearance.Widget.Actionbar.Title&lt;/item&gt; &lt;item name=\"subtitleTextAppearance\"&gt;@style/AppTextAppearance.Widget.Actionbar.Subtitle&lt;/item&gt; &lt;item name=\"navigationIcon\"&gt;@mipmap/ic_back&lt;/item&gt; &lt;item name=\"android:background\"&gt;?attr/colorPrimary&lt;/item&gt;&lt;/style&gt;&lt;style name=\"AppTextAppearance.Widget.Actionbar.Title\" parent=\"TextAppearance.Widget.AppCompat.Toolbar.Title\"&gt; &lt;item name=\"android:textSize\"&gt;14sp&lt;/item&gt; &lt;item name=\"android:textColor\"&gt;#FFF&lt;/item&gt;&lt;/style&gt;&lt;style name=\"AppTextAppearance.Widget.Actionbar.Subtitle\" parent=\"TextAppearance.Widget.AppCompat.Toolbar.Subtitle\"&gt; &lt;item name=\"android:textSize\"&gt;12sp&lt;/item&gt; &lt;item name=\"android:textColor\"&gt;#FFF&lt;/item&gt;&lt;/style&gt;&lt;style name=\"AppWidget.ActionButton.Overflow\" parent=\"Widget.AppCompat.ActionButton.Overflow\"&gt; &lt;item name=\"android:src\"&gt;@mipmap/ic_more&lt;/item&gt;&lt;/style&gt; parentç»§æ‰¿è‡³åŸä½¿ç”¨çš„Style Themeï¼Œä»¥æ­¤åŸºç¡€ä¸Šé‡å†™è‡ªå·±éœ€è¦ä¿®æ”¹çš„å±æ€§ï¼Œæœ€ç»ˆæ•ˆæœå›¾ï¼š 4 å‘åœ¨ä¿®æ”¹Activityçš„è¿”å›æŒ‰é’®çš„æ—¶å€™æˆ‘åœ¨AppThemeé‡Œæ‰¾åˆ°è¿™ä¸ªå±æ€§ï¼šhomeAsUpIndicatorï¼Œè€å¸æœºä»¬è‚¯å®šæ˜ç™½ï¼Œè¿™å°±æ˜¯è®¾ç½®è¿”å›æŒ‰é’®çš„å›¾æ ‡ï¼Œä½†æ˜¯æ— è®ºæˆ‘å¦‚ä½•è®¾ç½®ï¼Œä¿®æ”¹ï¼Œè¿™ä¸ªå±æ€§æ²¡æœ‰ä»»ä½•æ•ˆæœï¼ï¼æ— å¥ˆä¹‹ä¸‹ï¼Œæˆ‘å»overflowstackä¸Šå¯»æ‰¾ç­”æ¡ˆï¼Œä¼—è¯´çº·çº­ï¼Œå€’æ˜¯çœ‹åˆ°è¿™ä¸ªå±æ€§navigationIconï¼Œæˆ‘åœ¨Themeä¸Šæ²¡çœ‹åˆ°ï¼Œåœ¨Toolbarçš„ä¸»é¢˜ä¸Šä¹Ÿæ²¡æœ‰çœ‹åˆ°ï¼Œä½†æ˜¯å½“æˆ‘è¿›å…¥Toolbarçš„æºç ï¼Œæˆ‘å‘ç°æ˜¯æœ‰è¿™ä¸ªå±æ€§çš„ï¼š æˆ‘ç›´æ¥è·‘å»R.javaæ–‡ä»¶å»çœ‹ï¼Œä¸€ç›®äº†ç„¶ï¼š r.java æºç ä¹‹ä¸‹ï¼Œæ²¡æœ‰ç§˜å¯† è¿˜æœ‰ä¸€ç‚¹ï¼Œè®¾ç½®navigationIconä¹‹åï¼Œç‚¹å‡»è¿”å›æŒ‰é’®æ²¡æœ‰ä»»ä½•å“åº”äº†ï¼Œéœ€è¦è®¾ç½®Navigation Click Listener 1234567// after set support action barmToolbar.setNavigationOnClickListener(new View.OnClickListener() &#123; @Override public void onClick(View v) &#123; finish(); &#125;&#125;);","categories":[{"name":"Android","slug":"Android","permalink":"https://dylantseng1915.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://dylantseng1915.github.io/tags/Android/"},{"name":"Theme","slug":"Theme","permalink":"https://dylantseng1915.github.io/tags/Theme/"}]},{"title":"FragmentPagerAdapterä¸FragmentStatePagerAdapterçš„å·®å¼‚","slug":"FragmentPagerAdapterä¸FragmentStatePagerAdapterçš„å·®å¼‚","date":"2017-01-12T07:23:55.000Z","updated":"2021-02-14T14:01:43.638Z","comments":true,"path":"2017/01/12/cklcih3ik0006kyz1f8qb3pat/","link":"","permalink":"https://dylantseng1915.github.io/2017/01/12/cklcih3ik0006kyz1f8qb3pat/","excerpt":"","text":"1ã€æ¦‚è¿°PagerAdapteræ˜¯æä¾›è®¡ç®—ViewPagerå†…çš„Pagesçš„é€‚é…å™¨ï¼Œè€ŒFragmentPagerAdapterä¸FragmentStatePagerAdapteréƒ½æ˜¯ç»§æ‰¿è‡³PagerAdapterè¿™ä¸ªåŸºç±»ï¼Œæ˜¯PagerAdapterçš„ä¸¤ä¸ªç‰¹æ®Šå®ç°ã€‚å¯èƒ½æœ‰äº›äººä¼šæ–­ç« å–ä¹‰çš„è®¤ä¸ºFragmentPagerAdapterä¸ä¼šä¿å­˜Fragmentçš„çŠ¶æ€ï¼Œè€ŒFragmentStatePagerAdapterä¼šç»´æŒFragmentçš„çŠ¶æ€ã€‚äº‹å®ä¸Šï¼Œè¿™æ˜¯ä¸€ç§é”™è¯¯çš„ç†è§£ï¼Œè™½ç„¶ä½ åœ¨ä½¿ç”¨æ—¶å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ã€‚FragmentPagerAdapterä¸FragmentStatePagerAdapterçš„å®ç°è·Ÿå®ƒä»¬æ‰€è¦æœåŠ¡çš„åœºæ™¯æœ‰å¯†åˆ‡çš„å…³ç³»ï¼Œæˆ‘ä»¬é€šè¿‡ç†è§£äºŒè€…çš„æºç æ¥äº†è§£è®¾è®¡è€…çš„è®¾è®¡ç›®çš„ã€‚ 2ã€FragmentPagerAdapteré¦–å…ˆå…ˆè´´ä¸Šæºä»£ç ï¼Œä»£ç é‡ä¸æ˜¯å¾ˆå¤š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118public abstract class FragmentPagerAdapter extends PagerAdapter &#123; private static final String TAG = \"FragmentPagerAdapter\"; private static final boolean DEBUG = false; private final FragmentManager mFragmentManager; private FragmentTransaction mCurTransaction = null; private Fragment mCurrentPrimaryItem = null; public FragmentPagerAdapter(FragmentManager fm) &#123; mFragmentManager = fm; &#125; /** * Return the Fragment associated with a specified position. */ public abstract Fragment getItem(int position); @Override public void startUpdate(ViewGroup container) &#123; if (container.getId() == View.NO_ID) &#123; throw new IllegalStateException(\"ViewPager with adapter \" + this + \" requires a view id\"); &#125; &#125; @Override public Object instantiateItem(ViewGroup container, int position) &#123; if (mCurTransaction == null) &#123; mCurTransaction = mFragmentManager.beginTransaction(); &#125; final long itemId = getItemId(position); // Do we already have this fragment? String name = makeFragmentName(container.getId(), itemId); Fragment fragment = mFragmentManager.findFragmentByTag(name); if (fragment != null) &#123; if (DEBUG) Log.v(TAG, \"Attaching item #\" + itemId + \": f=\" + fragment); mCurTransaction.attach(fragment); &#125; else &#123; fragment = getItem(position); if (DEBUG) Log.v(TAG, \"Adding item #\" + itemId + \": f=\" + fragment); mCurTransaction.add(container.getId(), fragment, makeFragmentName(container.getId(), itemId)); &#125; if (fragment != mCurrentPrimaryItem) &#123; fragment.setMenuVisibility(false); fragment.setUserVisibleHint(false); &#125; return fragment; &#125; @Override public void destroyItem(ViewGroup container, int position, Object object) &#123; if (mCurTransaction == null) &#123; mCurTransaction = mFragmentManager.beginTransaction(); &#125; if (DEBUG) Log.v(TAG, \"Detaching item #\" + getItemId(position) + \": f=\" + object + \" v=\" + ((Fragment)object).getView()); mCurTransaction.detach((Fragment)object); &#125; @Override public void setPrimaryItem(ViewGroup container, int position, Object object) &#123; Fragment fragment = (Fragment)object; if (fragment != mCurrentPrimaryItem) &#123; if (mCurrentPrimaryItem != null) &#123; mCurrentPrimaryItem.setMenuVisibility(false); mCurrentPrimaryItem.setUserVisibleHint(false); &#125; if (fragment != null) &#123; fragment.setMenuVisibility(true); fragment.setUserVisibleHint(true); &#125; mCurrentPrimaryItem = fragment; &#125; &#125; @Override public void finishUpdate(ViewGroup container) &#123; if (mCurTransaction != null) &#123; mCurTransaction.commitNowAllowingStateLoss(); mCurTransaction = null; &#125; &#125; @Override public boolean isViewFromObject(View view, Object object) &#123; return ((Fragment)object).getView() == view; &#125; @Override public Parcelable saveState() &#123; return null; &#125; @Override public void restoreState(Parcelable state, ClassLoader loader) &#123; &#125; /** * Return a unique identifier for the item at the given position. * * &lt;p&gt;The default implementation returns the given position. * Subclasses should override this method if the positions of items can change.&lt;/p&gt; * * @param position Position within this adapter * @return Unique identifier for the item at position */ public long getItemId(int position) &#123; return position; &#125; private static String makeFragmentName(int viewId, long id) &#123; return \"android:switcher:\" + viewId + \":\" + id; &#125;&#125; æˆ‘ä»¬æŠŠç›®å…‰èšç„¦åˆ°è¿™å‡ ä¸ªä¸»è¦çš„æ–¹æ³•ï¼š public Object instantiateItem(ViewGroup container, int position) public void destroyItem(ViewGroup container, int position, Object object) public void finishUpdate(ViewGroup container) public Parcelable saveState() public void restoreState(Parcelable state, ClassLoader loader) æ–¹æ³•saveStateå’ŒrestoreStateå¹¶æ²¡æœ‰å¹²ä»€ä¹ˆäº‹æƒ…ï¼Œä½†æ˜¯åœ¨FragmentStatePagerAdapterä¸­å°±å¤§ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ç°åœ¨å…ˆæ³¨æ„è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚finishUpdateå½“å·²æ˜¾ç¤ºçš„pageså®Œæˆæ”¹å˜åè°ƒç”¨ï¼Œä¸€èˆ¬åœ¨è¿™ä¸ªæ–¹æ³•å†…commit FragmentTransactionçš„æ“ä½œã€‚æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹instantiateItemæ–¹æ³•çš„æºä»£ç ï¼Œå®ƒæ˜¯ç”¨æ¥å®ä¾‹åŒ–æŸä¸ªitemçš„ï¼š 123456789101112131415161718192021222324252627 @Overridepublic Object instantiateItem(ViewGroup container, int position) &#123; if (mCurTransaction == null) &#123; mCurTransaction = mFragmentManager.beginTransaction(); &#125; final long itemId = getItemId(position); // Do we already have this fragment? String name = makeFragmentName(container.getId(), itemId); Fragment fragment = mFragmentManager.findFragmentByTag(name); if (fragment != null) &#123; if (DEBUG) Log.v(TAG, \"Attaching item #\" + itemId + \": f=\" + fragment); mCurTransaction.attach(fragment); &#125; else &#123; fragment = getItem(position); if (DEBUG) Log.v(TAG, \"Adding item #\" + itemId + \": f=\" + fragment); mCurTransaction.add(container.getId(), fragment, makeFragmentName(container.getId(), itemId)); &#125; if (fragment != mCurrentPrimaryItem) &#123; fragment.setMenuVisibility(false); fragment.setUserVisibleHint(false); &#125; return fragment;&#125; è¿™ä¸ªæ–¹æ³•é¦–å…ˆè·å¾—ä¸€ä¸ªitemIdï¼ˆå®é™…ä¸Šè¿”å›æ—¶çš„positionæœ¬èº«ï¼‰ï¼Œç„¶åä½œä¸ºå‚æ•°ä¼ å…¥makeFragmentNameæ–¹æ³•ç”Ÿæˆä¸€ä¸ªnameï¼Œç„¶åä½¿ç”¨è¿™ä¸ªnameåœ¨FragmentManagerå†…æœç´¢å‡ºFragmentï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œè¯´æ˜ä»¥å‰åŠ å…¥è¿‡ï¼Œé‚£ä¹ˆé‡æ–°attachè¿™ä¸ªFragmentï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆä½¿ç”¨getItemåˆ›å»ºä¸€ä¸ªï¼ŒgetItemå°±æ˜¯éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°çš„æŠ½è±¡æ–¹æ³•ä¹‹ä¸€ï¼Œæœ€åå°†æ–°åˆ›å»ºçš„Fragment addè¿›å»ã€‚ æ—¢ç„¶FragmentPagerAdapterå®ä¾‹åŒ–itemå¾—æ–¹å¼æ˜¯é€šè¿‡addæˆ–è€…attachï¼Œé‚£ä¹ˆï¼Œæ˜¾è€Œæ˜“è§ï¼Œåœ¨destroyItemå†…å¿…å®šæ˜¯ä½¿ç”¨detachæ¥â€˜å¸è½½â€™itemï¼š 123456789 @Overridepublic void destroyItem(ViewGroup container, int position, Object object) &#123; if (mCurTransaction == null) &#123; mCurTransaction = mFragmentManager.beginTransaction(); &#125; if (DEBUG) Log.v(TAG, \"Detaching item #\" + getItemId(position) + \": f=\" + object + \" v=\" + ((Fragment)object).getView()); mCurTransaction.detach((Fragment)object);&#125; æœç„¶ï¼Œå¾ˆç®€å•çš„æ“ä½œï¼Œä½¿ç”¨FragmentTransaction attachäº†éœ€è¦é”€æ¯çš„Fragmentã€‚ FragmentPagerAdapteræ•´ä¸ªæµç¨‹å¾ˆç®€å•ï¼Œå°±æ˜¯ add -&gt; detach -&gt; attach -&gt; detach -&gt; â€¦å› ä¸ºèµ°çš„æ˜¯detachå’Œattachçš„è·¯ï¼Œæ‰€ä»¥ç³»ç»Ÿä¼šä¿å­˜Fragmentçš„Stateã€‚FragmentPagerAdapteræ˜¯å¾ˆæ™®é€šçš„ä¸€ä¸ªPagerAdapterçš„å®ç°ç±»ï¼Œé€‚ç”¨äºåŸºæœ¬çš„ä½¿ç”¨åœºæ™¯ï¼Œä½†æ˜¯å¦‚æœæ˜¯æœ‰å¤§é‡çš„Tabçš„ä½¿ç”¨åœºæ™¯ï¼ŒFragmentPagerAdapterå°±ä¸å¤ªé€‚ç”¨äº†ï¼Œå› ä¸ºå®ƒçš„çŠ¶æ€éƒ½ç”¨ç³»ç»Ÿä¿å­˜å¸¸é©»åœ¨å†…å­˜ä¹‹ä¸­äº†ï¼Œå¹¶ä¸”Fragmentçš„å®ä¾‹ä¹Ÿå¸¸é©»åœ¨å†…å­˜ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´å¤§é‡çš„å†…å­˜å ç”¨ã€‚ FragmentStatePagerAdapterå°±è§£å†³FragmentPagerAdapterçŸ­æ¿çš„é—®é¢˜ã€‚ 3ã€FragmentStatePagerAdapterFragmentStatePagerAdapterç›¸å¯¹FragmentPagerAdapterå¤šäº†ä¸¤ä¸ªå˜é‡ï¼š 12private ArrayList&lt;Fragment.SavedState&gt; mSavedState = new ArrayList&lt;Fragment.SavedState&gt;();private ArrayList&lt;Fragment&gt; mFragments = new ArrayList&lt;Fragment&gt;(); æ„å›¾å¾ˆæ˜æ˜¾äº†ï¼ŒmFragmentsç”¨æ¥ä¿å­˜Fragmentçš„å®ä¾‹ï¼ŒmSavedStateç”¨æ¥ä¿å­˜æ¯ä¸ªFragmentçš„çŠ¶æ€ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹instantiateItemå’ŒdestroyItemè¿™ä¸¤ä¸ªæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435@Overridepublic Object instantiateItem(ViewGroup container, int position) &#123; // If we already have this item instantiated, there is nothing // to do. This can happen when we are restoring the entire pager // from its saved state, where the fragment manager has already // taken care of restoring the fragments we previously had instantiated. if (mFragments.size() &gt; position) &#123; Fragment f = mFragments.get(position); if (f != null) &#123; return f; &#125; &#125; if (mCurTransaction == null) &#123; mCurTransaction = mFragmentManager.beginTransaction(); &#125; Fragment fragment = getItem(position); if (DEBUG) Log.v(TAG, \"Adding item #\" + position + \": f=\" + fragment); if (mSavedState.size() &gt; position) &#123; Fragment.SavedState fss = mSavedState.get(position); if (fss != null) &#123; fragment.setInitialSavedState(fss); &#125; &#125; while (mFragments.size() &lt;= position) &#123; mFragments.add(null); &#125; fragment.setMenuVisibility(false); fragment.setUserVisibleHint(false); mFragments.set(position, fragment); mCurTransaction.add(container.getId(), fragment); return fragment;&#125; FragmentStatePagerAdapteré¦–å…ˆä¼šåœ¨mFragmentsé›†åˆå†…å¯»æ‰¾å¯¹åº”positionçš„Fragmentï¼Œå¦‚æœpositionå¤§äºè¯¥é›†åˆçš„sizeï¼Œè¯´æ˜è¯¥positionä¸‹çš„Fragmentä»æœªè¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡ŒgetItemåˆ›å»ºæ–°çš„å®ä¾‹ã€‚å¦‚æœpositionåœ¨mSavedStateé›†åˆèŒƒå›´å†…ï¼Œè¯´æ˜æ”¹Fragmentæ›¾ç»è®¿é—®è¿‡ï¼Œå¹¶ä¸”æœ‰å®ƒä»¥å‰çš„çŠ¶æ€ï¼Œé‚£ä¹ˆï¼Œè¿˜åŸè¿™ä¸ªçŠ¶æ€ã€‚æœ€ååŠ å…¥FragmentManagerä¹‹ä¸­ã€‚å†æ¥çœ‹çœ‹destroyItemæ–¹æ³•ï¼š 123456789101112131415161718@Overridepublic void destroyItem(ViewGroup container, int position, Object object) &#123; Fragment fragment = (Fragment) object; if (mCurTransaction == null) &#123; mCurTransaction = mFragmentManager.beginTransaction(); &#125; if (DEBUG) Log.v(TAG, \"Removing item #\" + position + \": f=\" + object + \" v=\" + ((Fragment)object).getView()); while (mSavedState.size() &lt;= position) &#123; mSavedState.add(null); &#125; mSavedState.set(position, fragment.isAdded() ? mFragmentManager.saveFragmentInstanceState(fragment) : null); mFragments.set(position, null); mCurTransaction.remove(fragment);&#125; ä¸åŒäºFragmentPagerAdapterï¼ŒFragmentStatePagerAdapteræ˜¯é‡‡ç”¨removeçš„æ–¹å¼é”€æ¯Fragmentï¼Œä½†å®é™…ä¸Šï¼Œæ´»åŠ¨çš„Fragmentå®ä¾‹ä¿å­˜åœ¨mFragmentsä¹‹ä¸­ï¼Œåœ¨destroyItemæ–¹æ³•å†…åˆä¼šè¢«ç§»é™¤ï¼Œä½†æ˜¯çŠ¶æ€ä¸ä¼šè¢«åˆ é™¤ï¼Œæ€»æ˜¯ä¿å­˜åœ¨mSavedStateé›†åˆä¹‹ä¸­ã€‚æ‰€ä»¥ï¼ŒFragmentStatePagerAdapterçš„æœºåˆ¶æ˜¯: add -&gt; save state -&gt; remove -&gt; initial state -&gt; add -&gt; â€¦ è¿™é‡Œæœ‰ä¹Ÿæš´éœ²äº†FragmentStatePagerAdapterä¸¤ä¸ªè‡´å‘½çš„é—®é¢˜ï¼šä¸€æ˜¯çŠ¶æ€ä¸ä¼šè¢«åˆ é™¤ï¼Œæ€»æ˜¯ä¿å­˜åœ¨mSavedStateé›†åˆä¸­ï¼Œå¦‚æœä¸€ä¸ªViewPageråƒç½‘æ˜“æ–°é—»é‚£æ ·æœ‰å‡ åä¸ªTabï¼ŒåŠ¿å¿…ä¼šé€ æˆå†…å­˜å‹åŠ›ã€‚äºŒæ˜¯ä¸èƒ½åšç§»é™¤Tabçš„å·¥ä½œï¼Œå³ä½¿ä½ ç§»é™¤çš„æŸä¸ªTabä»¥åŠç›¸å…³çš„Fragmentï¼ŒçŠ¶æ€ä¾ç„¶æ²¡æœ‰åˆ é™¤ï¼Œæˆ‘ä»¬åˆä¸èƒ½åˆ é™¤ï¼Œæ²¡æœ‰ç›¸å…³çš„APIï¼ŒåŒæ—¶ï¼Œä¾‹å¦‚ä½ åˆ é™¤äº†positionä¸º2çš„Fragment,åŸæœ¬positionä¸º3çš„Fragmentå°±ä¼šä½¿ç”¨positionä¸º2çš„Fragmentçš„çŠ¶æ€ã€‚è¿™æ˜¯å¾ˆè‡´å‘½çš„é—®é¢˜ã€‚ 4ã€åŒºåˆ«åœ¨å“ªï¼ŸFragmentPagerAdapterå’ŒFragmentStatePagerAdapterçš„æœºåˆ¶å†³å®šäº†å®ƒä»¬çš„åŒºåˆ«ã€‚FragmentPagerAdapterä½¿ç”¨add, attach, detachæ¥ç®¡ç†Fragmentï¼ŒFragmentå®ä¾‹å’ŒçŠ¶æ€éƒ½è¢«ä¿å­˜ä¸‹æ¥ï¼Œä½†æ˜¯é‡å»ºçš„æ¶ˆè€—ä¸é«˜ï¼Œç”Ÿå‘½å‘¨æœŸåœ¨onAttachå’ŒonDetaché—´æ¸¸èµ°ï¼Œå…¸å‹çš„ç”¨å†…å­˜æ¢æ•ˆç‡çš„åšæ³•ã€‚è€ŒFragmentStatePagerAdapterä½¿ç”¨add, removeæ¥ç®¡ç†Fragmentï¼Œè¢«é”€æ¯çš„Fragmentå®ä¾‹ä¸å†å­˜åœ¨ï¼Œä½†æ˜¯å…¶çŠ¶æ€ä¿å­˜åœ¨é›†åˆä¹‹ä¸­ï¼Œä»¥ä¾¿ä¸‹æ¬¡é‡æ–°åˆ›å»ºå®ä¾‹æ—¶èƒ½å¤Ÿè¿˜åŸä¹‹å‰çš„çŠ¶æ€ã€‚","categories":[{"name":"Android","slug":"Android","permalink":"https://dylantseng1915.github.io/categories/Android/"}],"tags":[{"name":"Android","slug":"Android","permalink":"https://dylantseng1915.github.io/tags/Android/"},{"name":"ViewPager","slug":"ViewPager","permalink":"https://dylantseng1915.github.io/tags/ViewPager/"},{"name":"Adapter","slug":"Adapter","permalink":"https://dylantseng1915.github.io/tags/Adapter/"}]},{"title":"åŸºæœ¬æ’åº(Cè¯­è¨€ç‰ˆ)","slug":"åŸºæœ¬æ’åº(Cè¯­è¨€ç‰ˆ)","date":"2017-01-12T06:47:03.000Z","updated":"2021-02-14T14:01:43.639Z","comments":true,"path":"2017/01/12/cklcih3ie0002kyz15swsgw7l/","link":"","permalink":"https://dylantseng1915.github.io/2017/01/12/cklcih3ie0002kyz15swsgw7l/","excerpt":"","text":"å†’æ³¡æ’åº12345678910111213141516/*** å†’æ³¡æ’åº logN^2* åŸºæœ¬æ€è·¯ï¼šæ¯æ¬¡ä»æ•°ç»„åº•ç«¯å°†æœ€å°çš„æ•°â€œå†’â€ä¸Šæ¥* **/void BubbleSort(int *p, int len)&#123; for(int i=0; i&lt;len-1; i++)&#123; for(int j=len-1; j&gt;i; j--)&#123; if(*(p+j)&lt;*(p+j-1))&#123; *(p+j) ^= *(p+j-1); *(p+j-1) ^= *(p+j); *(p+j) ^= *(p+j-1); &#125; &#125; &#125;&#125; é€‰æ‹©æ’åº12345678910111213141516/*** é€‰æ‹©æ’åº logN^2**/void SelectSort(int *p, int len)&#123; for(int i=0; i&lt;len-1; i++)&#123; int min = i; for(int j=len-1; j&gt;i; j--)&#123; if(*(p+j)&lt;*(p+min)) min = j; &#125; if(min != i)&#123; *(p+i) ^= *(p+min); *(p+min) ^= *(p+i); *(p+i) ^= *(p+min); &#125; &#125;&#125; æ’å…¥æ’åº1234567891011121314/*** æ’å…¥æ’åº logN^2**/void InsertSort(int *p, int len)&#123; for(int i=0; i&lt;len-1; i++)&#123; for(int j=i+1; j&gt;0; j--)&#123; if(*(p+j)&lt;*(p+j-1))&#123; *(p+j) ^= *(p+j-1); *(p+j-1) ^= *(p+j); *(p+j) ^= *(p+j-1); &#125;else break; &#125; &#125; &#125; å¸Œå°”æ’åº1234567891011121314151617181920/*** å¸Œå°”æ’åº N^1.5* åŸºæœ¬æ€è·¯ï¼šé€‰å–æŸä¸ªå¢é‡ï¼Œå°†æ•°ç»„åˆ†ä¸ºè‹¥å¹²çš„å­åºåˆ—ï¼Œå¯¹å­åºåˆ—è¿›è¡Œæ’å…¥æ’åºï¼Œ* é€æ¸å‡å°å¢é‡ï¼Œé‡å¤ä¸Šè¿°æ“ä½œï¼Œç›´åˆ°å¢é‡ä¸º1ï¼Œæ­¤æ—¶æ•°ç»„åŸºæœ¬æœ‰åºï¼Œæœ€åè¿›è¡Œä¸€æ¬¡æ’å…¥æ’åºã€‚**/void ShellSort(int *p, int len)&#123; for(int incre=len/2; incre&gt;=1; incre--)&#123; for(int i=0; i&lt;incre; i++)&#123; for(int j=i+incre; j&lt;len; j+=incre)&#123; for(int k=j; k&gt;i; k-=incre)&#123; if(*(p+k)&lt;*(p+k-incre))&#123; *(p+k) ^= *(p+k-incre); *(p+k-incre) ^= *(p+k); *(p+k) ^= *(p+k-incre); &#125;else break; &#125; &#125; &#125; &#125;&#125; å¿«é€Ÿæ’åº123456789101112131415161718/*** å¿«é€Ÿæ’åº N*logN**/void QuickSort(int *p, int len)&#123; if(len&lt;=1) return; int *b = p; int *e = p + len - 1; int sentry = *p; while(b&lt;e)&#123; while(b&lt;e &amp;&amp; *e &gt;= sentry) e--; *b = *e; while(b&lt;e &amp;&amp; *b &lt;= sentry) b++; *e = *b; &#125; *b = sentry; QuickSort(p, b-p); QuickSort(b+1, len-(b-p)-1);&#125; å½’å¹¶æ’åº1234567891011121314151617181920212223242526272829/*** å½’å¹¶æ’åº N*logN* éœ€è¦é¢å¤–çš„ç©ºé—´å­˜æ”¾æ•°æ®* åŸºæœ¬æ€æƒ³ï¼šå°†ä¸€ä¸ªæ•°ç»„åˆ†æˆä¸¤ä»½ï¼Œå¦‚æœè¿™ä¸¤ä»½æ•°ç»„çš„æœ‰åºçš„ï¼Œé‚£ä¹ˆå°†è¿™ä¸¤ä»½æ•°ç»„å½’å¹¶ï¼Œ* å¯¹ä¸Šè¿°æ“ä½œè¿›è¡Œé€’å½’æ“ä½œï¼Œç›´åˆ°åˆ†æˆçš„æ•°ç»„ä»…ä»…åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆå®ƒç†æ‰€å½“ç„¶æ˜¯æœ‰åºçš„ã€‚**/void MergeArray(int *p, int len1, int *q, int len2)&#123; int temp[len1+len2]; int i,j,k; i = j = k = 0; while(i&lt;len1 &amp;&amp; j&lt;len2)&#123; if(*(p+i)&lt;*(q+j))&#123; temp[k++] = *(p+i++); &#125;else&#123; temp[k++] = *(q+j++); &#125; &#125; while(i&lt;len1) temp[k++] = *(p+i++); while(j&lt;len2) temp[k++] = *(q+j++); for(i=0; i&lt;len1+len2; i++) *(p+i) = temp[i];&#125;void MergeSort(int *p, int len)&#123; if(len&lt;=1) return; int middle = len/2; MergeSort(p, middle); MergeSort(p+middle, len-middle); MergeArray(p, middle, p+middle, len-middle);&#125; å †æ’åº1234567891011121314151617181920212223242526272829303132/*** å †æ’åº N * logN* len/2 -1 æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹* 2*i + 1 å·¦å­©å­èŠ‚ç‚¹* 2*i + 2 å³å­©å­èŠ‚ç‚¹* åŸºæœ¬æ€è·¯ï¼šå°†ä¸€ä¸ªæ•°ç»„çœ‹ä½œæ˜¯å®Œå…¨äºŒå‰æ ‘ï¼Œå…ˆè°ƒæ•´æ•´ä¸ªå †ï¼Œç„¶åå°†æ ¹èŠ‚ç‚¹å’Œ* æœ«èŠ‚ç‚¹äº’æ¢ï¼Œé‡æ–°è°ƒæ•´å †**/void HeapAdjust(int *p, int len, int i)&#123; int child = 2*i+1; if(child&gt;=len) return; if(child&lt;len-1 &amp;&amp; *(p+child)&lt;*(p+child+1)) child++; if(*(p+i)&lt;*(p+child))&#123; *(p+i) ^= *(p+child); *(p+child) ^= *(p+i); *(p+i) ^= *(p+child); HeapAdjust(p, len, child); &#125; &#125;void HeapSort(int *p, int len)&#123; //é¦–å…ˆå…ˆä»æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å¼€å§‹è°ƒæ•´å † for(int i=len/2-1; i&gt;=0; i--) HeapAdjust(p, len, i); for(int i=len-1; i&gt;0; i--)&#123; *p ^= *(p+i); *(p+i) ^= *p; *p ^= *(p+i); HeapAdjust(p, i, 0); // &lt;--not i+1 &#125; &#125;","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://dylantseng1915.github.io/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"æ’åº","slug":"æ’åº","permalink":"https://dylantseng1915.github.io/tags/%E6%8E%92%E5%BA%8F/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://dylantseng1915.github.io/tags/%E7%AE%97%E6%B3%95/"}]}]}